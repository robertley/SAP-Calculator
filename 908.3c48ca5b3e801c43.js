"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[908],{3908(Ve,te,S){S.d(te,{ImportCalculatorComponent:()=>Oe});var oe=S(467),O=S(9769),y=S(5119),ne=S(4421),D=S(1080);const ae=(()=>{function o(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return o.prototype=Object.create(Error.prototype),o})();var L=S(3004);class ie{constructor(e,t,a,n){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=a,this.scheduler=n}call(e,t){return t.subscribe(new $(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class $ extends L.gn{constructor(e,t,a,n,l){super(e),this.absoluteTimeout=t,this.waitFor=a,this.withObservable=n,this.scheduler=l,this.scheduleTimeout()}static dispatchTimeout(e){const{withObservable:t}=e;e._unsubscribeAndRecycle(),e.add((0,L.tS)(t,new L.zA(e)))}scheduleTimeout(){const{action:e}=this;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule($.dispatchTimeout,this.waitFor,this))}_next(e){this.absoluteTimeout||this.scheduleTimeout(),super._next(e)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}var j=S(7389);function ue({error:o,subscriber:e}){e.error(o)}function H(o,e=D.b){return function le(o,e,t=D.b){return a=>{let n=function re(o){return o instanceof Date&&!isNaN(+o)}(o),l=n?+o-t.now():Math.abs(o);return a.lift(new ie(l,n,e,t))}}(o,function se(o,e){return new j.c(e?t=>e.schedule(ue,0,{error:o,subscriber:t}):t=>t.error(o))}(new ae),e)}var U=S(7312);class ce{constructor(e){this.selector=e}call(e,t){return t.subscribe(new Pe(e,this.selector,this.caught))}}class Pe extends L.gn{constructor(e,t,a){super(e),this.selector=t,this.caught=a}error(e){if(!this.isStopped){let t;try{t=this.selector(e,this.caught)}catch(l){return void super.error(l)}this._unsubscribeAndRecycle();const a=new L.zA(this);this.add(a);const n=(0,L.tS)(t,a);n!==a&&this.add(n)}}}function G(o){return`${function de(o){return o.endsWith("/")?o.slice(0,-1):o}("https://www.sap-calculator.com/api")}${o}`}var Y=S(8935),fe=S.t(Y,2),K=S(7283),Se=S.t(K,2),V=S(3276),we=S.t(V,2);const B=new Map,z=new Map;(V??we).forEach(o=>{const e=String(o.Id),t=Number(o.Tier);B.set(e,o.Name),Number.isFinite(t)&&z.set(e,{name:o.Name,tier:t})});const ye=K??Se,be=new Map((Y??fe).map(o=>[String(o.Id),o.Name])),ge=new Map(ye.map(o=>[String(o.Id),o.Name])),W={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},Ae={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",abominationSwallowedPet1:"aSP1",abominationSwallowedPet2:"aSP2",abominationSwallowedPet3:"aSP3",abominationSwallowedPet1BelugaSwallowedPet:"aSP1B",abominationSwallowedPet2BelugaSwallowedPet:"aSP2B",abominationSwallowedPet3BelugaSwallowedPet:"aSP3B",abominationSwallowedPet1Level:"aSP1L",abominationSwallowedPet2Level:"aSP2L",abominationSwallowedPet3Level:"aSP3L",abominationSwallowedPet1TimesHurt:"aSP1T",abominationSwallowedPet2TimesHurt:"aSP2T",abominationSwallowedPet3TimesHurt:"aSP3T",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const o={};for(let e=1;e<=3;e++){const t=`parrotCopyPetAbominationSwallowedPet${e}`,a=`pCPAS${e}`;o[t]=a,o[`${t}BelugaSwallowedPet`]=`${a}B`,o[`${t}Level`]=`${a}L`,o[`${t}TimesHurt`]=`${a}T`,o[`${t}ParrotCopyPet`]=`${a}PCP`,o[`${t}ParrotCopyPetBelugaSwallowedPet`]=`${a}PCPB`;for(let n=1;n<=3;n++){const l=`${t}ParrotCopyPetAbominationSwallowedPet${n}`,r=`${a}PCPAS${n}`;o[l]=r,o[`${l}BelugaSwallowedPet`]=`${r}B`,o[`${l}Level`]=`${r}L`,o[`${l}TimesHurt`]=`${r}T`}}return o})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};function M(o){return"number"==typeof o&&Number.isFinite(o)?o:null}function A(o,e){return M(o)??e}function E(o){return null!==o&&"object"==typeof o&&!Array.isArray(o)}const Ce=new Set(["53","373"]),X=[{pet:"abominationSwallowedPet1",level:"abominationSwallowedPet1Level"},{pet:"abominationSwallowedPet2",level:"abominationSwallowedPet2Level"},{pet:"abominationSwallowedPet3",level:"abominationSwallowedPet3Level"}];function I(o){return"number"==typeof o&&Number.isFinite(o)?String(o):"string"==typeof o&&o.length>0?o:null}function T(o,e){if(Array.isArray(o))return void o.forEach(n=>T(n,e));if(!E(o))return;const t=I(o.Enu),a=o.Abil;t&&Array.isArray(a)&&!Ce.has(t)&&a.forEach(n=>{if(!E(n))return;const l=I(n.Enu);l&&function Te(o,e,t){let a=o.get(e);a||(a=new Map,o.set(e,a)),a.set(t,(a.get(t)??0)+1)}(e,l,t)}),Object.values(o).forEach(n=>{T(n,e)})}function ke(o){let e=null,t=-1;for(const[a,n]of o.entries())(n>t||n===t&&(null===e||a<e))&&(e=a,t=n);return e}function J(o){const e={};for(const[t,a]of o.entries()){const n=ke(a);n&&(e[t]=n)}return e}function N(o){if("string"!=typeof o||0===o.length)return null;try{return JSON.parse(o)}catch{return null}}class Be{parseReplayForCalculator(e,t,a,n){const l=e?.UserBoard??a?.userBoard,r=e?.OpponentBoard??a?.opponentBoard,i=(p,m,P)=>A(p?.[m],P),u=new Map,c=new Map,v=p=>{p&&Object.entries(p).forEach(([m,P])=>{const d=I(m);if(!d)return;const w="number"==typeof P||"string"==typeof P?String(P):null,f=(w?B.get(w):null)||("string"==typeof P?P:null);f&&u.set(d,f),w&&B.has(w)&&c.set(d,w)})},R=new Map;T(e,R),T(t,R),T(a,R),v(J(R)),v(n?.abilityPetMap??null);const De=p=>{if(!p)return null;const m=String(p.Enu??0),P=A(p.At?.Temp,0),d=A(p.Hp?.Temp,0);let w=null;if("182"===m){const b=p?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(b.length>0){const k=b[0]?.Enu;w=B.get(String(k))||`Pet #${k}`}}const f="373"===m?(p=>{const m={abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},P=(p?.Abil??[]).filter(f=>null!==f&&null!==I(f?.Enu));if(0===P.length)return m;const d=new Map,w=[];return P.forEach(f=>{const h=M(f?.Grop)??0;d.has(h)||(d.set(h,[]),w.push(h)),d.get(h)?.push(f)}),X.forEach((f,h)=>{const g=w[h];if(void 0===g)return;const C=d.get(g);if(!C||0===C.length)return;const b=C[0],k=I(b?.Enu);k&&(m[f.pet]=(p=>u.get(p)??(p=>{const m=Number(p);if(!Number.isInteger(m))return null;const P=new Map;for(const[h,g]of c.entries()){const C=Number(h),b=Number(g);if(!Number.isInteger(C)||!Number.isInteger(b))continue;const k=Math.abs(C-m);if(0===k||k>2)continue;const F=C-b;P.set(F,(P.get(F)??0)+1)}let d=null,w=0;for(const[h,g]of P.entries())(g>w||g===w&&(null===d||Math.abs(h)<Math.abs(d)))&&(d=h,w=g);if(null===d)return null;const f=String(m-d);return B.get(f)??null})(p))(k));const F=M(b?.Lvl);null!==F&&(m[f.level]=F)}),m})(p):{abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},h=(p=>M(p?.Pow?.SabertoothTigerAbility))(p),g=(p?.Abil??[]).map(b=>M(b?.TrCo)).filter(b=>null!==b),C={name:B.get(m)||null,attack:A(p.At?.Perm,0)+P,health:A(p.Hp?.Perm,0)+d,exp:A(p.Exp,0),equipment:p.Perk?{name:be.get(String(p.Perk))||"Unknown Perk"}:null,mana:A(p.Mana,0),belugaSwallowedPet:w,sarcasticFringeheadSwallowedPet:null,...f,battlesFought:0,triggersConsumed:g.length>0?Math.max(...g):0};return null!==h&&(C.timesHurt=h),C},Z=p=>{const m=(p?.Mins?.Items??[]).filter(d=>null!==d),P=Array(5).fill(null);return m.forEach((d,w)=>{let f=M(d.Poi?.x);null===f&&(f=w),f>=0&&f<5&&(P[f]=De(d))}),P.reverse()},q=p=>{const m=(p?.Rel?.Items??[]).find(P=>!!P?.Enu);if(m){const P=String(m.Enu);return{name:ge.get(P)||null,level:A(m.Lvl,1)}}return{name:null,level:1}},_=q(l),ee=q(r),x=this.buildCustomPacksFromGenesis(t,e),je=this.findCustomPackFromDeck(x,l?.Deck),Ue=this.findCustomPackFromDeck(x,r?.Deck);return{playerPack:W[A(l?.Pack,NaN)]||je?.name||"Turtle",opponentPack:W[A(r?.Pack,NaN)]||Ue?.name||"Turtle",playerToy:_.name,playerToyLevel:String(_.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:ee.name,opponentToyLevel:String(ee.level),opponentHardToy:null,opponentHardToyLevel:1,turn:i(l,"Tur",1)||1,playerGoldSpent:i(l,"GoSp",0)||0,opponentGoldSpent:i(r,"GoSp",0)||0,playerRollAmount:i(l,"Rold",0)||0,opponentRollAmount:i(r,"Rold",0)||0,playerSummonedAmount:i(l,"MiSu",0)||0,opponentSummonedAmount:i(r,"MiSu",0)||0,playerLevel3Sold:i(l,"MSFL",0)||0,opponentLevel3Sold:i(r,"MSFL",0)||0,playerTransformationAmount:i(l,"TrTT",0)||0,opponentTransformationAmount:i(r,"TrTT",0)||0,playerPets:Z(l),opponentPets:Z(r),allPets:!1,logFilter:null,customPacks:x,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(e,t){const a=[e?.Bor?.Deck,t?.UserBoard?.Deck,t?.OpponentBoard?.Deck].filter(i=>null!=i&&Array.isArray(i.Minions)),n=[],l=new Set,r=new Set;for(const i of a){const u=i?.Id?String(i.Id):null;if(u&&l.has(u))continue;u&&l.add(u);const c=this.buildCustomPackFromDeck(i,r);c&&n.push({...c,deckId:u})}return n}generateCalculatorLink(e){const t=window.location.origin+window.location.pathname,a=this.stripDefaultValues(e),n=this.truncateKeys(a),l=JSON.stringify(n);return`${t}#c=${btoa(l)}`}buildCustomPackFromDeck(e,t){if(!e||!Array.isArray(e.Minions))return null;const a=e.Minions.map(u=>String(u)),n=Array.isArray(e.Spells)?e.Spells.map(String):[],l={1:[],2:[],3:[],4:[],5:[],6:[]};for(const u of a){const c=z.get(u);c&&l[c.tier]&&l[c.tier].push(c.name)}const r=u=>{const c=u.slice(0,10);for(;c.length<10;)c.push(null);return c};let i=e.Title||"Custom Pack";if(t.has(i)){let u=2;for(;t.has(`${i} (${u})`);)u+=1;i=`${i} (${u})`}return t.add(i),{name:i,tier1Pets:r(l[1]),tier2Pets:r(l[2]),tier3Pets:r(l[3]),tier4Pets:r(l[4]),tier5Pets:r(l[5]),tier6Pets:r(l[6]),spells:n}}findCustomPackFromDeck(e,t){if(!t)return null;const a=t?.Id?String(t.Id):null;if(a){const l=e.find(r=>r.deckId===a);if(l)return l}const n=t?.Title;return n&&e.find(l=>l.name===n)||null}stripDefaultValues(e){const t={};"Turtle"!==e.playerPack&&(t.playerPack=e.playerPack),"Turtle"!==e.opponentPack&&(t.opponentPack=e.opponentPack),e.playerToy&&(t.playerToy=e.playerToy),e.playerToyLevel&&"1"!==e.playerToyLevel&&(t.playerToyLevel=e.playerToyLevel),e.opponentToy&&(t.opponentToy=e.opponentToy),e.opponentToyLevel&&"1"!==e.opponentToyLevel&&(t.opponentToyLevel=e.opponentToyLevel),11!==e.turn&&(t.turn=e.turn),10!==e.playerGoldSpent&&(t.playerGoldSpent=e.playerGoldSpent),10!==e.opponentGoldSpent&&(t.opponentGoldSpent=e.opponentGoldSpent),4!==e.playerRollAmount&&(t.playerRollAmount=e.playerRollAmount),4!==e.opponentRollAmount&&(t.opponentRollAmount=e.opponentRollAmount),0!==e.playerSummonedAmount&&(t.playerSummonedAmount=e.playerSummonedAmount),0!==e.opponentSummonedAmount&&(t.opponentSummonedAmount=e.opponentSummonedAmount),0!==e.playerLevel3Sold&&(t.playerLevel3Sold=e.playerLevel3Sold),0!==e.opponentLevel3Sold&&(t.opponentLevel3Sold=e.opponentLevel3Sold),0!==e.playerTransformationAmount&&(t.playerTransformationAmount=e.playerTransformationAmount),0!==e.opponentTransformationAmount&&(t.opponentTransformationAmount=e.opponentTransformationAmount),e.allPets&&(t.allPets=!0),e.oldStork&&(t.oldStork=!0),e.tokenPets&&(t.tokenPets=!0),e.komodoShuffle&&(t.komodoShuffle=!0),e.mana&&(t.mana=!0),null!=e.seed&&(t.seed=e.seed),e.triggersConsumed&&(t.triggersConsumed=!0),e.foodsEaten&&(t.foodsEaten=!0),e.showAdvanced&&(t.showAdvanced=!0),e.showTriggerNamesInLogs&&(t.showTriggerNamesInLogs=!0),e.showSwallowedLevels&&(t.showSwallowedLevels=!0),e.ailmentEquipment&&(t.ailmentEquipment=!0),e.logFilter&&(t.logFilter=e.logFilter),e.customPacks.length>0&&(t.customPacks=e.customPacks);const a=r=>{if(!r||!r.name)return null;const i={name:r.name};return"number"==typeof r.attack&&0!==r.attack&&(i.attack=r.attack),"number"==typeof r.health&&0!==r.health&&(i.health=r.health),"number"==typeof r.exp&&0!==r.exp&&(i.exp=r.exp),"number"==typeof r.mana&&0!==r.mana&&(i.mana=r.mana),r.equipment&&(i.equipment=r.equipment),r.triggersConsumed&&(i.triggersConsumed=r.triggersConsumed),r.foodsEaten&&(i.foodsEaten=r.foodsEaten),null!=r.belugaSwallowedPet&&(i.belugaSwallowedPet=r.belugaSwallowedPet),X.forEach(u=>{const c=r[u.pet];null!=c&&(i[u.pet]=c);const v=r[u.level];"number"==typeof v&&1!==v&&(i[u.level]=v)}),r.timesHurt&&(i.timesHurt=r.timesHurt),i},n=e.playerPets.map(a);n.some(r=>null!==r)&&(t.playerPets=n);const l=e.opponentPets.map(a);return l.some(r=>null!==r)&&(t.opponentPets=l),t}truncateKeys(e){if(Array.isArray(e))return e.map(t=>this.truncateKeys(t));if(E(e)){const t={};for(const a of Object.keys(e))t[Ae[a]||a]=this.truncateKeys(e[a]);return t}return e}}var s=S(5547),Me=S(7705),Ie=S(7868);let Fe=(()=>{class o{parser=new Be;parseReplayForCalculator(t,a,n,l){return this.parser.parseReplayForCalculator(t,a,n,l)}buildCustomPacksFromGenesis(t,a){return this.parser.buildCustomPacksFromGenesis(t,a)}generateCalculatorLink(t){return this.parser.generateCalculatorLink(t)}static \u0275fac=function(a){return new(a||o)};static \u0275prov=Ie.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})();var Ee=S(6980);function Ne(o,e){if(1&o&&(s.j41(0,"div",10),s.EFF(1),s.k0s()),2&o){const t=s.XpG();s.Y8G("ngClass","success"===t.statusTone?"text-success":"text-danger"),s.R7$(),s.SpI(" ",t.statusMessage," ")}}function Re(o,e){if(1&o&&(s.j41(0,"div",11),s.EFF(1),s.k0s()),2&o){const t=s.XpG();s.R7$(),s.JRh(t.errorMessage)}}let Oe=(()=>{class o{replayCalcService;http;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new y.gE({calcCode:new y.MJ(null,y.k0.required),turn:new y.MJ(1,y.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;statusTimer=null;constructor(t,a,n){this.replayCalcService=t,this.http=a,this.cdr=n}ngOnInit(){}submit(){this.errorMessage="",this.clearStatus();const t=this.formGroup.get("calcCode"),a=t?.value?.trim();if(!a)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let n;t?.setValue("",{emitEvent:!1}),t?.markAsPristine(),t?.markAsUntouched(),t?.updateValueAndValidity({emitEvent:!1});try{n=JSON.parse(a)}catch{if(this.importFunc(a))return void this.setStatus("Import successful.","success");if(this.tryReplayPid(a))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((n?.Pid||n?.pid)&&!n?.Actions){const l=n?.Pid??n?.pid,r=Number(n?.T??n?.t??this.formGroup.get("turn").value);return!Number.isFinite(r)||r<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.checkReplayApiReachable().then(i=>{i?(console.info("[replay] health check ok, requesting battle"),this.http.post(G("/replay-battle"),{Pid:l,T:r}).pipe(H(this.replayTimeoutMs),(0,U.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:u=>{const c=u?.battle;c?this.importReplayBattle(c,u?.genesisBuildModel,void 0,{abilityPetMap:u?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:u=>{if("TimeoutError"===u?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=u?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})):this.setLoading(!1)}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(n?.UserBoard&&n?.OpponentBoard)this.importReplayBattle(n,n?.GenesisBuildModel,{userBoard:n?.UserBoard,opponentBoard:n?.OpponentBoard},{abilityPetMap:n?.AbilityPetMap??null});else{if(n?.Actions){const l=Number(this.formGroup.get("turn").value??n?.T);if(!Number.isFinite(l)||l<=0)return void(this.errorMessage="Enter a valid turn number.");let r=0,i=null;for(const c of n.Actions)if(0===c?.Type&&c?.Battle&&(r+=1,r===l)){try{i=JSON.parse(c.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${l}.`)}break}if(!i)return void(this.errorMessage=`No battle found for turn ${l}.`);const u=n?.AbilityPetMap??function Le(o){const e=new Map;return(o??[]).forEach(t=>{const a=N(t?.Build),n=N(t?.Battle),l=N(t?.Mode);T(a,e),T(n,e),T(l,e)}),J(e)}(n.Actions);return void this.importReplayBattle(i,n?.GenesisBuildModel,{userBoard:n?.UserBoard,opponentBoard:n?.OpponentBoard},{abilityPetMap:u})}this.importFunc(a)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(t,a,n,l,r){const i=this.replayCalcService.parseReplayForCalculator(t,a,n,l);this.importFunc(JSON.stringify(i),r)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(t){const a=t?.trim();if(!a||!/^[a-f0-9-]{16,}$/i.test(a)&&!/^\d+$/.test(a))return!1;const l=Number(this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.checkReplayApiReachable().then(r=>{r?(console.info("[replay] health check ok, requesting battle"),this.http.post(G("/replay-battle"),{Pid:a,T:l}).pipe(H(this.replayTimeoutMs),(0,U.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:i=>{const u=i?.battle;u?this.importReplayBattle(u,i?.genesisBuildModel,void 0,{abilityPetMap:i?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:i=>{if("TimeoutError"===i?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=i?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})):this.setLoading(!1)}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}checkReplayApiReachable(){var t=this;return(0,oe.A)(function*(){return new Promise(a=>{console.info("[replay] health check start"),t.http.get(G("/health")).pipe(H(t.replayHealthTimeoutMs),function pe(o){return function(t){const a=new ce(o),n=t.lift(a);return a.caught=n}}(()=>(0,ne.of)(null))).subscribe({next:n=>{if(!n)return t.errorMessage="Replay API is not reachable. Ensure the replay server is running.",console.info("[replay] health check failed"),t.cdr.markForCheck(),void a(!1);console.info("[replay] health check success"),a(!0)},error:()=>{t.errorMessage="Replay API is not reachable. Ensure the replay server is running.",console.info("[replay] health check error"),t.cdr.markForCheck(),a(!1)}})})})()}setLoading(t){this.loading=t,this.cdr.markForCheck()}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(t,a){this.statusMessage=t,this.statusTone=a,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(a){return new(a||o)(s.rXU(Fe),s.rXU(Ee.Qq),s.rXU(Me.gRc))};static \u0275cmp=s.VBU({type:o,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:19,vars:6,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(a,n){1&a&&(s.j41(0,"div",0)(1,"div",1),s.EFF(2," Paste calculator export code (compressed), calculator JSON, or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),s.k0s(),s.j41(3,"div",1),s.EFF(4," Example Pid: "),s.j41(5,"code"),s.EFF(6),s.k0s()(),s.nrm(7,"textarea",2),s.j41(8,"div",3)(9,"div")(10,"label",4),s.EFF(11,"Turn (1-based)"),s.k0s(),s.nrm(12,"input",5),s.k0s(),s.j41(13,"button",6),s.bIt("click",function(){return n.submit()}),s.EFF(14),s.k0s()(),s.j41(15,"div",7),s.EFF(16," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),s.k0s(),s.DNE(17,Ne,2,2,"div",8)(18,Re,2,1,"div",9),s.k0s()),2&a&&(s.Y8G("formGroup",n.formGroup),s.R7$(6),s.JRh(n.pidExample),s.R7$(7),s.Y8G("disabled",n.loading),s.R7$(),s.SpI(" ",n.loading?"Fetching...":"Import"," "),s.R7$(3),s.Y8G("ngIf",n.statusMessage),s.R7$(),s.Y8G("ngIf",n.errorMessage))},dependencies:[O.MD,O.YU,O.bT,y.X1,y.me,y.Q0,y.BC,y.cb,y.VZ,y.j4,y.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return o})()}}]);