<div class="form-group" [formGroup]="formGroup">
  <label for="calcCode" class="form-label fw-semibold">Import Input</label>
  <div class="text-muted small mb-1">Supported formats:</div>
  <ul class="text-muted small ps-3 mb-2">
    <li>Compressed calculator export code</li>
    <li>Replay export code</li>
    <li>Calculator JSON</li>
    <li>Replay JSON (Actions, single battle JSON, or PID lookup)</li>
  </ul>
  <div class="text-muted small mb-2">
    PID example: <code>{{ pidExample }}</code>
  </div>
  <textarea
    class="form-control mb-2 calc-textarea"
    id="calcCode"
    rows="8"
    formControlName="calcCode"
    placeholder="Paste calculator or replay payload here..."
  ></textarea>
  <div class="d-flex align-items-end gap-3 flex-wrap mb-2">
    <div>
      <label for="turnNumber" class="form-label">Battle Turn</label>
      <input
        id="turnNumber"
        type="number"
        class="form-control"
        min="1"
        formControlName="turn"
      />
      <div class="text-muted small mt-1">1-based turn index</div>
    </div>
    <div>
      <label for="oddsSimulations" class="form-label">Image Simulations</label>
      <input
        id="oddsSimulations"
        type="number"
        class="form-control"
        min="1"
        formControlName="oddsSimulations"
      />
      <div class="text-muted small mt-1">
        Used for both odds and positioning image builds (positioning max 50)
      </div>
    </div>
    <div>
      <label for="positioningSide" class="form-label">Positioning Side</label>
      <select
        id="positioningSide"
        class="form-select"
        formControlName="positioningSide"
      >
        <option value="player">Player</option>
        <option value="opponent">Opponent</option>
      </select>
      <div class="text-muted small mt-1">Used for positioning image builds</div>
    </div>
  </div>
  <div class="d-flex align-items-end gap-2 flex-wrap mb-2">
    <button class="btn btn-primary" (click)="submit()" [disabled]="loading">
      {{ loading ? "Fetching..." : "Import Data" }}
    </button>
    <button
      class="btn btn-outline-primary"
      (click)="buildOddsImage()"
      [disabled]="oddsImageLoading"
    >
      {{ oddsImageLoading ? "Building Odds Image..." : "Build Odds Image" }}
    </button>
    <button
      class="btn btn-outline-success"
      (click)="buildPositioningImage()"
      [disabled]="positioningImageLoading"
    >
      {{
        positioningImageLoading
          ? "Building Positioning..."
          : "Build Positioning Image"
      }}
    </button>
  </div>
  <div *ngIf="positioningImageLoading" class="mb-2">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <div class="small text-muted">
        {{ positioningProgressMessage || "Building positioning image..." }}
      </div>
      <button
        type="button"
        class="btn btn-sm btn-outline-danger"
        (click)="cancelPositioningBuild()"
      >
        Cancel
      </button>
    </div>
    <div class="progress">
      <div
        class="progress-bar progress-bar-striped progress-bar-animated"
        role="progressbar"
        [style.width.%]="positioningProgressPercent"
        [attr.aria-valuenow]="positioningProgressPercent"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{ positioningProgressPercent }}%
      </div>
    </div>
  </div>
  <div class="warning mb-2">
    Warning: This will overwrite any existing custom packs. Any custom packs in
    the import will be added.
  </div>
  <div
    *ngIf="statusMessage"
    class="mb-2"
    [ngClass]="{
      'text-success': statusTone === 'success',
      'text-danger': statusTone === 'error',
      'text-warning': statusTone === 'warning'
    }"
  >
    {{ statusMessage }}
  </div>
  <div *ngIf="oddsImagePreviewUrl" class="odds-preview mb-3">
    <div class="odds-preview-header">
      <strong>Odds Image Preview</strong>
      <span class="text-muted small">{{ oddsImageFileName }}</span>
    </div>
    <img
      class="odds-preview-image"
      [src]="oddsImagePreviewUrl"
      alt="Replay odds preview"
    />
    <div class="odds-preview-actions mt-2">
      <button class="btn btn-primary me-2" (click)="downloadOddsImage()">
        Download PNG
      </button>
      <button class="btn btn-outline-secondary" (click)="clearOddsPreview()">
        Clear Preview
      </button>
    </div>
  </div>
  <div *ngIf="positioningImagePreviewUrl" class="odds-preview mb-3">
    <div class="odds-preview-header">
      <strong>Positioning Image Preview</strong>
      <span class="text-muted small">{{ positioningImageFileName }}</span>
    </div>
    <img
      class="odds-preview-image"
      [src]="positioningImagePreviewUrl"
      alt="Replay positioning preview"
    />
    <div class="odds-preview-actions mt-2">
      <button class="btn btn-success me-2" (click)="downloadPositioningImage()">
        Download PNG
      </button>
      <button class="btn btn-outline-secondary" (click)="clearPositioningPreview()">
        Clear Preview
      </button>
    </div>
  </div>
  <div *ngIf="errorMessage" class="text-danger mb-2">{{ errorMessage }}</div>
</div>
