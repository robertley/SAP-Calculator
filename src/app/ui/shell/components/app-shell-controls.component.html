<div class="top-controls card mb-3" [formGroup]="app.formGroup">
  <div class="top-controls-header">
    <div class="top-toolbar-zone top-toolbar-zone-run">
      <div class="zone-label">Run</div>
      <div class="simulate-controls">
        <div class="simulate-input-group">
          <button class="btn btn-primary" (click)="app.simulate(app.formGroup.get('simulations').value)"
            [disabled]="app.simulationInProgress">
            {{ app.simulationInProgress ? "Simulating..." : "Simulate" }}
          </button>
          <button class="btn btn-outline-danger" *ngIf="app.simulationInProgress" (click)="app.cancelSimulation()">
            Cancel
          </button>
          <input class="form-control simulate-input" type="number" formControlName="simulations" min="1" max="10000" />
        </div>
        <div class="optimize-control-group">
          <button class="btn btn-outline-primary" (click)="app.optimizePositioning(optimizeSide)"
            [disabled]="app.simulationInProgress">
            Optimize
          </button>
          <select class="form-select form-select-sm" [(ngModel)]="optimizeSide"
            [ngClass]="optimizeSide === 'player' ? 'side-select-player' : 'side-select-opponent'"
            [ngModelOptions]="{ standalone: true }" [disabled]="app.simulationInProgress">
            <option value="player" class="player-side-text">Player</option>
            <option value="opponent" class="opponent-side-text">Opponent</option>
          </select>
        </div>
        <div class="randomize-control-group">
          <button class="btn btn-secondary" (click)="app.randomize()">
            Randomize
          </button>
          <button class="btn btn-secondary" *ngIf="app.undoState" (click)="app.undoRandomize()">
            Undo Randomize
          </button>
        </div>
      </div>
    </div>
    <div class="top-toolbar-zone top-toolbar-zone-results">
      <div class="zone-label">{{ app.simulated ? "Results" : "Simulate to see results" }}</div>
      <ng-container *ngIf="app.simulated; else resultsPlaceholder">
        <div class="results-row">
          <div class="stats">
            <span class="stat-block player-stat">
              <span class="stat-label player-side-text">Player</span>
              <span class="stat-value">{{ app.playerWinner }} - {{ app.winPercent }}%</span>
            </span>
            <span class="stat-block draw-stat">
              <span class="stat-label">Draw</span>
              <span class="stat-value">{{ app.draw }} - {{ app.drawPercent }}%</span>
            </span>
            <span class="stat-block opponent-stat">
              <span class="stat-label opponent-side-text">Opponent</span>
              <span class="stat-value">{{ app.opponentWinner }} - {{ app.losePercent }}%</span>
            </span>
          </div>
          <div class="results-bar modern-results-bar" aria-hidden="true">
            <span class="results-segment results-segment-player" [style.width.%]="app.winPercent"></span>
            <span class="results-segment results-segment-draw" [style.width.%]="app.drawPercent"></span>
            <span class="results-segment results-segment-opponent" [style.width.%]="app.losePercent"></span>
          </div>
          <div class="optimization-delta" *ngIf="app.positioningDeltaSummary">
            <span class="optimization-delta-label">{{ app.positioningDeltaSideLabel }} optimize delta:</span>
            <span class="optimization-delta-value optimization-delta-value-win">Win {{ app.formatSignedPercentDelta(app.positioningDeltaSummary.winDeltaPercent) }}pp</span>
            <span class="optimization-delta-separator">&#183;</span>
            <span class="optimization-delta-value">Draw {{ app.formatSignedPercentDelta(app.positioningDeltaSummary.drawDeltaPercent) }}pp</span>
            <span class="optimization-delta-separator">&#183;</span>
            <span class="optimization-delta-value optimization-delta-value-loss">Loss {{ app.formatSignedPercentDelta(app.positioningDeltaSummary.lossDeltaPercent) }}pp</span>
          </div>
        </div>
      </ng-container>
      <ng-template #resultsPlaceholder>
        <div class="results-placeholder">
          <span class="results-bar modern-results-bar placeholder-bar" aria-hidden="true"></span>
        </div>
      </ng-template>
    </div>
    <div class="top-toolbar-zone top-toolbar-zone-actions">
      <div class="zone-label zone-label-right">Actions</div>
      <div class="external-buttons">
        <button class="btn btn-secondary" (click)="app.toggleTheme()">
          {{ app.theme === "dark" ? "Light Theme" : "Dark Theme" }}
        </button>
        <div class="sound-menu" #soundMenuRoot>
          <button class="btn btn-secondary" (click)="app.toggleSoundMenu()">
            Sound
          </button>
          <div class="sound-menu-panel" *ngIf="app.soundMenuOpen">
            <div class="sound-menu-title">Volume: {{ app.soundVolumePercent }}%</div>
            <input
              class="form-range sound-menu-slider"
              type="range"
              min="0"
              max="1"
              step="0.05"
              [ngModel]="app.soundVolume"
              (ngModelChange)="app.setSoundVolume($event)"
              [ngModelOptions]="{ standalone: true }"
            />
            <button class="btn btn-secondary btn-sm sound-menu-mute-btn" (click)="app.toggleSoundMuted()">
              {{ app.soundMuted ? "Unmute" : "Mute" }}
            </button>
          </div>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#info"
          (click)="app.showInfo = true" aria-label="Open guide">
          Guide
        </button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#reportABug"
          (click)="app.showReportABug = true">
          Report A Bug
        </button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#export"
          (click)="app.showExport = true">
          Export
        </button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#import"
          (click)="app.showImport = true">
          Import
        </button>
        <button class="btn btn-primary" (click)="app.generateShareLink()">
          Generate Link
        </button>
      </div>
      <div class="external-meta top-controls-meta-text">
        Shortcuts: Alt+S simulate, Alt+R randomize, Alt+P/O optimize, Alt+A controls, Alt+T theme
      </div>
    </div>
  </div>

  <div *ngIf="app.statusMessage" class="px-3 pb-2"
    [ngClass]="app.statusTone === 'success' ? 'text-success' : 'text-danger'">
    {{ app.statusMessage }}
  </div>
  <div *ngIf="app.autoSaveLabel" class="px-3 pb-2 text-muted small top-controls-meta-text">
    {{ app.autoSaveLabel }}
  </div>
  <div *ngIf="app.simulationInProgress" class="simulation-progress px-3 pb-2">
    <div class="progress flex-1">
      <div class="progress-bar" role="progressbar" [style.width]="app.simulationProgress + '%'"></div>
    </div>
    <div class="progress-text">
      {{ app.simulationCancelRequested ? "Cancelling..." : app.simulationProgressLabel }}
    </div>
  </div>

  <div class="top-controls-body">
    <div class="controls-grid">
      <div class="controls-section unified-advanced-section">
        <div class="unified-advanced-header">
          <button type="button" class="btn-link unified-advanced-toggle-btn" (click)="app.toggleAdvanced()"
            [attr.aria-expanded]="isUnifiedAdvancedExpanded" aria-controls="advanced-overrides-panel">
            <span class="section-title">Scenario Controls</span>
            <span class="unified-advanced-count" *ngIf="activeAdvancedOverridesCount">
              {{ activeAdvancedOverridesCount }} active
            </span>
            <span class="unified-advanced-chevron" [class.expanded]="isUnifiedAdvancedExpanded"
              aria-hidden="true">&#9662;</span>
          </button>
        </div>

        <div class="unified-advanced-summary" *ngIf="!isUnifiedAdvancedExpanded">
          {{ unifiedAdvancedSummary }}
        </div>

        <div id="advanced-overrides-panel" class="unified-advanced-body" *ngIf="isUnifiedAdvancedExpanded">
          <div class="controls-section nested-section packs-section">
            <div class="section-title subsection-title">Pack Selection</div>
            <div class="form-group min-w-input">
              <label><span class="player-side-text">Player</span> Pack</label>
              <button class="selection-btn" (click)="app.openSelectionDialog('pack', 'player')">
                <img *ngIf="
                        app.getPackIconPath(app.formGroup.get('playerPack').value) &&
                        !app.playerPackImageBroken
                      " [ngSrc]="app.getPackIconPath(app.formGroup.get('playerPack').value)" class="btn-icon"
                  width="24" height="24" loading="lazy" decoding="async" (error)="app.onPackImageError('player')" />
                <span class="btn-text">{{
                  app.formGroup.get("playerPack").value || "Select Pack"
                  }}</span>
                <i class="fas fa-chevron-down ms-auto"></i>
              </button>
            </div>
            <div class="form-group min-w-input">
              <label><span class="opponent-side-text">Opponent</span> Pack</label>
              <button class="selection-btn" (click)="app.openSelectionDialog('pack', 'opponent')">
                <img *ngIf="
                        app.getPackIconPath(app.formGroup.get('opponentPack').value) &&
                        !app.opponentPackImageBroken
                      " [ngSrc]="app.getPackIconPath(app.formGroup.get('opponentPack').value)" class="btn-icon"
                  width="24" height="24" loading="lazy" decoding="async" (error)="app.onPackImageError('opponent')" />
                <span class="btn-text">{{
                  app.formGroup.get("opponentPack").value || "Select Pack"
                  }}</span>
                <i class="fas fa-chevron-down ms-auto"></i>
              </button>
            </div>
            <div class="form-check" title="All pets are included in the pet pool.">
              <input class="form-check-input" type="checkbox" value="" id="allPets" formControlName="allPets" />
              <label class="form-check-label" for="allPets">All Pets</label>
            </div>
          </div>

          <div class="controls-section nested-section teams-section">
            <div class="section-title subsection-title">Save / Load Teams</div>
            <div class="team-column">
              <input class="form-control team-name-input" [(ngModel)]="app.teamName"
                [ngModelOptions]="{ standalone: true }" placeholder="Team name" />
              <div class="team-name-actions">
                <button class="btn btn-secondary btn-sm" (click)="app.saveTeam(saveSide)">
                  Save
                </button>
                <select class="form-select form-select-sm" [(ngModel)]="saveSide"
                  [ngClass]="saveSide === 'player' ? 'side-select-player' : 'side-select-opponent'"
                  [ngModelOptions]="{ standalone: true }">
                  <option value="player" class="player-side-text">Player</option>
                  <option value="opponent" class="opponent-side-text">Opponent</option>
                </select>
              </div>
            </div>
            <div class="team-column">
              <button class="selection-btn team-selection-btn" (click)="app.openSelectionDialog('team', 'none')">
                <div class="team-preview" *ngIf="
                        app.selectedTeamPreviewIcons.length;
                        else teamPlaceholder
                      ">
                  <img *ngFor="
                          let icon of app.selectedTeamPreviewIcons;
                          let i = index
                        " [ngSrc]="icon" width="28" height="28" loading="lazy" decoding="async"
                    [alt]="app.selectedTeamName" class="team-preview-icon" />
                </div>
                <ng-template #teamPlaceholder>
                  <span class="btn-placeholder">Saved teams</span>
                </ng-template>
                <span class="btn-text">{{ app.selectedTeamName }}</span>
                <i class="fas fa-chevron-down ms-auto"></i>
              </button>
              <div class="team-name-actions load-actions">
                <button class="btn btn-secondary btn-sm" (click)="app.loadTeam(loadSide)">
                  Load
                </button>
                <select class="form-select form-select-sm" [(ngModel)]="loadSide"
                  [ngClass]="loadSide === 'player' ? 'side-select-player' : 'side-select-opponent'"
                  [ngModelOptions]="{ standalone: true }">
                  <option value="player" class="player-side-text">Player</option>
                  <option value="opponent" class="opponent-side-text">Opponent</option>
                </select>
              </div>
            </div>
          </div>

          <div class="advanced-panel-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <div class="section-title mb-0">Scenario Settings</div>
              <button type="button" class="btn btn-outline-secondary btn-sm" (click)="resetScenarioSettings()"
                [disabled]="!app?.formGroup">
                Reset Scenario Settings
              </button>
            </div>
            <div class="advanced-grid">
              <div class="form-check" title="Shuffle pets in front of Komodo if present.">
                <input class="form-check-input" type="checkbox" value="" id="komodoShuffle"
                  formControlName="komodoShuffle" />
                <label class="form-check-label advanced-label-with-icon" for="komodoShuffle">
                  <span class="advanced-icon komodo-icon" aria-hidden="true"></span>
                  Komodo Shuffle
                </label>
              </div>
              <div class="form-check" title="Enable changing equipment uses globally.">
                <input class="form-check-input" type="checkbox" value="" id="changeEquipmentUses"
                  formControlName="changeEquipmentUses" />
                <label class="form-check-label advanced-label-with-icon" for="changeEquipmentUses">
                  <span class="advanced-icon perk-icon" aria-hidden="true"></span>
                  Change equipment uses
                </label>
              </div>
              <div class="form-check" title="Include Mana.">
                <input class="form-check-input" type="checkbox" value="" id="mana" formControlName="mana" />
                <label class="form-check-label advanced-label-with-icon" for="mana">
                  <span class="advanced-icon mana-icon" aria-hidden="true"></span>
                  Mana
                </label>
              </div>
              <div class="form-check" title="Disable battle logs for faster simulations.">
                <input class="form-check-input" type="checkbox" value="" id="logsEnabled"
                  formControlName="logsEnabled" />
                <label class="form-check-label" for="logsEnabled">
                  Enable logs
                </label>
              </div>
              <div class="form-check" title="Include Triggers Consumed.">
                <input class="form-check-input" type="checkbox" value="" id="triggersConsumed"
                  formControlName="triggersConsumed" />
                <label class="form-check-label advanced-label-with-icon" for="triggersConsumed">
                  <span class="advanced-icon pheasant-icon" aria-hidden="true"></span>
                  Triggers Consumed
                </label>
              </div>
              <div class="form-check" title="Show debug details: trigger names and random reason labels.">
                <input class="form-check-input" type="checkbox" value="" id="showTriggerNamesInLogs"
                  formControlName="showTriggerNamesInLogs" (change)="app.refreshDebugLogPresentation()" />
                <label class="form-check-label" for="showTriggerNamesInLogs">
                  Debug Info
                </label>
              </div>
              <div class="form-check" title="Show [P#/O#] positional prefixes in logs and animation.">
                <input class="form-check-input" type="checkbox" value="" id="showPositionalArgsInLogs"
                  formControlName="showPositionalArgsInLogs" (change)="app.refreshDebugLogPresentation()" />
                <label class="form-check-label" for="showPositionalArgsInLogs">
                  Positional Args
                </label>
              </div>
            </div>
            <div class="advanced-number-grid mt-2">
              <div class="form-group small-w-input">
                <label for="turn">Turn Number</label>
                <input class="form-control" id="turn" type="number" formControlName="turn" max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="seed" title="Simulation Seed">
                  Seed
                </label>
                <input class="form-control" id="seed" type="number" formControlName="seed" />
              </div>
              <div class="form-group advanced-input">
                <label for="playerGoldSpent" title="Player Gold Spent" class="advanced-label-with-icon">
                  <span class="advanced-icon gold-icon" aria-hidden="true"></span>
                  <span class="player-side-text">Player</span> Gold Spent
                </label>
                <input id="playerGoldSpent" class="form-control" type="number" formControlName="playerGoldSpent"
                  max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="opponentGoldSpent" title="Opponent Gold Spent" class="advanced-label-with-icon">
                  <span class="advanced-icon gold-icon" aria-hidden="true"></span>
                  <span class="opponent-side-text">Opponent</span> Gold Spent
                </label>
                <input id="opponentGoldSpent" class="form-control" type="number" formControlName="opponentGoldSpent"
                  max="99" />
              </div>
              <div class="form-group advanced-input" *ngIf="app.rollInputVisible">
                <label for="playerRollAmount" title="Player Roll Amount" class="advanced-label-with-icon">
                  <span class="advanced-icon roll-icon" aria-hidden="true"></span>
                  <span class="player-side-text">Player</span> Roll Amount
                </label>
                <input id="playerRollAmount" class="form-control" type="number" formControlName="playerRollAmount"
                  max="99" />
              </div>
              <div class="form-group advanced-input" *ngIf="app.rollInputVisible">
                <label for="opponentRollAmount" title="Opponent Roll Amount" class="advanced-label-with-icon">
                  <span class="advanced-icon roll-icon" aria-hidden="true"></span>
                  <span class="opponent-side-text">Opponent</span> Roll Amount
                </label>
                <input id="opponentRollAmount" class="form-control" type="number" formControlName="opponentRollAmount"
                  max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="playerLevel3Sold" title="Player Level 3 Sold" class="advanced-label-with-icon">
                  <span class="advanced-icon cycle-icon" aria-hidden="true"></span>
                  <span class="player-side-text">Player</span> Level 3 Sold
                </label>
                <input id="playerLevel3Sold" class="form-control" type="number" formControlName="playerLevel3Sold"
                  max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="opponentLevel3Sold" title="Opponent Level 3 Sold" class="advanced-label-with-icon">
                  <span class="advanced-icon cycle-icon" aria-hidden="true"></span>
                  <span class="opponent-side-text">Opponent</span> Level 3 Sold
                </label>
                <input id="opponentLevel3Sold" class="form-control" type="number" formControlName="opponentLevel3Sold"
                  max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="playerSummonedAmount" title="Player Summoned Amount" class="advanced-label-with-icon">
                  <span class="advanced-icon summon-icon" aria-hidden="true"></span>
                  <span class="player-side-text">Player</span> Summoned Amount
                </label>
                <input id="playerSummonedAmount" class="form-control" type="number"
                  formControlName="playerSummonedAmount" max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="opponentSummonedAmount" title="Opponent Summoned Amount" class="advanced-label-with-icon">
                  <span class="advanced-icon summon-icon" aria-hidden="true"></span>
                  <span class="opponent-side-text">Opponent</span> Summoned Amount
                </label>
                <input id="opponentSummonedAmount" class="form-control" type="number"
                  formControlName="opponentSummonedAmount" max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="playerTransformationAmount" title="Player Transformation Amount"
                  class="advanced-label-with-icon">
                  <span class="advanced-icon transform-icon" aria-hidden="true"></span>
                  <span class="player-side-text">Player</span> Transformation Amount
                </label>
                <input id="playerTransformationAmount" class="form-control" type="number"
                  formControlName="playerTransformationAmount" max="99" />
              </div>
              <div class="form-group advanced-input">
                <label for="opponentTransformationAmount" title="Opponent Transformation Amount"
                  class="advanced-label-with-icon">
                  <span class="advanced-icon transform-icon" aria-hidden="true"></span>
                  <span class="opponent-side-text">Opponent</span> Transformation Amount
                </label>
                <input id="opponentTransformationAmount" class="form-control" type="number"
                  formControlName="opponentTransformationAmount" max="99" />
              </div>
            </div>
          </div>

          <div class="random-overrides-panel">
            <div class="random-overrides-header">
              <button type="button" class="btn-link random-overrides-toggle" (click)="app.toggleRandomOverrides()"
                [attr.aria-expanded]="app.showRandomOverrides" aria-controls="random-overrides-panel">
                <span class="section-title">Random Overrides</span>
                <span class="random-overrides-count" *ngIf="app.randomDecisions.length">
                  {{ app.randomDecisions.length }} events
                </span>
                <span class="random-overrides-chevron" [class.expanded]="app.showRandomOverrides"
                  aria-hidden="true">&#9662;</span>
              </button>
              <div class="random-overrides-actions" *ngIf="app.showRandomOverrides">
                <button class="btn btn-secondary btn-sm" (click)="app.captureRandomEvents()"
                  [disabled]="app.simulationInProgress"
                  title="Runs one logged battle and captures random decision points.">
                  Capture Random Events
                </button>
                <button class="btn btn-primary btn-sm" (click)="app.runForcedRandomSimulation()"
                  [disabled]="app.simulationInProgress || !app.randomDecisions.length"
                  title="Runs one logged battle while forcing selected random options.">
                  Run Forced Simulation
                </button>
                <button class="btn btn-outline-danger btn-sm" (click)="app.clearRandomOverrides()"
                  [disabled]="!app.randomDecisions.length">
                  Clear
                </button>
              </div>
            </div>

            <div class="random-overrides-summary" *ngIf="!app.showRandomOverrides">
              {{ app.randomDecisions.length ? 'Overrides captured. Expand to inspect or force outcomes.' : 'Capture
              random events when needed.' }}
            </div>

            <div id="random-overrides-panel" *ngIf="app.showRandomOverrides" class="random-overrides-body">
              <div class="random-overrides-empty" *ngIf="!app.randomDecisions.length">
                Capture random events to populate override selectors.
              </div>

              <div class="random-overrides-error" *ngIf="app.randomOverrideError">
                {{ app.randomOverrideError }}
              </div>

              <div class="random-overrides-table-wrap" *ngIf="app.randomDecisions.length">
                <table class="table table-sm random-overrides-table">
                  <thead>
                    <tr>
                      <th scope="col">Step</th>
                      <th scope="col">Event</th>
                      <th scope="col">Forced Choice</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let decision of app.randomDecisions; trackBy: app.trackByIndex">
                      <td>{{ decision.index + 1 }}</td>
                      <td>
                        <div class="decision-label">
                          <ng-container
                            *ngFor="let part of app.getRandomDecisionLabelParts(decision); trackBy: app.trackByIndex">
                            <img *ngIf="part.type === 'img'" [ngSrc]="part.src" class="log-inline-icon" [alt]="part.alt"
                              width="16" height="16" loading="lazy" decoding="async" />
                            <span *ngIf="part.type === 'text'" [ngClass]="part.className">{{ part.text }}</span>
                            <br *ngIf="part.type === 'br'" />
                          </ng-container>
                        </div>
                        <div class="decision-key">{{ decision.key }}</div>
                      </td>
                      <td>
                        <div class="decision-choice-preview">
                          <ng-container
                            *ngFor="let part of app.getRandomDecisionSelectedOptionParts(decision); trackBy: app.trackByIndex">
                            <img *ngIf="part.type === 'img'" [ngSrc]="part.src" class="log-inline-icon" [alt]="part.alt"
                              width="16" height="16" loading="lazy" decoding="async" />
                            <span *ngIf="part.type === 'text'" [ngClass]="part.className">{{ part.text }}</span>
                            <br *ngIf="part.type === 'br'" />
                          </ng-container>
                        </div>
                        <select class="form-select form-select-sm"
                          [ngModel]="app.getSelectedRandomDecisionOptionId(decision)"
                          (ngModelChange)="app.onRandomDecisionChoiceChanged(decision, $event)"
                          [ngModelOptions]="{ standalone: true }">
                          <option *ngFor="let option of decision.options; trackBy: app.trackByIndex"
                            [ngValue]="option.id">
                            {{ option.label }}
                          </option>
                        </select>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
