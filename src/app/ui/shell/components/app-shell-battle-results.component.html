    <div class="bottom-container-scroll" *ngIf="app.simulated">
      <div class="bottom-container-scroll-hint" aria-hidden="true" *ngIf="!isTabletTabsLayout">
        Swipe or shift-scroll to view logs ->
      </div>
      <div class="pane-switch-tabs" *ngIf="isTabletTabsLayout" role="tablist" aria-label="Battle results sections">
        <button
          type="button"
          class="pane-switch-tab"
          role="tab"
          [class.active]="activeTabletPane === 'battle'"
          [attr.aria-selected]="activeTabletPane === 'battle'"
          (click)="setTabletActivePane('battle')"
        >
          Battles
        </button>
        <button
          type="button"
          class="pane-switch-tab"
          role="tab"
          [class.active]="activeTabletPane === 'logs'"
          [attr.aria-selected]="activeTabletPane === 'logs'"
          (click)="setTabletActivePane('logs')"
        >
          Logs
        </button>
      </div>
      <div class="row flex-1 bottom-container g-0" #battleSplitContainer
        [class.bottom-container-single-column]="isTabletTabsLayout">
        <div class="col-12 col-md-6 h-100 flex-col pe-0 battle-pane"
          [class.pane-hidden-single-column]="isTabletTabsLayout && activeTabletPane !== 'battle'"
          [style.flex-basis.px]="isTabletTabsLayout ? null : leftPaneWidthPx"
          [style.max-width.px]="isTabletTabsLayout ? null : leftPaneWidthPx"
          [style.width.px]="isTabletTabsLayout ? null : leftPaneWidthPx">
        <div class="pane-top-shell battle-top-shell">
          <h3 class="pane-title">Battles</h3>
          <label for="logFilter" class="pane-subtitle">Filter battles by winner</label>
          <div class="log-filter-tabs" id="logFilter">
            <button *ngFor="let tab of app.logFilterTabs; trackBy: app.trackByLogTab" type="button" class="log-filter-tab"
              [class.active]="app.formGroup.get('logFilter').value === tab.value"
              [ngClass]="{
                'player-side-text': tab.value === 'player',
                'opponent-side-text': tab.value === 'opponent'
              }"
              (click)="app.formGroup.get('logFilter').setValue(tab.value)">
              {{ tab.label }}
            </button>
          </div>
        </div>

        <div class="battle-container flex-1">
          <div class="battle-table-shell">
            <div class="battle-table-meta">
              <span>{{ app.filteredBattlesCache.length }} battles</span>
              <span *ngIf="app.viewBattle as selected">Viewing #{{ app.battles.indexOf(selected) }}</span>
            </div>
            <table class="table battle-table mb-0">
              <thead>
                <tr>
                  <th>Winner</th>
                  <th>Random Events</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="
                    let battle of app.filteredBattlesCache;
                    trackBy: app.trackByIndex
                  " (click)="app.setViewBattle(battle)" class="table-battle-row" [ngClass]="
                    battle.winner === 'player'
                      ? 'battle-win'
                      : battle.winner === 'opponent'
                        ? 'battle-loss'
                        : 'battle-draw'
                  " [class.selected-battle]="battle === app.viewBattle">
                  <td>
                    <span class="battle-winner-chip" [ngClass]="{
                      'battle-winner-player': battle.winner === 'player',
                      'battle-winner-opponent': battle.winner === 'opponent',
                      'battle-winner-draw': battle.winner === 'draw'
                    }">
                      {{ battle.winner }}
                    </span>
                  </td>
                  <td class="battle-random-cell">
                    <ng-container *ngIf="(app.battleRandomEventsByBattle.get(battle) || []).length > 0; else noRandomEvents">
                      <ng-container *ngFor="
                          let part of (app.battleRandomEventsByBattle.get(battle) || []);
                          trackBy: app.trackByIndex
                        ">
                        <img *ngIf="part.type === 'img'" [ngSrc]="part.src" class="log-inline-icon" [alt]="part.alt"
                          width="16" height="16" loading="lazy" decoding="async" />
                        <span *ngIf="part.type === 'text'" [ngClass]="part.className">{{ part.text }}</span>
                        <br *ngIf="part.type === 'br'" />
                      </ng-container>
                    </ng-container>
                    <ng-template #noRandomEvents>
                      <span class="battle-no-random">None</span>
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

        <div *ngIf="!isTabletTabsLayout" class="battle-log-divider" role="separator" aria-label="Resize battle and logs panes"
          aria-orientation="vertical" tabindex="0" (pointerdown)="onDividerPointerDown($event)"
          (pointermove)="onDividerPointerMove($event)" (pointerup)="onDividerPointerUp($event)"
          (pointercancel)="onDividerPointerUp($event)" (keydown)="onPaneDividerKeyDown($event)"></div>

        <div class="col-12 col-md-6 h-100 flex-col logs-pane"
          [class.pane-hidden-single-column]="isTabletTabsLayout && activeTabletPane !== 'logs'">
        <div class="pane-top-shell logs-top-shell">
          <div class="d-flex align-items-center justify-content-between battle-view-header">
            <h3 class="pane-title">Fight Animation + Logs</h3>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-sm btn-secondary" (click)="app.toggleBattleAnalysis()">
                {{ app.showBattleAnalysis ? 'Hide' : 'Show' }} Analysis
              </button>
            </div>
          </div>

          <div class="log-event-filters">
            <span class="log-event-filter-label">Event filter</span>
            <button
              type="button"
              class="log-event-filter-btn"
              *ngFor="let option of app.logEventFilterOptions; trackBy: app.trackByIndex"
              [class.active]="app.logEventFilter === option.value"
              (click)="app.setViewBattleLogFilter(option.value)"
            >
              {{ option.label }}
            </button>
          </div>
        </div>

        <div class="vertical-resizable-stack" #animationSplitContainer
          [style.--fight-motion-scale]="app.fightAnimationMotionScale">
          <div class="animation-top-pane" [style.flex-basis.px]="animationTopHeightPx" [style.max-height.px]="animationTopHeightPx"
            [style.height.px]="animationTopHeightPx">
            <ng-container *ngIf="app.currentFightAnimationRenderFrame as frameVm; else noAnimationFrames">
                <div
                  class="fight-stage"
                  [class.fight-phase-a]="frameVm.phase === 'a'"
                  [class.fight-phase-b]="frameVm.phase === 'b'"
                  [class.fight-frame-attack]="frameVm.frame.type === 'attack'"
                  [class.fight-frame-contact-freeze]="frameVm.frame.type === 'attack' && frameVm.frame.impact && !frameVm.frame.impact.isSnipe"
                  [class.fight-frame-ability]="frameVm.frame.type === 'ability' || frameVm.frame.type === 'equipment'"
                  [class.fight-frame-heavy-impact]="app.currentFightAnimationIsHeavyImpactFrame"
                  [class.fight-frame-burst]="app.currentFightAnimationIsBurstFrame"
                  [class.fight-frame-resolution]="app.currentFightAnimationIsResolutionFrame"
                  [style.--fight-frame-cadence]="app.currentFightAnimationCadenceScale"
                  [style.--fight-impact-scale]="app.currentFightAnimationImpactScale"
                >
              <div class="fight-team fight-team-opponent">
                <div class="fight-team-toy-wrap">
                  <img *ngIf="frameVm.frame.opponentToyName" [ngSrc]="app.getToyIconPath(frameVm.frame.opponentToyName)"
                    class="fight-team-toy" [alt]="frameVm.frame.opponentToyName + ' toy'" width="24" height="24" loading="lazy" decoding="async" />
                  <img *ngIf="frameVm.frame.opponentHardToyName" [ngSrc]="app.getToyIconPath(frameVm.frame.opponentHardToyName)"
                    class="fight-team-toy fight-team-toy-hard" [alt]="frameVm.frame.opponentHardToyName + ' hard toy'" width="24" height="24" loading="lazy" decoding="async" />
                </div>
                <div class="fight-slot" *ngFor="let slotVm of frameVm.opponentSlots; trackBy: app.trackByIndex"
                  [ngClass]="slotVm.classMap" [style.--fight-shift-steps]="slotVm.shiftSteps">
                  <div class="fight-slot-label">{{ slotVm.slot.label || ('O' + (slotVm.slot.slot + 1)) }}</div>
                  <div class="fight-slot-art">
                    <img *ngIf="slotVm.slot.petIconSrc" [ngSrc]="slotVm.slot.petIconSrc" class="fight-slot-icon"
                      [alt]="slotVm.slot.petName || 'Opponent pet'" width="42" height="42" loading="lazy" decoding="async" />
                    <img *ngIf="slotVm.slot.petCompanionIconSrc" [ngSrc]="slotVm.slot.petCompanionIconSrc" class="fight-slot-companion"
                      [alt]="slotVm.slot.petCompanionName || 'Companion pet'" width="16" height="16" loading="lazy"
                      decoding="async" />
                    <span *ngIf="!slotVm.slot.petIconSrc" class="fight-slot-empty">___</span>
                    <img *ngIf="slotVm.slot.equipmentIconSrc" [ngSrc]="slotVm.slot.equipmentIconSrc" class="fight-slot-equipment"
                      [alt]="slotVm.slot.equipmentName || 'Equipment'" width="16" height="16" loading="lazy" decoding="async" />
                    <div class="fight-equipment-ghost" *ngIf="slotVm.removedEquipment as removedEquipment">
                      <img *ngIf="removedEquipment.equipmentIconSrc" [ngSrc]="removedEquipment.equipmentIconSrc"
                        class="fight-equipment-ghost-icon" [alt]="(removedEquipment.equipmentName || 'Equipment') + ' removed'" width="16"
                        height="16" loading="lazy" decoding="async" />
                    </div>
                    <div class="fight-equipment-gain-ghost" *ngIf="slotVm.addedEquipment as addedEquipment">
                      <img *ngIf="addedEquipment.equipmentIconSrc" [ngSrc]="addedEquipment.equipmentIconSrc"
                        class="fight-equipment-gain-icon" [alt]="(addedEquipment.equipmentName || 'Equipment') + ' added'" width="16"
                        height="16" loading="lazy" decoding="async" />
                    </div>
                    <div class="fight-snipe-impact" *ngIf="slotVm.showSnipeImpact">
                      <img [ngSrc]="app.fightSnipeIconSrc" class="fight-snipe-impact-icon" alt="" aria-hidden="true"
                        width="20" height="20" loading="lazy" decoding="async" />
                    </div>
                    <ng-container *ngFor="let popup of slotVm.popups; index as popupIndex; trackBy: app.trackByIndex">
                      <span class="fight-value-popup"
                        [class.fight-value-popup-damage]="popup.type === 'damage'"
                        [class.fight-value-popup-trumpets]="popup.type === 'trumpets'"
                        [class.fight-value-popup-buff]="popup.type !== 'damage' && popup.delta > 0"
                        [class.fight-value-popup-debuff]="popup.type !== 'damage' && popup.delta < 0"
                        [style.--fight-popup-index]="popupIndex">
                        <img *ngIf="popup.type === 'attack' || popup.type === 'health' || popup.type === 'exp' || popup.type === 'mana' || popup.type === 'trumpets'"
                          [ngSrc]="popup.type === 'attack'
                            ? app.fightAttackIconSrc
                            : popup.type === 'health'
                              ? app.fightHealthIconSrc
                              : popup.type === 'exp'
                                ? app.fightExpIconSrc
                                : popup.type === 'mana'
                                  ? app.fightManaIconSrc
                                  : app.fightTrumpetIconSrc"
                          class="fight-value-popup-icon" alt="" aria-hidden="true" width="14" height="14" loading="lazy"
                          decoding="async" />
                        <span class="fight-value-popup-number">{{ (popup.delta > 0 ? '+' : '-') + (popup.delta > 0 ? popup.delta : -popup.delta) }}</span>
                      </span>
                    </ng-container>
                    <div class="fight-faint-ghost" *ngIf="slotVm.death as death">
                      <img *ngIf="death.petIconSrc" [ngSrc]="death.petIconSrc" class="fight-faint-icon"
                        [alt]="death.petName || 'Fainted pet'" width="40" height="40" loading="lazy" decoding="async" />
                      <img *ngIf="death.petCompanionIconSrc" [ngSrc]="death.petCompanionIconSrc" class="fight-faint-companion"
                        [alt]="death.petCompanionName || 'Fainted companion'" width="14" height="14" loading="lazy"
                        decoding="async" />
                    </div>
                  </div>
                  <div class="fight-slot-stats" *ngIf="slotVm.slot.attack != null || slotVm.slot.health != null || slotVm.slot.exp != null || slotVm.slot.mana != null">
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.attack != null">
                      <img [ngSrc]="app.fightAttackIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.attack }}</span>
                    </span>
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.health != null">
                      <img [ngSrc]="app.fightHealthIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.health }}</span>
                    </span>
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.mana != null">
                      <img [ngSrc]="app.fightManaIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.mana }}</span>
                    </span>
                    <span class="fight-slot-stat fight-slot-exp" *ngIf="slotVm.slot.exp != null">
                      <img [ngSrc]="app.fightExpIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span class="fight-slot-exp-group">
                        <span class="fight-slot-exp-levels" aria-hidden="true">
                          <span class="fight-slot-exp-level">L1</span>
                          <span></span>
                          <span class="fight-slot-exp-level">L2</span>
                          <span></span>
                          <span class="fight-slot-exp-level">L3</span>
                        </span>
                        <span class="fight-slot-exp-bar" role="img" [attr.aria-label]="'XP: ' + slotVm.slot.exp + ' out of 5'">
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 1"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 2"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 3"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 4"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 5"></span>
                        </span>
                      </span>
                    </span>
                  </div>
                </div>
              </div>

              <div class="fight-event" [class.fight-event-random]="frameVm.frame.randomEvent">
                <div class="fight-event-type">{{ frameVm.frame.type }}</div>
                <div class="fight-event-text">
                  <ng-container *ngIf="app.currentFightAnimationLogRow as logRow; else fallbackFightEventText">
                    <span [ngClass]="logRow.classes">
                      <ng-container *ngFor="let part of logRow.parts; trackBy: app.trackByIndex">
                        <img *ngIf="part.type === 'img'" [ngSrc]="part.src" class="log-pet-icon" [alt]="part.alt"
                          width="18" height="18" loading="lazy" decoding="async" />
                        <span *ngIf="part.type === 'text'" [ngClass]="part.className">{{ part.text }}</span>
                        <br *ngIf="part.type === 'br'" />
                      </ng-container>
                    </span>
                  </ng-container>
                  <ng-template #fallbackFightEventText>
                    {{ frameVm.frame.text }}
                  </ng-template>
                </div>
                <div class="fight-event-step">
                  Step {{ app.fightAnimationFrameIndex + 1 }} / {{ app.fightAnimationFrames.length }}
                </div>
              </div>

              <div class="fight-team fight-team-player fight-team-player-head-to-head">
                <div class="fight-team-toy-wrap">
                  <img *ngIf="frameVm.frame.playerToyName" [ngSrc]="app.getToyIconPath(frameVm.frame.playerToyName)"
                    class="fight-team-toy" [alt]="frameVm.frame.playerToyName + ' toy'" width="24" height="24" loading="lazy" decoding="async" />
                  <img *ngIf="frameVm.frame.playerHardToyName" [ngSrc]="app.getToyIconPath(frameVm.frame.playerHardToyName)"
                    class="fight-team-toy fight-team-toy-hard" [alt]="frameVm.frame.playerHardToyName + ' hard toy'" width="24" height="24" loading="lazy" decoding="async" />
                </div>
                <div class="fight-slot" *ngFor="let slotVm of frameVm.playerSlots; trackBy: app.trackByIndex"
                  [ngClass]="slotVm.classMap" [style.--fight-shift-steps]="slotVm.shiftSteps">
                  <div class="fight-slot-label">{{ slotVm.slot.label || ('P' + (slotVm.slot.slot + 1)) }}</div>
                  <div class="fight-slot-art">
                    <img *ngIf="slotVm.slot.petIconSrc" [ngSrc]="slotVm.slot.petIconSrc" class="fight-slot-icon"
                      [alt]="slotVm.slot.petName || 'Player pet'" width="42" height="42" loading="lazy" decoding="async" />
                    <img *ngIf="slotVm.slot.petCompanionIconSrc" [ngSrc]="slotVm.slot.petCompanionIconSrc" class="fight-slot-companion"
                      [alt]="slotVm.slot.petCompanionName || 'Companion pet'" width="16" height="16" loading="lazy"
                      decoding="async" />
                    <span *ngIf="!slotVm.slot.petIconSrc" class="fight-slot-empty">___</span>
                    <img *ngIf="slotVm.slot.equipmentIconSrc" [ngSrc]="slotVm.slot.equipmentIconSrc" class="fight-slot-equipment"
                      [alt]="slotVm.slot.equipmentName || 'Equipment'" width="16" height="16" loading="lazy" decoding="async" />
                    <div class="fight-equipment-ghost" *ngIf="slotVm.removedEquipment as removedEquipment">
                      <img *ngIf="removedEquipment.equipmentIconSrc" [ngSrc]="removedEquipment.equipmentIconSrc"
                        class="fight-equipment-ghost-icon" [alt]="(removedEquipment.equipmentName || 'Equipment') + ' removed'" width="16"
                        height="16" loading="lazy" decoding="async" />
                    </div>
                    <div class="fight-equipment-gain-ghost" *ngIf="slotVm.addedEquipment as addedEquipment">
                      <img *ngIf="addedEquipment.equipmentIconSrc" [ngSrc]="addedEquipment.equipmentIconSrc"
                        class="fight-equipment-gain-icon" [alt]="(addedEquipment.equipmentName || 'Equipment') + ' added'" width="16"
                        height="16" loading="lazy" decoding="async" />
                    </div>
                    <div class="fight-snipe-impact" *ngIf="slotVm.showSnipeImpact">
                      <img [ngSrc]="app.fightSnipeIconSrc" class="fight-snipe-impact-icon" alt="" aria-hidden="true"
                        width="20" height="20" loading="lazy" decoding="async" />
                    </div>
                    <ng-container *ngFor="let popup of slotVm.popups; index as popupIndex; trackBy: app.trackByIndex">
                      <span class="fight-value-popup"
                        [class.fight-value-popup-damage]="popup.type === 'damage'"
                        [class.fight-value-popup-trumpets]="popup.type === 'trumpets'"
                        [class.fight-value-popup-buff]="popup.type !== 'damage' && popup.delta > 0"
                        [class.fight-value-popup-debuff]="popup.type !== 'damage' && popup.delta < 0"
                        [style.--fight-popup-index]="popupIndex">
                        <img *ngIf="popup.type === 'attack' || popup.type === 'health' || popup.type === 'exp' || popup.type === 'mana' || popup.type === 'trumpets'"
                          [ngSrc]="popup.type === 'attack'
                            ? app.fightAttackIconSrc
                            : popup.type === 'health'
                              ? app.fightHealthIconSrc
                              : popup.type === 'exp'
                                ? app.fightExpIconSrc
                                : popup.type === 'mana'
                                  ? app.fightManaIconSrc
                                  : app.fightTrumpetIconSrc"
                          class="fight-value-popup-icon" alt="" aria-hidden="true" width="14" height="14" loading="lazy"
                          decoding="async" />
                        <span class="fight-value-popup-number">{{ (popup.delta > 0 ? '+' : '-') + (popup.delta > 0 ? popup.delta : -popup.delta) }}</span>
                      </span>
                    </ng-container>
                    <div class="fight-faint-ghost" *ngIf="slotVm.death as death">
                      <img *ngIf="death.petIconSrc" [ngSrc]="death.petIconSrc" class="fight-faint-icon"
                        [alt]="death.petName || 'Fainted pet'" width="40" height="40" loading="lazy" decoding="async" />
                      <img *ngIf="death.petCompanionIconSrc" [ngSrc]="death.petCompanionIconSrc" class="fight-faint-companion"
                        [alt]="death.petCompanionName || 'Fainted companion'" width="14" height="14" loading="lazy"
                        decoding="async" />
                    </div>
                  </div>
                  <div class="fight-slot-stats" *ngIf="slotVm.slot.attack != null || slotVm.slot.health != null || slotVm.slot.exp != null || slotVm.slot.mana != null">
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.attack != null">
                      <img [ngSrc]="app.fightAttackIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.attack }}</span>
                    </span>
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.health != null">
                      <img [ngSrc]="app.fightHealthIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.health }}</span>
                    </span>
                    <span class="fight-slot-stat" *ngIf="slotVm.slot.mana != null">
                      <img [ngSrc]="app.fightManaIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span>{{ slotVm.slot.mana }}</span>
                    </span>
                    <span class="fight-slot-stat fight-slot-exp" *ngIf="slotVm.slot.exp != null">
                      <img [ngSrc]="app.fightExpIconSrc" class="fight-slot-stat-icon" alt="" aria-hidden="true"
                        width="14" height="14" loading="lazy" decoding="async" />
                      <span class="fight-slot-exp-group">
                        <span class="fight-slot-exp-levels" aria-hidden="true">
                          <span class="fight-slot-exp-level">L1</span>
                          <span></span>
                          <span class="fight-slot-exp-level">L2</span>
                          <span></span>
                          <span class="fight-slot-exp-level">L3</span>
                        </span>
                        <span class="fight-slot-exp-bar" role="img" [attr.aria-label]="'XP: ' + slotVm.slot.exp + ' out of 5'">
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 1"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 2"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 3"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 4"></span>
                          <span class="fight-slot-exp-segment" [class.selected]="(slotVm.slot.exp ?? 0) >= 5"></span>
                        </span>
                      </span>
                    </span>
                  </div>
                </div>
              </div>
              </div>

              <div class="fight-controls">
              <div class="btn-group btn-group-sm" role="group" aria-label="Animation controls">
                <button class="btn btn-outline-secondary" type="button" (click)="app.resetFightAnimation()"
                  [disabled]="app.fightAnimationFrames.length === 0">
                  Reset
                </button>
                <button class="btn btn-outline-secondary" type="button" (click)="app.stepFightAnimation(-1)"
                  [disabled]="app.fightAnimationFrameIndex <= 0">
                  Prev
                </button>
                <button class="btn btn-outline-primary" type="button" (click)="app.toggleFightAnimationPlayback()"
                  [disabled]="app.fightAnimationFrames.length === 0">
                  {{ app.fightAnimationPlaying ? 'Pause' : 'Play' }}
                </button>
                <button class="btn btn-outline-secondary" type="button" (click)="app.stepFightAnimation(1)"
                  [disabled]="app.fightAnimationFrameIndex >= app.fightAnimationFrames.length - 1">
                  Next
                </button>
              </div>

              <div class="btn-group btn-group-sm fight-speed-controls" role="group" aria-label="Animation speed">
                <button *ngFor="let speed of app.fightAnimationSpeedOptions; trackBy: app.trackByIndex"
                  class="btn btn-outline-secondary" type="button" [class.active]="app.fightAnimationSpeed === speed"
                  (click)="app.setFightAnimationSpeed(speed)">
                  {{ speed }}x
                </button>
              </div>
                </div>

                <div class="fight-scrubber">
                  <input class="form-range" type="range" [min]="0" [max]="app.fightAnimationFrames.length - 1"
                    [value]="app.fightAnimationFrameIndex" (input)="app.onFightAnimationScrub($any($event.target).value)" />
                </div>
            </ng-container>
          </div>

          <div class="horizontal-resize-divider" role="separator" aria-label="Resize animation and logs"
            aria-orientation="horizontal" tabindex="0" (pointerdown)="onAnimationDividerPointerDown($event)"
            (pointermove)="onAnimationDividerPointerMove($event)" (pointerup)="onAnimationDividerPointerUp($event)"
            (pointercancel)="onAnimationDividerPointerUp($event)" (keydown)="onAnimationDividerKeyDown($event)"></div>

          <div class="animation-bottom-pane">
            <ng-container *ngTemplateOutlet="logsView"></ng-container>
          </div>
        </div>

        <ng-template #noAnimationFrames>
          <div class="fight-empty-state">
            No animation frames found for this battle. Enable logs and run at least one simulation.
          </div>
        </ng-template>

        <ng-template #logsView>
          <div *ngIf="app.showBattleAnalysis; else logsOnlyView" class="vertical-resizable-stack logs-analysis-stack"
            #logsAnalysisSplitContainer>
            <div class="log-container scroll logs-top-pane"
              [style.flex-basis.px]="logsTopHeightPx"
              [style.max-height.px]="logsTopHeightPx"
              [style.height.px]="logsTopHeightPx"
              [class.log-container-with-analysis]="app.showBattleAnalysis">
              <ng-container *ngTemplateOutlet="groupedLogsTemplate"></ng-container>
            </div>

            <div class="horizontal-resize-divider" role="separator" aria-label="Resize logs and analysis"
              aria-orientation="horizontal" tabindex="0" (pointerdown)="onLogsAnalysisDividerPointerDown($event)"
              (pointermove)="onLogsAnalysisDividerPointerMove($event)" (pointerup)="onLogsAnalysisDividerPointerUp($event)"
              (pointercancel)="onLogsAnalysisDividerPointerUp($event)" (keydown)="onLogsAnalysisDividerKeyDown($event)"></div>

            <div class="analysis-bottom-pane">
              <div class="vertical-resizable-stack analysis-sections-stack" #analysisSplitContainer>
                <div class="analysis-section mt-2 timeline-top-pane"
                  [style.flex-basis.px]="timelineTopHeightPx"
                  [style.max-height.px]="timelineTopHeightPx"
                  [style.height.px]="timelineTopHeightPx">
                  <h4 class="analysis-title">Trigger Timeline</h4>
                  <div class="analysis-table-wrap scroll">
                    <table class="table table-sm analysis-table mb-0">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Source</th>
                          <th>Target</th>
                          <th>Reason</th>
                          <th>Event</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let row of app.viewBattleTimelineRows; trackBy: app.trackByIndex" [ngClass]="[
                            row.side === 'player' ? 'timeline-player' : '',
                            row.side === 'opponent' ? 'timeline-opponent' : '',
                            row.reason === 'true random' ? 'timeline-random' : '',
                            row.reason === 'tie-broken' ? 'timeline-tie' : '',
                            row.reason === 'deterministic' ? 'timeline-deterministic' : ''
                          ]">
                          <td>{{ row.step }}</td>
                          <td>{{ row.source }}</td>
                          <td>{{ row.target }}</td>
                          <td>{{ row.reason }}</td>
                          <td>{{ row.text }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="horizontal-resize-divider" role="separator" aria-label="Resize trigger timeline and battle diff"
                  aria-orientation="horizontal" tabindex="0" (pointerdown)="onAnalysisDividerPointerDown($event)"
                  (pointermove)="onAnalysisDividerPointerMove($event)" (pointerup)="onAnalysisDividerPointerUp($event)"
                  (pointercancel)="onAnalysisDividerPointerUp($event)" (keydown)="onAnalysisDividerKeyDown($event)"></div>

                <div class="analysis-section mt-2 diff-bottom-pane scroll">
                  <h4 class="analysis-title">Battle Diff</h4>
                  <div class="diff-controls">
                    <label class="diff-label">
                      Left
                      <select class="form-select form-select-sm diff-select" [ngModel]="app.diffBattleLeftIndex"
                        (ngModelChange)="app.setBattleDiffLeft($event)" [ngModelOptions]="{ standalone: true }">
                        <option *ngFor="let battle of app.battles; index as i; trackBy: app.trackByIndex" [ngValue]="i">
                          {{ i }} ({{ battle.winner }})
                        </option>
                      </select>
                    </label>
                    <label class="diff-label">
                      Left Scope
                      <select class="form-select form-select-sm diff-select" [ngModel]="app.diffBattleLeftScope"
                        (ngModelChange)="app.setBattleDiffLeftScope($event)" [ngModelOptions]="{ standalone: true }">
                        <option [ngValue]="'all'">All</option>
                        <option [ngValue]="'player'" class="player-side-text">Player</option>
                        <option [ngValue]="'opponent'" class="opponent-side-text">Opponent</option>
                      </select>
                    </label>
                    <label class="diff-label">
                      Right
                      <select class="form-select form-select-sm diff-select" [ngModel]="app.diffBattleRightIndex"
                        (ngModelChange)="app.setBattleDiffRight($event)" [ngModelOptions]="{ standalone: true }">
                        <option *ngFor="let battle of app.battles; index as i; trackBy: app.trackByIndex" [ngValue]="i">
                          {{ i }} ({{ battle.winner }})
                        </option>
                      </select>
                    </label>
                    <label class="diff-label">
                      Right Scope
                      <select class="form-select form-select-sm diff-select" [ngModel]="app.diffBattleRightScope"
                        (ngModelChange)="app.setBattleDiffRightScope($event)" [ngModelOptions]="{ standalone: true }">
                        <option [ngValue]="'all'">All</option>
                        <option [ngValue]="'player'" class="player-side-text">Player</option>
                        <option [ngValue]="'opponent'" class="opponent-side-text">Opponent</option>
                      </select>
                    </label>
                  </div>
                  <div class="diff-summary">
                    Equal: {{ app.battleDiffSummary.equalSteps }} |
                    Changed: {{ app.battleDiffSummary.changedSteps }} |
                    Left Only: {{ app.battleDiffSummary.leftOnly }} |
                    Right Only: {{ app.battleDiffSummary.rightOnly }}
                  </div>
                  <div class="analysis-table-wrap scroll">
                    <table class="table table-sm analysis-table mb-0">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Left</th>
                          <th>Right</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let row of app.battleDiffRows; trackBy: app.trackByIndex" [ngClass]="{
                            'diff-same': row.kind === 'same',
                            'diff-changed': row.kind === 'changed',
                            'diff-left-only': row.kind === 'left-only',
                            'diff-right-only': row.kind === 'right-only'
                          }">
                          <td>{{ row.step }}</td>
                          <td>{{ row.left }}</td>
                          <td>{{ row.right }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <ng-template #logsOnlyView>
            <div class="log-container flex-1 scroll">
              <ng-container *ngTemplateOutlet="groupedLogsTemplate"></ng-container>
            </div>
          </ng-template>
        </ng-template>

        <ng-template #groupedLogsTemplate>
          <div class="log-groups" *ngIf="app.viewBattleLogGroups.length; else noFilteredLogs">
            <section class="log-group" *ngFor="let group of app.viewBattleLogGroups; trackBy: app.trackByIndex">
              <button
                type="button"
                class="log-group-header"
                [attr.aria-expanded]="!group.collapsed"
                (click)="app.toggleViewBattleLogGroup(group.id)"
              >
                <span class="log-group-title">{{ group.title }}</span>
                <span class="log-group-meta">
                  <span class="log-group-count">{{ group.rows.length }} rows</span>
                  <span class="log-group-chevron" [class.log-group-chevron-collapsed]="group.collapsed" aria-hidden="true">
                    &#9662;
                  </span>
                </span>
              </button>
              <div class="log-group-body" *ngIf="!group.collapsed">
                <div class="log-row" *ngFor="let log of group.rows; trackBy: app.trackByIndex" [ngClass]="log.classes">
                  <div class="log-row-meta">
                    <span class="log-badge" *ngFor="let badge of log.badges; trackBy: app.trackByIndex" [ngClass]="badge.className">
                      {{ badge.text }}
                    </span>
                  </div>
                  <div class="log-row-text">
                    <ng-container *ngFor="let part of log.parts; trackBy: app.trackByIndex">
                      <img *ngIf="part.type === 'img'" [ngSrc]="part.src" class="log-pet-icon" [alt]="part.alt" width="18"
                        height="18" loading="lazy" decoding="async" />
                      <span *ngIf="part.type === 'text'" [ngClass]="part.className">{{ part.text }}</span>
                      <br *ngIf="part.type === 'br'" />
                    </ng-container>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </ng-template>

        <ng-template #noFilteredLogs>
          <div class="log-empty-state">
            No log rows match this filter.
          </div>
        </ng-template>
        </div>
      </div>
    </div>
