<ng-container *ngIf="api">
  <div id="apiResponse">{{ apiResponse }}</div>
</ng-container>
<ng-container *ngIf="!api">
  <div class="container-fluid app-wrapper flex-col" [formGroup]="formGroup" [ngClass]="lapsusTypographyStageClass" #container>
    <div class="row battle-row pb-5 pt-3" [style.background-image]="
        battleBackgroundUrl ? 'url(' + battleBackgroundUrl + ')' : ''
      ">
      <div class="col-12 col-xl-6 px-4 mb-2 mb-xl-0">
        <div class="d-flex justify-content-between">
          <div class="d-flex align-items-center toy-wrap">
            <h2 class="me-2" style="color: #5fbf5f">Player</h2>
            <div class="toy-row">
              <div class="toy-slot">
                <button type="button" class="toy-select-btn" (click)="openSelectionDialog('toy', 'player')">
                  <img *ngIf="playerToyImageUrl" class="toy-art" [ngSrc]="playerToyImageUrl" width="36" height="36"
                    loading="lazy" decoding="async" alt="Player Toy" />
                  <span class="toy-label">{{
                    formGroup.get("playerToy").value || "Select Toy"
                    }}</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="toy-level-controls inline" *ngIf="playerToyImageUrl">
                  <button
                    type="button"
                    class="toy-level-btn"
                    (click)="decrementToyLevel('player')"
                    title="Decrease level"
                    aria-label="Decrease player toy level"
                  >
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="toy-level-label">Lv{{ formGroup.get("playerToyLevel").value }}</span>
                  <button
                    type="button"
                    class="toy-level-btn"
                    (click)="incrementToyLevel('player')"
                    title="Increase level"
                    aria-label="Increase player toy level"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="toy-slot">
                <button type="button" class="toy-select-btn" (click)="openSelectionDialog('hard-toy', 'player')">
                  <img *ngIf="playerHardToyImageUrl" class="toy-art hard-toy-art" [ngSrc]="playerHardToyImageUrl"
                    width="36" height="36" loading="lazy" decoding="async" alt="Player Hard Toy" />
                  <span class="toy-label">{{
                    formGroup.get("playerHardToy").value || "Hard Toy"
                    }}</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <button type="button" *ngIf="playerHardToyImageUrl" class="toy-remove-btn-inline"
                  (click)="removeHardToy('player')" title="Remove hard toy" aria-label="Remove player hard toy">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          <button class="btn glass-btn mb-1" (click)="resetPlayer('player')">
            Reset
          </button>
        </div>
        <div class="card p-2 player-card">
          <!-- <div class="back">BACK</div> -->
          <div class="row row-cols-1 row-cols-md-5 g-0" cdkDropList cdkDropListOrientation="horizontal"
            (cdkDropListDropped)="drop($event, 'player')">
            <div class="col drag-container mb-2 mb-md-0 px-0" *ngFor="
                let pet of playerPetsControls;
                index as i;
                trackBy: trackByIndex
              " cdkDrag (mousedown)="setActivePetSlot('player', 4 - i)"
              (focusin)="setActivePetSlot('player', 4 - i)"
              [class.pet-slot-active]="
                activePetSlot?.side === 'player' && activePetSlot?.index === 4 - i
              ">
              <div class="pet-slot-actions">
                <button type="button" class="pet-clear-btn"
                  (click)="playerPetSelector.removePet(); $event.stopPropagation()"
                  title="Clear this pet selector" aria-label="Clear this pet selector">
                  X
                </button>
              </div>
              <app-pet-selector [pet]="player.getPet(4 - i)" [player]="player" [opponent]="opponent" [index]="4 - i"
                #playerPetSelector
                [formGroup]="makeFormGroup(pet)" [ailments]="true" [allPets]="formGroup.get('allPets').value"
                [mana]="formGroup.get('mana').value" [triggersConsumed]="formGroup.get('triggersConsumed').value"
                [allowEquipmentUseOverrides]="
                  formGroup.get('changeEquipmentUses').value
                " [showTokenPets]="formGroup.get('tokenPets').value" [flipImage]="true"
                [customPacks]="formGroup.get('customPacks')" [showSwallowedLevels]="
                  formGroup.get('showSwallowedLevels').value
                "></app-pet-selector>
            </div>
          </div>
          <!-- <div class="front">FRONT</div> -->
        </div>
      </div>
      <div class="col-12 col-xl-6 px-4">
        <div class="d-flex justify-content-between">
          <div class="d-flex align-items-center toy-wrap">
            <h2 class="me-2" style="color: #e06a6a">Opponent</h2>
            <div class="toy-row">
              <div class="toy-slot">
                <button type="button" class="toy-select-btn" (click)="openSelectionDialog('toy', 'opponent')">
                  <img *ngIf="opponentToyImageUrl" class="toy-art" [ngSrc]="opponentToyImageUrl" width="36" height="36"
                    loading="lazy" decoding="async" alt="Opponent Toy" />
                  <span class="toy-label">{{
                    formGroup.get("opponentToy").value || "Select Toy"
                    }}</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="toy-level-controls inline" *ngIf="opponentToyImageUrl">
                  <button
                    type="button"
                    class="toy-level-btn"
                    (click)="decrementToyLevel('opponent')"
                    title="Decrease level"
                    aria-label="Decrease opponent toy level"
                  >
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="toy-level-label">Lv{{ formGroup.get("opponentToyLevel").value }}</span>
                  <button
                    type="button"
                    class="toy-level-btn"
                    (click)="incrementToyLevel('opponent')"
                    title="Increase level"
                    aria-label="Increase opponent toy level"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="toy-slot">
                <button type="button" class="toy-select-btn" (click)="openSelectionDialog('hard-toy', 'opponent')">
                  <img *ngIf="opponentHardToyImageUrl" class="toy-art hard-toy-art" [ngSrc]="opponentHardToyImageUrl"
                    width="36" height="36" loading="lazy" decoding="async" alt="Opponent Hard Toy" />
                  <span class="toy-label">{{
                    formGroup.get("opponentHardToy").value || "Hard Toy"
                    }}</span>
                  <i class="fas fa-chevron-down"></i>
                </button>
                <button type="button" *ngIf="opponentHardToyImageUrl" class="toy-remove-btn-inline"
                  (click)="removeHardToy('opponent')" title="Remove hard toy" aria-label="Remove opponent hard toy">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
          <button class="btn glass-btn mb-1" (click)="resetPlayer('opponent')">
            Reset
          </button>
        </div>

        <div class="card p-2 player-card ml-auto">
          <!-- <div class="front">FRONT</div> -->
          <div class="row row-cols-1 row-cols-md-5 g-0" cdkDropList cdkDropListOrientation="horizontal"
            (cdkDropListDropped)="drop($event, 'opponent')">
            <div class="col drag-container mb-2 mb-sm-0 px-0" *ngFor="
                let pet of opponentPetsControls;
                index as i;
                trackBy: trackByIndex
              " cdkDrag (mousedown)="setActivePetSlot('opponent', i)"
              (focusin)="setActivePetSlot('opponent', i)"
              [class.pet-slot-active]="
                activePetSlot?.side === 'opponent' && activePetSlot?.index === i
              ">
              <div class="pet-slot-actions">
                <button type="button" class="pet-clear-btn"
                  (click)="opponentPetSelector.removePet(); $event.stopPropagation()"
                  title="Clear this pet selector" aria-label="Clear this pet selector">
                  X
                </button>
              </div>
              <app-pet-selector [pet]="opponent.getPet(i)" [player]="opponent" [opponent]="player" [index]="i"
                #opponentPetSelector
                [formGroup]="makeFormGroup(pet)" [ailments]="true" [allPets]="formGroup.get('allPets').value"
                [mana]="formGroup.get('mana').value" [triggersConsumed]="formGroup.get('triggersConsumed').value"
                [allowEquipmentUseOverrides]="
                  formGroup.get('changeEquipmentUses').value
                " [showTokenPets]="formGroup.get('tokenPets').value" [customPacks]="formGroup.get('customPacks')"
                [showSwallowedLevels]="
                  formGroup.get('showSwallowedLevels').value
                "></app-pet-selector>
            </div>
          </div>
          <!-- <div class="back">BACK</div> -->
        </div>
      </div>
    </div>

    <app-shell-controls [app]="app"></app-shell-controls>

    <app-shell-battle-results [app]="app"></app-shell-battle-results>
  </div>
  <!-- Custom Pack -->
  <div class="modal fade custom-pack-editor-modal" id="customPackEditor" tabindex="-1" aria-labelledby="customPackEditorLabel" aria-hidden="true"
    #customPackEditor>
    <div class="modal-dialog modal-lg custom-pack-editor-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="customPackEditorLabel">
            Custom Pack Editor
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <app-custom-pack-editor [formGroup]="formGroup"></app-custom-pack-editor>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="info" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Guide</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          @defer (when showInfo) {
          <app-info></app-info>
          } @placeholder {
          <div class="text-muted">Loading info…</div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="import" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="importModalLabel">
            Import
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          @defer (when showImport) {
          <app-import-calculator [importFunc]="importForDialog"></app-import-calculator>
          } @placeholder {
          <div class="text-muted">Loading import tools…</div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="export" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exportModalLabel">
            Export
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          @defer (when showExport) {
          <app-export-calculator [formGroup]="formGroup"></app-export-calculator>
          } @placeholder {
          <div class="text-muted">Loading export tools…</div>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="reportABug" tabindex="-1" aria-labelledby="reportABugLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="reportABugLabel">Report A Bug</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          @defer (when showReportABug) {
          <app-report-a-bug [calcFormGroup]="formGroup"></app-report-a-bug>
          } @placeholder {
          <div class="text-muted">Loading report form…</div>
          }
        </div>
      </div>
    </div>
  </div>
</ng-container>

<app-item-selection-dialog *ngIf="showSelectionDialog" [ngClass]="lapsusTypographyStageClass" [type]="selectionType"
  [showAllPets]="formGroup.get('allPets').value" [customPacks]="formGroup.get('customPacks')" [savedTeams]="savedTeams"
  (select)="onItemSelected($event)" (close)="showSelectionDialog = false">
</app-item-selection-dialog>

