"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[908],{3908(Te,Y,c){c.d(Y,{ImportCalculatorComponent:()=>ye});var K=c(467),A=c(9769),P=c(5119),V=c(4421),F=c(1080);const z=(()=>{function r(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return r.prototype=Object.create(Error.prototype),r})();var f=c(3004);class J{constructor(t,e,a,o){this.waitFor=t,this.absoluteTimeout=e,this.withObservable=a,this.scheduler=o}call(t,e){return e.subscribe(new T(t,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class T extends f.gn{constructor(t,e,a,o,l){super(t),this.absoluteTimeout=e,this.waitFor=a,this.withObservable=o,this.scheduler=l,this.scheduleTimeout()}static dispatchTimeout(t){const{withObservable:e}=t;t._unsubscribeAndRecycle(),t.add((0,f.tS)(e,new f.zA(t)))}scheduleTimeout(){const{action:t}=this;t?this.action=t.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(T.dispatchTimeout,this.waitFor,this))}_next(t){this.absoluteTimeout||this.scheduleTimeout(),super._next(t)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}var M=c(7389);function Z({error:r,subscriber:t}){t.error(r)}function k(r,t=F.b){return function X(r,t,e=F.b){return a=>{let o=function W(r){return r instanceof Date&&!isNaN(+r)}(r),l=o?+r-e.now():Math.abs(r);return a.lift(new J(l,o,t,e))}}(r,function Q(r,t){return new M.c(t?e=>t.schedule(Z,0,{error:r,subscriber:e}):e=>e.error(r))}(new z),t)}var I=c(7312);class _{constructor(t){this.selector=t}call(t,e){return e.subscribe(new ee(t,this.selector,this.caught))}}class ee extends f.gn{constructor(t,e,a){super(t),this.selector=e,this.caught=a}error(t){if(!this.isStopped){let e;try{e=this.selector(t,this.caught)}catch(l){return void super.error(l)}this._unsubscribeAndRecycle();const a=new f.zA(this);this.add(a);const o=(0,f.tS)(e,a);o!==a&&this.add(o)}}}function v(r){return`${function oe(r){return r.endsWith("/")?r.slice(0,-1):r}("https://www.sap-calculator.com/api")}${r}`}var i=c(5547),re=c(7705),E=c(8935),ae=c.t(E,2),R=c(7283),ne=c.t(R,2),N=c(3276),le=c.t(N,2);const L=new Map,O=new Map;(N??le).forEach(r=>{const t=String(r.Id),e=Number(r.Tier);L.set(t,r.Name),Number.isFinite(e)&&O.set(t,{name:r.Name,tier:e})});const se=R??ne,ue=new Map((E??ae).map(r=>[String(r.Id),r.Name])),pe=new Map(se.map(r=>[String(r.Id),r.Name])),$={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},ce={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const r={};for(let t=1;t<=3;t++){const e=`parrotCopyPetAbominationSwallowedPet${t}`,a=`pCPAS${t}`;r[e]=a,r[`${e}BelugaSwallowedPet`]=`${a}B`,r[`${e}Level`]=`${a}L`,r[`${e}TimesHurt`]=`${a}T`,r[`${e}ParrotCopyPet`]=`${a}PCP`,r[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${a}PCPB`;for(let o=1;o<=3;o++){const l=`${e}ParrotCopyPetAbominationSwallowedPet${o}`,n=`${a}PCPAS${o}`;r[l]=n,r[`${l}BelugaSwallowedPet`]=`${n}B`,r[`${l}Level`]=`${n}L`,r[`${l}TimesHurt`]=`${n}T`}}return r})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};function g(r){return"number"==typeof r&&Number.isFinite(r)?r:null}function d(r,t){return g(r)??t}class Pe{parseReplayForCalculator(t,e,a){const o=t?.UserBoard??a?.userBoard,l=t?.OpponentBoard??a?.opponentBoard,n=(p,S,h)=>d(p?.[S],h),m=p=>{const S=(p?.Mins?.Items??[]).filter(y=>null!==y),h=Array(5).fill(null);return S.forEach((y,C)=>{let w=g(y.Poi?.x);null===w&&(w=C),w>=0&&w<5&&(h[w]=(p=>{if(!p)return null;const S=String(p.Enu??0),h=d(p.At?.Temp,0),y=d(p.Hp?.Temp,0);let C=null;if("182"===S){const b=p?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(b.length>0){const U=b[0]?.Enu;C=L.get(String(U))||`Pet #${U}`}}const w=(p=>g(p?.Pow?.SabertoothTigerAbility))(p),D=(p?.Abil??[]).map(b=>g(b?.TrCo)).filter(b=>null!==b),j={name:L.get(S)||null,attack:d(p.At?.Perm,0)+h,health:d(p.Hp?.Perm,0)+y,exp:d(p.Exp,0),equipment:p.Perk?{name:ue.get(String(p.Perk))||"Unknown Perk"}:null,mana:d(p.Mana,0),belugaSwallowedPet:C,sarcasticFringeheadSwallowedPet:null,abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1,battlesFought:0,triggersConsumed:D.length>0?Math.max(...D):0};return null!==w&&(j.timesHurt=w),j})(y))}),h.reverse()},G=p=>{const S=(p?.Rel?.Items??[]).find(h=>!!h?.Enu);if(S){const h=String(S.Enu);return{name:pe.get(h)||null,level:d(S.Lvl,1)}}return{name:null,level:1}},H=G(o),x=G(l),B=this.buildCustomPacksFromGenesis(e,t),be=this.findCustomPackFromDeck(B,o?.Deck),ge=this.findCustomPackFromDeck(B,l?.Deck);return{playerPack:$[d(o?.Pack,NaN)]||be?.name||"Turtle",opponentPack:$[d(l?.Pack,NaN)]||ge?.name||"Turtle",playerToy:H.name,playerToyLevel:String(H.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:x.name,opponentToyLevel:String(x.level),opponentHardToy:null,opponentHardToyLevel:1,turn:n(o,"Tur",1)||1,playerGoldSpent:n(o,"GoSp",0)||0,opponentGoldSpent:n(l,"GoSp",0)||0,playerRollAmount:n(o,"Rold",0)||0,opponentRollAmount:n(l,"Rold",0)||0,playerSummonedAmount:n(o,"MiSu",0)||0,opponentSummonedAmount:n(l,"MiSu",0)||0,playerLevel3Sold:n(o,"MSFL",0)||0,opponentLevel3Sold:n(l,"MSFL",0)||0,playerTransformationAmount:n(o,"TrTT",0)||0,opponentTransformationAmount:n(l,"TrTT",0)||0,playerPets:m(o),opponentPets:m(l),allPets:!1,logFilter:null,customPacks:B,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(t,e){const a=[t?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(s=>null!=s&&Array.isArray(s.Minions)),o=[],l=new Set,n=new Set;for(const s of a){const u=s?.Id?String(s.Id):null;if(u&&l.has(u))continue;u&&l.add(u);const m=this.buildCustomPackFromDeck(s,n);m&&o.push({...m,deckId:u})}return o}generateCalculatorLink(t){const e=window.location.origin+window.location.pathname,a=this.stripDefaultValues(t),o=this.truncateKeys(a),l=JSON.stringify(o);return`${e}#c=${btoa(l)}`}buildCustomPackFromDeck(t,e){if(!t||!Array.isArray(t.Minions))return null;const a=t.Minions.map(u=>String(u)),o=Array.isArray(t.Spells)?t.Spells.map(String):[],l={1:[],2:[],3:[],4:[],5:[],6:[]};for(const u of a){const m=O.get(u);m&&l[m.tier]&&l[m.tier].push(m.name)}const n=u=>{const m=u.slice(0,10);for(;m.length<10;)m.push(null);return m};let s=t.Title||"Custom Pack";if(e.has(s)){let u=2;for(;e.has(`${s} (${u})`);)u+=1;s=`${s} (${u})`}return e.add(s),{name:s,tier1Pets:n(l[1]),tier2Pets:n(l[2]),tier3Pets:n(l[3]),tier4Pets:n(l[4]),tier5Pets:n(l[5]),tier6Pets:n(l[6]),spells:o}}findCustomPackFromDeck(t,e){if(!e)return null;const a=e?.Id?String(e.Id):null;if(a){const l=t.find(n=>n.deckId===a);if(l)return l}const o=e?.Title;return o&&t.find(l=>l.name===o)||null}stripDefaultValues(t){const e={};"Turtle"!==t.playerPack&&(e.playerPack=t.playerPack),"Turtle"!==t.opponentPack&&(e.opponentPack=t.opponentPack),t.playerToy&&(e.playerToy=t.playerToy),t.playerToyLevel&&"1"!==t.playerToyLevel&&(e.playerToyLevel=t.playerToyLevel),t.opponentToy&&(e.opponentToy=t.opponentToy),t.opponentToyLevel&&"1"!==t.opponentToyLevel&&(e.opponentToyLevel=t.opponentToyLevel),11!==t.turn&&(e.turn=t.turn),10!==t.playerGoldSpent&&(e.playerGoldSpent=t.playerGoldSpent),10!==t.opponentGoldSpent&&(e.opponentGoldSpent=t.opponentGoldSpent),4!==t.playerRollAmount&&(e.playerRollAmount=t.playerRollAmount),4!==t.opponentRollAmount&&(e.opponentRollAmount=t.opponentRollAmount),0!==t.playerSummonedAmount&&(e.playerSummonedAmount=t.playerSummonedAmount),0!==t.opponentSummonedAmount&&(e.opponentSummonedAmount=t.opponentSummonedAmount),0!==t.playerLevel3Sold&&(e.playerLevel3Sold=t.playerLevel3Sold),0!==t.opponentLevel3Sold&&(e.opponentLevel3Sold=t.opponentLevel3Sold),0!==t.playerTransformationAmount&&(e.playerTransformationAmount=t.playerTransformationAmount),0!==t.opponentTransformationAmount&&(e.opponentTransformationAmount=t.opponentTransformationAmount),t.allPets&&(e.allPets=!0),t.oldStork&&(e.oldStork=!0),t.tokenPets&&(e.tokenPets=!0),t.komodoShuffle&&(e.komodoShuffle=!0),t.mana&&(e.mana=!0),null!=t.seed&&(e.seed=t.seed),t.triggersConsumed&&(e.triggersConsumed=!0),t.foodsEaten&&(e.foodsEaten=!0),t.showAdvanced&&(e.showAdvanced=!0),t.showTriggerNamesInLogs&&(e.showTriggerNamesInLogs=!0),t.showSwallowedLevels&&(e.showSwallowedLevels=!0),t.ailmentEquipment&&(e.ailmentEquipment=!0),t.logFilter&&(e.logFilter=t.logFilter),t.customPacks.length>0&&(e.customPacks=t.customPacks);const a=n=>{if(!n||!n.name)return null;const s={name:n.name};return"number"==typeof n.attack&&0!==n.attack&&(s.attack=n.attack),"number"==typeof n.health&&0!==n.health&&(s.health=n.health),"number"==typeof n.exp&&0!==n.exp&&(s.exp=n.exp),"number"==typeof n.mana&&0!==n.mana&&(s.mana=n.mana),n.equipment&&(s.equipment=n.equipment),n.triggersConsumed&&(s.triggersConsumed=n.triggersConsumed),n.foodsEaten&&(s.foodsEaten=n.foodsEaten),null!=n.belugaSwallowedPet&&(s.belugaSwallowedPet=n.belugaSwallowedPet),n.timesHurt&&(s.timesHurt=n.timesHurt),s},o=t.playerPets.map(a);o.some(n=>null!==n)&&(e.playerPets=o);const l=t.opponentPets.map(a);return l.some(n=>null!==n)&&(e.opponentPets=l),e}truncateKeys(t){if(Array.isArray(t))return t.map(e=>this.truncateKeys(e));if(function me(r){return null!==r&&"object"==typeof r&&!Array.isArray(r)}(t)){const e={};for(const a of Object.keys(t))e[ce[a]||a]=this.truncateKeys(t[a]);return e}return t}}var de=c(7868);let Se=(()=>{class r{parser=new Pe;parseReplayForCalculator(e,a,o){return this.parser.parseReplayForCalculator(e,a,o)}buildCustomPacksFromGenesis(e,a){return this.parser.buildCustomPacksFromGenesis(e,a)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}static \u0275fac=function(a){return new(a||r)};static \u0275prov=de.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var he=c(6980);function we(r,t){if(1&r&&(i.j41(0,"div",10),i.EFF(1),i.k0s()),2&r){const e=i.XpG();i.Y8G("ngClass","success"===e.statusTone?"text-success":"text-danger"),i.R7$(),i.SpI(" ",e.statusMessage," ")}}function fe(r,t){if(1&r&&(i.j41(0,"div",11),i.EFF(1),i.k0s()),2&r){const e=i.XpG();i.R7$(),i.JRh(e.errorMessage)}}let ye=(()=>{class r{replayCalcService;http;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new P.gE({calcCode:new P.MJ(null,P.k0.required),turn:new P.MJ(1,P.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;statusTimer=null;constructor(e,a,o){this.replayCalcService=e,this.http=a,this.cdr=o}ngOnInit(){}submit(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode"),a=e?.value?.trim();if(!a)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let o;e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});try{o=JSON.parse(a)}catch{if(this.tryReplayPid(a))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((o?.Pid||o?.pid)&&!o?.Actions){const l=o?.Pid??o?.pid,n=Number(o?.T??o?.t??this.formGroup.get("turn").value);return!Number.isFinite(n)||n<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.checkReplayApiReachable().then(s=>{s?(console.info("[replay] health check ok, requesting battle"),this.http.post(v("/replay-battle"),{Pid:l,T:n}).pipe(k(this.replayTimeoutMs),(0,I.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:u=>{const m=u?.battle;m?this.importReplayBattle(m,u?.genesisBuildModel,void 0,{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:u=>{if("TimeoutError"===u?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=u?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})):this.setLoading(!1)}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(o?.UserBoard&&o?.OpponentBoard)this.importReplayBattle(o,o?.GenesisBuildModel,{userBoard:o?.UserBoard,opponentBoard:o?.OpponentBoard});else{if(o?.Actions){const l=Number(this.formGroup.get("turn").value??o?.T);if(!Number.isFinite(l)||l<=0)return void(this.errorMessage="Enter a valid turn number.");let n=0,s=null;for(const u of o.Actions)if(0===u?.Type&&u?.Battle&&(n+=1,n===l)){try{s=JSON.parse(u.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${l}.`)}break}return s?void this.importReplayBattle(s,o?.GenesisBuildModel,{userBoard:o?.UserBoard,opponentBoard:o?.OpponentBoard}):void(this.errorMessage=`No battle found for turn ${l}.`)}this.importFunc(a)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(e,a,o,l){const n=this.replayCalcService.parseReplayForCalculator(e,a,o);this.importFunc(JSON.stringify(n),l)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const a=e?.trim();if(!a||!/^[a-f0-9-]{16,}$/i.test(a)&&!/^\d+$/.test(a))return!1;const l=Number(this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.checkReplayApiReachable().then(n=>{n?(console.info("[replay] health check ok, requesting battle"),this.http.post(v("/replay-battle"),{Pid:a,T:l}).pipe(k(this.replayTimeoutMs),(0,I.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:s=>{const u=s?.battle;u?this.importReplayBattle(u,s?.genesisBuildModel,void 0,{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:s=>{if("TimeoutError"===s?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=s?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})):this.setLoading(!1)}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}checkReplayApiReachable(){var e=this;return(0,K.A)(function*(){return new Promise(a=>{console.info("[replay] health check start"),e.http.get(v("/health")).pipe(k(e.replayHealthTimeoutMs),function q(r){return function(e){const a=new _(r),o=e.lift(a);return a.caught=o}}(()=>(0,V.of)(null))).subscribe({next:o=>{if(!o)return e.errorMessage="Replay API is not reachable. Ensure the replay server is running.",console.info("[replay] health check failed"),e.cdr.markForCheck(),void a(!1);console.info("[replay] health check success"),a(!0)},error:()=>{e.errorMessage="Replay API is not reachable. Ensure the replay server is running.",console.info("[replay] health check error"),e.cdr.markForCheck(),a(!1)}})})})()}setLoading(e){this.loading=e,this.cdr.markForCheck()}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,a){this.statusMessage=e,this.statusTone=a,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(a){return new(a||r)(i.rXU(Se),i.rXU(he.Qq),i.rXU(re.gRc))};static \u0275cmp=i.VBU({type:r,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:19,vars:6,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(a,o){1&a&&(i.j41(0,"div",0)(1,"div",1),i.EFF(2," Paste calculator JSON or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),i.k0s(),i.j41(3,"div",1),i.EFF(4," Example Pid: "),i.j41(5,"code"),i.EFF(6),i.k0s()(),i.nrm(7,"textarea",2),i.j41(8,"div",3)(9,"div")(10,"label",4),i.EFF(11,"Turn (1-based)"),i.k0s(),i.nrm(12,"input",5),i.k0s(),i.j41(13,"button",6),i.bIt("click",function(){return o.submit()}),i.EFF(14),i.k0s()(),i.j41(15,"div",7),i.EFF(16," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),i.k0s(),i.DNE(17,we,2,2,"div",8)(18,fe,2,1,"div",9),i.k0s()),2&a&&(i.Y8G("formGroup",o.formGroup),i.R7$(6),i.JRh(o.pidExample),i.R7$(7),i.Y8G("disabled",o.loading),i.R7$(),i.SpI(" ",o.loading?"Fetching...":"Import"," "),i.R7$(3),i.Y8G("ngIf",o.statusMessage),i.R7$(),i.Y8G("ngIf",o.errorMessage))},dependencies:[A.MD,A.YU,A.bT,P.X1,P.me,P.Q0,P.BC,P.cb,P.VZ,P.j4,P.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return r})()}}]);