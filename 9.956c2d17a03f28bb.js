"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[9],{4009(xt,je,w){w.d(je,{ImportCalculatorComponent:()=>Et});var te=w(9769),I=w(5119),de=w(7312),fe=w(8935),Ke=w.t(fe,2),Pe=w(7283),Ue=w.t(Pe,2),ye=w(3276),Ye=w.t(ye,2);const R=new Map,be=new Map,he=new Map,ne=ye??Ye;(Array.isArray(ne)?ne:Object.values(ne).filter(t=>"object"==typeof t&&null!==t&&("Id"in t||"id"in t))).forEach(t=>{const n=String(t.Id??t.id),e=Number(t.Tier??t.tier),o=t.Name??t.name;if(o){R.set(n,o);const r=o.toLowerCase().replace(/[^a-z0-9]/g,"");he.set(r,n)}Number.isFinite(e)&&o&&be.set(n,{name:o,tier:e})});const Ve=Pe??Ue,We=new Map((fe??Ke).map(t=>[String(t.Id),t.Name])),Je=new Map(Ve.map(t=>[String(t.Id),t.Name])),Se={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},Xe={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showPositionalArgsInLogs:"spa",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",abominationSwallowedPet1:"aSP1",abominationSwallowedPet2:"aSP2",abominationSwallowedPet3:"aSP3",abominationSwallowedPet1BelugaSwallowedPet:"aSP1B",abominationSwallowedPet2BelugaSwallowedPet:"aSP2B",abominationSwallowedPet3BelugaSwallowedPet:"aSP3B",abominationSwallowedPet1SarcasticFringeheadSwallowedPet:"aSP1SFS",abominationSwallowedPet2SarcasticFringeheadSwallowedPet:"aSP2SFS",abominationSwallowedPet3SarcasticFringeheadSwallowedPet:"aSP3SFS",abominationSwallowedPet1Level:"aSP1L",abominationSwallowedPet2Level:"aSP2L",abominationSwallowedPet3Level:"aSP3L",abominationSwallowedPet1TimesHurt:"aSP1T",abominationSwallowedPet2TimesHurt:"aSP2T",abominationSwallowedPet3TimesHurt:"aSP3T",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const t={};for(let n=1;n<=3;n++){const e=`parrotCopyPetAbominationSwallowedPet${n}`,o=`pCPAS${n}`;t[e]=o,t[`${e}BelugaSwallowedPet`]=`${o}B`,t[`${e}Level`]=`${o}L`,t[`${e}TimesHurt`]=`${o}T`,t[`${e}ParrotCopyPet`]=`${o}PCP`,t[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${o}PCPB`;for(let r=1;r<=3;r++){const i=`${e}ParrotCopyPetAbominationSwallowedPet${r}`,a=`${o}PCPAS${r}`;t[i]=a,t[`${i}BelugaSwallowedPet`]=`${a}B`,t[`${i}Level`]=`${a}L`,t[`${i}TimesHurt`]=`${a}T`}}return t})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"},we={338:[368],373:[403],635:[669],763:[853,970]},_e={actionfigure:294,airpalmtree:511,balloon:479,boot:299,bowlingball:300,brokenpiggybank:310,broom:301,cardboardbox:302,television:491,toymouse:327};function x(t){return!!t&&"object"==typeof t&&!Array.isArray(t)}function h(t,n=0){const e=Number(t);return Number.isFinite(e)?e:n}function _(t,n){if(null==t)return null;if(x(t)){const o=[t.id,t.Id,t.petId,t.PetId,t.enum,t.Enum,t.Enu,t.enu];for(const i of o){if(null==i)continue;const a=h(i,NaN);if(Number.isFinite(a))return Math.trunc(a)}const r=t.name||t.Name||null;if("string"==typeof r){const i=String(r).toLowerCase().replace(/[^a-z0-9]/g,""),a=n?.petIdsByName||n?.PET_IDS_BY_NAME;if(a&&"function"==typeof a.get){const l=a.get(i);if(void 0!==l)return Math.trunc(Number(l))}if(a&&Number.isFinite(a[i]))return Math.trunc(Number(a[i]))}return null}if("string"==typeof t){const o=t.trim();if(""===o)return null;const r=h(o,NaN);if(Number.isFinite(r))return Math.trunc(r);const i=o.toLowerCase().replace(/[^a-z0-9]/g,""),a=n?.petIdsByName||n?.PET_IDS_BY_NAME;if(a&&"function"==typeof a.get){const l=a.get(i);if(void 0!==l)return Math.trunc(Number(l))}return a&&Number.isFinite(a[i])?Math.trunc(Number(a[i])):null}const e=h(t,NaN);return Number.isFinite(e)?Math.trunc(e):null}function Q(t){const n=[],e=new Set;for(const o of t){if(null==o)continue;const r=Number(o);if(!Number.isFinite(r))continue;const i=Math.trunc(r);e.has(i)||(e.add(i),n.push(i))}return n}function W(t,n){const e=n?.abilityIdsByPetId||{},o=String(t);return Q([...Array.isArray(e[o])?e[o]:[],...Array.isArray(we[o])?we[o]:[]])}function j(t){const n=_(t);if(!Number.isFinite(n))return null;const e={Enu:n};if(!x(t))return e;const o=h(t.attack??t.At??t.at,NaN);Number.isFinite(o)&&(e.At=Math.max(0,Math.round(o)));const r=h(t.health??t.Hp??t.hp,NaN);Number.isFinite(r)&&(e.Hp=Math.max(1,Math.round(r)));const i=h(t.mana??t.Mana,NaN);Number.isFinite(i)&&(e.Mana=Math.max(0,Math.round(i)));const a=h(t.level??t.lvl??t.Lvl,NaN);Number.isFinite(a)&&(e.Lvl=Math.max(1,Math.min(3,Math.round(a))));const l=h(t.exp??t.Exp,NaN);Number.isFinite(l)&&(e.Exp=Math.max(0,Math.round(l)));const s=t?.perk??t?.Perk??null;return null!=s&&(e.Perk=Number(s)),e}function oe(t,n){const e=[{petKey:"abominationSwallowedPet1",levelKey:"abominationSwallowedPet1Level",belugaKey:"abominationSwallowedPet1BelugaSwallowedPet",sfsKey:"abominationSwallowedPet1SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet2",levelKey:"abominationSwallowedPet2Level",belugaKey:"abominationSwallowedPet2BelugaSwallowedPet",sfsKey:"abominationSwallowedPet2SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet3",levelKey:"abominationSwallowedPet3Level",belugaKey:"abominationSwallowedPet3BelugaSwallowedPet",sfsKey:"abominationSwallowedPet3SarcasticFringeheadSwallowedPet"}],o=[];for(const i of e){const a=t?.[i.petKey],l=_(a,n);if(!Number.isFinite(l))continue;const s=W(l,n),c=j(a)||{Enu:l},m=h(t?.[i.levelKey],NaN);if(Number.isFinite(m)&&(c.Lvl=Math.max(1,Math.min(3,Math.round(m)))),182===l){const b=j(t?.[i.belugaKey]??a?.belugaSwallowedPet??null);if(b){const k=W(182,n),A={WhiteWhaleAbility:[{...b}]};for(const D of k)A[String(D)]=[{...b}];c.MiMs={Lsts:A}}}if(763===l){const b=j(t?.[i.sfsKey]??a?.sarcasticFringeheadSwallowedPet??null);if(b){const k={SarcasticFringeheadAbility:[{...b}]};c.MiMs={Lsts:k}}}o.push({swallowedPetId:l,swallowedAbilityEnums:s,memoryEntry:c,belugaSwallowedEntry:c?.MiMs?c.MiMs:null})}const r=Array.isArray(t?.abominationSwallowedPets)?t.abominationSwallowedPets:[];for(const i of r){const a=_(i,n);if(!Number.isFinite(a))continue;const l=W(a,n);o.push({swallowedPetId:a,swallowedAbilityEnums:l,memoryEntry:j(i)||{Enu:a}})}return o}function ge(t,n){const e=oe(t,n),o=[];for(const r of e)Array.isArray(r.swallowedAbilityEnums)&&o.push(...r.swallowedAbilityEnums);return Q(o)}function Ne(t,n){if(!x(t))return null;for(const[e,o]of Object.entries(t)){if(!n(e))continue;const r=h(o,NaN);if(Number.isFinite(r))return r}return null}function re(t){return"string"==typeof t?t:x(t)&&"string"==typeof t.name?t.name:null}function K(t){if("number"==typeof t&&Number.isFinite(t))return t;if("string"==typeof t&&t.trim().length>0){const n=Number(t);return Number.isFinite(n)?n:null}return null}function v(t,n){return K(t)??n}function Z(t){return null!==t&&"object"==typeof t&&!Array.isArray(t)}(()=>{try{if("1"===localStorage.getItem("sapReplayDebug"))return!0}catch{}try{return"1"===new URL(window.location.href).searchParams.get("sapReplayDebug")}catch{return!1}})();const at=new Set(["53","373"]),ie=[{pet:"abominationSwallowedPet1",level:"abominationSwallowedPet1Level"},{pet:"abominationSwallowedPet2",level:"abominationSwallowedPet2Level"},{pet:"abominationSwallowedPet3",level:"abominationSwallowedPet3Level"}];function U(t){return"number"==typeof t&&Number.isFinite(t)?String(t):"string"==typeof t&&t.length>0?t:null}function H(t,n){if(Array.isArray(t))return void t.forEach(r=>H(r,n));if(!Z(t))return;const e=U(t.Enu),o=t.Abil;e&&Array.isArray(o)&&!at.has(e)&&o.forEach(r=>{if(!Z(r))return;const i=U(r.Enu);i&&function lt(t,n,e){let o=t.get(n);o||(o=new Map,t.set(n,o)),o.set(e,(o.get(e)??0)+1)}(n,i,e)}),Object.values(t).forEach(r=>{H(r,n)})}function st(t){let n=null,e=-1;for(const[o,r]of t.entries())(r>e||r===e&&(null===n||o<n))&&(n=o,e=r);return n}function Me(t){const n={};for(const[e,o]of t.entries()){const r=st(o);r&&(n[e]=r)}return n}function q(t){if("string"!=typeof t||0===t.length)return null;try{return JSON.parse(t)}catch{return null}}function ae(t){const n=new Map;return(t??[]).forEach(e=>{const o=q(e?.Build),r=q(e?.Battle),i=q(e?.Mode);H(o,n),H(r,n),H(i,n)}),Me(n)}class Fe{parseReplayForCalculator(n,e,o,r){console.log(`[ReplayCalcParser] PETS_BY_ID size: ${R.size}`);const i=n?.UserBoard??o?.userBoard,a=n?.OpponentBoard??o?.opponentBoard,l=(p,P,d)=>v(p?.[P],d),s=new Map,c=new Map,m=p=>{p&&Object.entries(p).forEach(([P,d])=>{const S=U(P);if(!S)return;let y="number"==typeof d||"string"==typeof d?String(d):null;if(y&&!R.has(y)){const C=Number(y);if(Number.isInteger(C)){const T=C-30;if(Number.isInteger(T)&&T>0){const f=String(T);R.has(f)&&(y=f)}}}const M=(y?R.get(y):null)||("string"==typeof d?d:null);M&&s.set(S,M),y&&R.has(y)&&c.set(S,y)})},g=new Map;H(n,g),H(e,g),H(o,g),m(Me(g)),m(r?.abilityPetMap??null);const k=p=>s.get(p)??(p=>{const P=Number(p);if(!Number.isInteger(P))return null;const d=new Map;for(const[C,T]of c.entries()){const f=Number(C),N=Number(T);if(!Number.isInteger(f)||!Number.isInteger(N))continue;const F=Math.abs(f-P);if(0===F||F>2)continue;const E=f-N;d.set(E,(d.get(E)??0)+1)}let S=null,y=0;for(const[C,T]of d.entries())(T>y||T===y&&(null===S||Math.abs(C)<Math.abs(S)))&&(S=C,y=T);if(null===S)return null;const M=String(P-S);return R.get(M)??null})(p),z=p=>{if(!p)return null;const P={PET_IDS_BY_NAME:he},d=p.Enu??p.enu??p.Id??p.id,S=_(d,P),y=String(null!==S?S:d??0),M=R.get(y)||p.name||p.Name||("string"==typeof d&&d.trim().length>0?d.trim():`Pet #${y}`);console.log(`[ReplayCalcParser] Pet Enu:${d} -> Id:${y} -> Name:${M}`);const C=p.At??p.at,T=p.Hp??p.hp,f=v(C?.Temp??C?.temp,0),N=v(T?.Temp??T?.temp,0);let F=null;if("182"===y){const B=p?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(B.length>0){const L=B[0]?.Enu;F=R.get(String(L))||`Pet #${L}`}}const E="373"===y?(p=>{const P={abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},d=(p?.Abil??[]).map((f,N)=>({ability:f,index:N})).filter(f=>null!==f.ability&&null!==U(f.ability?.Enu));if(0===d.length)return P;const S=new Map,y=[];d.forEach(f=>{const N=K(f.ability?.Grop)??0;S.has(N)||(S.set(N,[]),y.push(N)),S.get(N)?.push(f)});const M=new Set,C=[];if(ie.forEach((f,N)=>{const F=y[N];if(void 0===F)return void C.push(N);const E=S.get(F);if(!E||0===E.length)return void C.push(N);let O=null,V=null;for(const $ of E){const X=U($.ability?.Enu);if(!X)continue;const G=k(X);if(G){O=$,V=G;break}}if(!O||!V)return void C.push(N);P[f.pet]=V;const J=K(O.ability?.Lvl);null!==J&&(P[f.level]=J),M.add(O.index)}),0===C.length)return P;const T=d.filter(f=>!M.has(f.index)).map(f=>{const N=U(f.ability?.Enu);if(!N)return null;const F=k(N);return F?{ownerPetName:F,level:K(f.ability?.Lvl)}:null}).filter(f=>null!==f);return C.forEach((f,N)=>{const F=T[N];if(!F)return;const E=ie[f];P[E.pet]=F.ownerPetName,null!==F.level&&(P[E.level]=F.level)}),P})(p):{abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},O={};for(const[B,L]of c.entries()){const me=String(L);O[me]=O[me]||[],O[me].push(String(B))}P.abilityIdsByPetId=O;const V=(p=>function tt(t){const n=[t?.timesHurt,t?.TimesHurt,t?.Pow?.SabertoothTigerAbility,t?.pow?.SabertoothTigerAbility];for(const e of n){const o=h(e,NaN);if(Number.isFinite(o))return Math.max(0,Math.round(o))}return null}(p))(p),J=(()=>{const B=function et(t){const n=[t?.triggersConsumed,t?.TrCo,t?.trco,t?.triggerConsumed];for(const a of n){const l=h(a,NaN);if(Number.isFinite(l))return Math.max(0,Math.round(l))}const e=a=>{const l=String(a||"").toLowerCase(),s=l.includes("trigger")||l.includes("trig"),c=l.includes("consum"),m=["trgc","trgcn","trc","trcn","trco"].includes(l);return s&&c||m},o=[t,t?.pow,t?.Pow];for(const a of o){const l=Ne(a,e);if(Number.isFinite(l))return Math.max(0,Math.round(l))}const r=[t?.abilities,t?.Abil],i=[];for(const a of r)if(Array.isArray(a))for(const l of a){const s=Ne(l,e);Number.isFinite(s)&&i.push(s)}return i.length>0?Math.max(0,Math.round(Math.max(...i))):null}(p);return null===B?[]:[B]})(),$=p.Perk,X=null!=$?We.get(String($))||("string"==typeof $?$:"Unknown Perk"):null,G={name:M,attack:v(C?.Perm??C?.perm??p?.attack,0)+f,health:v(T?.Perm??T?.perm??p?.health,0)+N,exp:(()=>{const B=K(p.Exp);if(null!==B&&B>0)return B;const L=K(p.Lvl);return 2===L?2:3===L?5:B??0})(),equipment:X?{name:X}:null,mana:v(p.Mana,0),belugaSwallowedPet:F,sarcasticFringeheadSwallowedPet:null,...E,battlesFought:0,triggersConsumed:J.length>0?Math.max(...J):0};if("373"===String(y))try{const B=function Ze(t,n,e){const o=oe(t,e);if(0===o.length)return null;const r=function Ae(t,n,e){const o=[t?.abilityEnum,t?.abilityId,t?.Abil?.[0]?.Enu,t?.abilities?.[0]?.Enu];for(const i of o){const a=h(i,NaN);if(Number.isFinite(a))return Math.trunc(a)}if(373===n||338===n){const i=function Qe(t,n){const e=ge(t,n);return e.length>0?e[0]:null}(t,e);if(Number.isFinite(i))return Math.trunc(i)}const r=W(n,e);return r.length>0?r[0]:null}(t,n,e),i=Number.isFinite(r)?[Math.trunc(r)]:[],a={};for(const l of o){const s=Q(Array.isArray(l.swallowedAbilityEnums)?l.swallowedAbilityEnums:[]),c=s.length>0?s:i;if(0!==c.length)for(const m of c){const g=String(m);Array.isArray(a[g])||(a[g]=[]);const k=182===l.swallowedPetId&&Array.isArray(l.swallowedAbilityEnums)&&l.swallowedAbilityEnums.includes(m)&&l.belugaSwallowedEntry?l.belugaSwallowedEntry:l.memoryEntry||{Enu:l.swallowedPetId};a[g].push(k)}}return 0===Object.keys(a).length?null:{Lsts:a}}(p,Number(y),P);if(B){G.abominationMemory=B;const L=ge(p,P);Array.isArray(L)&&L.length>0&&(G.abominationInferredAbilityEnums=L)}}catch{}return null!==V&&(G.timesHurt=V),G},He=p=>{const P=p?.Mins?.Items??[],d=Array(5).fill(null);return P.forEach((S,y)=>{if(!S)return;let M=v(S.Poi?.x,-1);-1===M&&(M=y),M>=0&&M<5&&(d[M]=z(S))}),d.reverse()},$e=p=>{const P=(p?.Rel?.Items??[]).find(d=>!!d);if(P){const d=function Ce(t,n){if(null==t)return null;if(x(t)){const a=[t.id,t.toyId,t.enum,t.Enu];for(const l of a){const s=h(l,NaN);if(Number.isFinite(s))return Math.trunc(s)}}const e=re(t)??t,o="string"==typeof e?e.toLowerCase().replace(/[^a-z0-9]/g,""):"";if(!o)return null;const r=n?.toyIdsByName?.[o];if(Number.isFinite(r))return r;const i=_e[o];return Number.isFinite(i)?i:null}(P)??null;return{name:(d?Je.get(String(d)):re(P))||null,level:v(P.Lvl,1)}}return{name:null,level:1}},De=$e(i),Ge=$e(a),pe=this.buildCustomPacksFromGenesis(e,n),Lt=this.findCustomPackFromDeck(pe,i?.Deck),vt=this.findCustomPackFromDeck(pe,a?.Deck);return{playerPack:Se[v(i?.Pack,NaN)]||Lt?.name||"Turtle",opponentPack:Se[v(a?.Pack,NaN)]||vt?.name||"Turtle",playerToy:De.name,playerToyLevel:String(De.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:Ge.name,opponentToyLevel:String(Ge.level),opponentHardToy:null,opponentHardToyLevel:1,turn:l(i,"Tur",1)||1,playerGoldSpent:l(i,"GoSp",0)||0,opponentGoldSpent:l(a,"GoSp",0)||0,playerRollAmount:l(i,"Rold",0)||0,opponentRollAmount:l(a,"Rold",0)||0,playerSummonedAmount:l(i,"MiSu",0)||0,opponentSummonedAmount:l(a,"MiSu",0)||0,playerLevel3Sold:l(i,"MSFL",0)||0,opponentLevel3Sold:l(a,"MSFL",0)||0,playerTransformationAmount:l(i,"TrTT",0)||0,opponentTransformationAmount:l(a,"TrTT",0)||0,playerPets:He(i),opponentPets:He(a),allPets:!1,logFilter:null,customPacks:pe,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showPositionalArgsInLogs:!0,ailmentEquipment:!1}}buildCustomPacksFromGenesis(n,e){const o=[n?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(l=>null!=l&&Array.isArray(l.Minions)),r=[],i=new Set,a=new Set;for(const l of o){const s=l?.Id?String(l.Id):null;if(s&&i.has(s))continue;s&&i.add(s);const c=this.buildCustomPackFromDeck(l,a);c&&r.push({...c,deckId:s})}return r}generateCalculatorLink(n){const e=window.location.origin+window.location.pathname,o=this.stripDefaultValues(n),r=this.truncateKeys(o),i=JSON.stringify(r);return`${e}#c=${btoa(i)}`}buildCustomPackFromDeck(n,e){if(!n||!Array.isArray(n.Minions))return null;const o=n.Minions.map(s=>String(s)),r=Array.isArray(n.Spells)?n.Spells.map(String):[],i={1:[],2:[],3:[],4:[],5:[],6:[]};for(const s of o){const c=be.get(s);c&&i[c.tier]&&i[c.tier].push(c.name)}const a=s=>{const c=s.slice(0,10);for(;c.length<10;)c.push(null);return c};let l=n.Title||"Custom Pack";if(e.has(l)){let s=2;for(;e.has(`${l} (${s})`);)s+=1;l=`${l} (${s})`}return e.add(l),{name:l,tier1Pets:a(i[1]),tier2Pets:a(i[2]),tier3Pets:a(i[3]),tier4Pets:a(i[4]),tier5Pets:a(i[5]),tier6Pets:a(i[6]),spells:r}}findCustomPackFromDeck(n,e){if(!e)return null;const o=e?.Id?String(e.Id):null;if(o){const i=n.find(a=>a.deckId===o);if(i)return i}const r=e?.Title;return r&&n.find(i=>i.name===r)||null}stripDefaultValues(n){const e={};"Turtle"!==n.playerPack&&(e.playerPack=n.playerPack),"Turtle"!==n.opponentPack&&(e.opponentPack=n.opponentPack),n.playerToy&&(e.playerToy=n.playerToy),n.playerToyLevel&&"1"!==n.playerToyLevel&&(e.playerToyLevel=n.playerToyLevel),n.opponentToy&&(e.opponentToy=n.opponentToy),n.opponentToyLevel&&"1"!==n.opponentToyLevel&&(e.opponentToyLevel=n.opponentToyLevel),11!==n.turn&&(e.turn=n.turn),10!==n.playerGoldSpent&&(e.playerGoldSpent=n.playerGoldSpent),10!==n.opponentGoldSpent&&(e.opponentGoldSpent=n.opponentGoldSpent),4!==n.playerRollAmount&&(e.playerRollAmount=n.playerRollAmount),4!==n.opponentRollAmount&&(e.opponentRollAmount=n.opponentRollAmount),0!==n.playerSummonedAmount&&(e.playerSummonedAmount=n.playerSummonedAmount),0!==n.opponentSummonedAmount&&(e.opponentSummonedAmount=n.opponentSummonedAmount),0!==n.playerLevel3Sold&&(e.playerLevel3Sold=n.playerLevel3Sold),0!==n.opponentLevel3Sold&&(e.opponentLevel3Sold=n.opponentLevel3Sold),0!==n.playerTransformationAmount&&(e.playerTransformationAmount=n.playerTransformationAmount),0!==n.opponentTransformationAmount&&(e.opponentTransformationAmount=n.opponentTransformationAmount),n.allPets&&(e.allPets=!0),n.oldStork&&(e.oldStork=!0),n.tokenPets&&(e.tokenPets=!0),n.komodoShuffle&&(e.komodoShuffle=!0),n.mana&&(e.mana=!0),null!=n.seed&&(e.seed=n.seed),n.triggersConsumed&&(e.triggersConsumed=!0),n.foodsEaten&&(e.foodsEaten=!0),n.showAdvanced&&(e.showAdvanced=!0),n.showTriggerNamesInLogs&&(e.showTriggerNamesInLogs=!0),!1===n.showPositionalArgsInLogs&&(e.showPositionalArgsInLogs=!1),n.ailmentEquipment&&(e.ailmentEquipment=!0),n.logFilter&&(e.logFilter=n.logFilter),n.customPacks.length>0&&(e.customPacks=n.customPacks);const o=a=>{if(!a||!a.name)return null;const l={name:a.name};return"number"==typeof a.attack&&0!==a.attack&&(l.attack=a.attack),"number"==typeof a.health&&0!==a.health&&(l.health=a.health),"number"==typeof a.exp&&0!==a.exp&&(l.exp=a.exp),"number"==typeof a.mana&&0!==a.mana&&(l.mana=a.mana),a.equipment&&(l.equipment=a.equipment),a.triggersConsumed&&(l.triggersConsumed=a.triggersConsumed),a.foodsEaten&&(l.foodsEaten=a.foodsEaten),null!=a.belugaSwallowedPet&&(l.belugaSwallowedPet=a.belugaSwallowedPet),ie.forEach(s=>{const c=a[s.pet];null!=c&&(l[s.pet]=c);const m=a[s.level];"number"==typeof m&&1!==m&&(l[s.level]=m)}),a.timesHurt&&(l.timesHurt=a.timesHurt),l},r=n.playerPets.map(o);r.some(a=>null!==a)&&(e.playerPets=r);const i=n.opponentPets.map(o);return i.some(a=>null!==a)&&(e.opponentPets=i),e}truncateKeys(n){if(Array.isArray(n))return n.map(e=>this.truncateKeys(e));if(Z(n)){const e={};for(const o of Object.keys(n))e[Xe[o]||o]=this.truncateKeys(n[o]);return e}return n}}function Be(t){return null!==t&&"object"==typeof t&&!Array.isArray(t)}var u=w(5547),Pt=w(7705),ke=w(467),Ie=w(7389);function ee(t,n){return new Ie.c(n?e=>n.schedule(yt,0,{error:t,subscriber:e}):e=>e.error(t))}function yt({error:t,subscriber:n}){n.error(t)}var bt=w(4421),Y=w(3004);function se(t){return function(e){const o=new ht(t),r=e.lift(o);return o.caught=r}}class ht{constructor(n){this.selector=n}call(n,e){return e.subscribe(new St(n,this.selector,this.caught))}}class St extends Y.gn{constructor(n,e,o){super(n),this.selector=e,this.caught=o}error(n){if(!this.isStopped){let e;try{e=this.selector(n,this.caught)}catch(i){return void super.error(i)}this._unsubscribeAndRecycle();const o=new Y.zA(this);this.add(o);const r=(0,Y.tS)(e,o);r!==o&&this.add(r)}}}var Ee=w(1080);const wt=(()=>{function t(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return t.prototype=Object.create(Error.prototype),t})();class Nt{constructor(n,e,o,r){this.waitFor=n,this.absoluteTimeout=e,this.withObservable=o,this.scheduler=r}call(n,e){return e.subscribe(new ue(n,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class ue extends Y.gn{constructor(n,e,o,r,i){super(n),this.absoluteTimeout=e,this.waitFor=o,this.withObservable=r,this.scheduler=i,this.scheduleTimeout()}static dispatchTimeout(n){const{withObservable:e}=n;n._unsubscribeAndRecycle(),n.add((0,Y.tS)(e,new Y.zA(n)))}scheduleTimeout(){const{action:n}=this;n?this.action=n.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(ue.dispatchTimeout,this.waitFor,this))}_next(n){this.absoluteTimeout||this.scheduleTimeout(),super._next(n)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}function ce(t,n=Ee.b){return function At(t,n,e=Ee.b){return o=>{let r=function gt(t){return t instanceof Date&&!isNaN(+t)}(t),i=r?+t-e.now():Math.abs(t);return o.lift(new Nt(i,r,n,e))}}(t,ee(new wt),n)}var Ct=w(9090),Le=w(5006);function Re(t){return t.endsWith("/")?t.slice(0,-1):t}function Oe(t){return`${Re("https://sap-library.vercel.app/api")}${t}`}var xe=w(7868),Tt=w(6980);let Ft=(()=>{class t{http;parser=new Fe;constructor(e){this.http=e}parseReplayForCalculator(e,o,r,i){return this.parser.parseReplayForCalculator(e,o,r,i)}buildCustomPacksFromGenesis(e,o){return this.parser.buildCustomPacksFromGenesis(e,o)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}fetchReplayBattle(e,o){return this.fetchReplayBattleFromTurnsApi(e,o)}fetchReplayBattleFromTurnsApi(e,o){const r=String(e.Pid);return this.fetchReplayBattleByReplayId(r,e.T,o).pipe(se(i=>404!==i?.status?this.normalizeReplayFetchError(i):this.http.post(Oe("/replays"),{Pid:r,participationId:r}).pipe(ce(o),(0,Ct.n)(a=>{const l=a?.replayId;return l?this.fetchReplayBattleByReplayId(String(l),e.T,o):ee({error:{error:"Replay indexing did not return a replayId."},status:400})}),se(a=>this.normalizeReplayFetchError(a)))))}fetchReplayBattleByReplayId(e,o,r){return this.http.get(function Mt(t){const n=encodeURIComponent(String(t));return`${Re("https://sap-library.vercel.app/api")}/replays/${n}/turns`}(e)).pipe(ce(r),(0,Le.T)(i=>this.buildReplayBattleResponseFromTurns(i,o,e)))}normalizeReplayFetchError(e){const o=e?.status;return ee(404===o||400===o?e:{error:{error:"This replay API does not expose turn battle JSON. Configure a replay backend that supports /api/replay-battle or /api/replays/:id/turns."},status:400})}checkReplayApiHealth(e){var o=this;return(0,ke.A)(function*(){return(yield o.http.get(Oe("/health")).pipe(ce(e),(0,Le.T)(i=>({reachable:!0,isReplayHealthContract:o.isReplayHealthResponse(i)})),se(()=>(0,bt.of)({reachable:!1,isReplayHealthContract:!1}))).toPromise())??{reachable:!1,isReplayHealthContract:!1}})()}checkReplayApiReachable(e){var o=this;return(0,ke.A)(function*(){return(yield o.checkReplayApiHealth(e)).reachable})()}isReplayHealthResponse(e){return!(!e||"object"!=typeof e)&&("boolean"==typeof e.ok&&"boolean"==typeof e.hasCredentials&&"boolean"==typeof e.tokenLoaded)}toFiniteNumber(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e&&e.trim().length>0){const o=Number(e);return Number.isFinite(o)?o:null}return null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}mapReplayTurnsPet(e){const o=(e?.abilities??[]).map(r=>{const i=this.toReplayId(r?.id);return i?{Enu:i,Lvl:this.toFiniteNumber(r?.level)??1,Grop:this.toFiniteNumber(r?.group)??0,TrCo:this.toFiniteNumber(r?.triggersConsumed)??0}:null}).filter(r=>null!==r);return{Enu:this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perkId),At:{Perm:this.toFiniteNumber(e?.attack?.permanent)??0,Temp:this.toFiniteNumber(e?.attack?.temporary)??0,Max:this.toFiniteNumber(e?.attack?.max)},Hp:{Perm:this.toFiniteNumber(e?.health?.permanent)??0,Temp:this.toFiniteNumber(e?.health?.temporary)??0,Max:this.toFiniteNumber(e?.health?.max)},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:this.toFiniteNumber(e?.cosmetic)??0,Poi:{x:this.toFiniteNumber(e?.slot)??0},Abil:o,...e}}mapReplaySummaryPet(e){const o=(e?.abilities??[]).map(r=>{const i=this.toReplayId(r?.id);return i?{Enu:i,Lvl:this.toFiniteNumber(r?.level)??1,Grop:this.toFiniteNumber(r?.group)??0,TrCo:this.toFiniteNumber(r?.triggersConsumed)??0}:null}).filter(r=>null!==r);return{Enu:this.toReplayId(e?.petName)||this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perk),At:{Perm:this.toFiniteNumber(e?.attack)??0,Temp:0,Max:null},Hp:{Perm:this.toFiniteNumber(e?.health)??0,Temp:0,Max:null},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:0,Poi:{x:this.toFiniteNumber(e?.position)??0},Abil:o,...e}}mapReplayTurnsSide(e){const o=e?.stats??null;return{Tur:this.toFiniteNumber(o?.turn)??1,Vic:this.toFiniteNumber(o?.victories)??0,Back:this.toFiniteNumber(o?.health)??0,GoSp:this.toFiniteNumber(o?.goldSpent)??0,Rold:this.toFiniteNumber(o?.rolls)??0,MiSu:this.toFiniteNumber(o?.summons)??0,MSFL:this.toFiniteNumber(o?.level3Sold)??0,TrTT:this.toFiniteNumber(o?.transformed)??0,Mins:{Items:(e?.pets??[]).map(r=>this.mapReplayTurnsPet(r))}}}mapReplaySummarySide(e,o,r){if(r&&"player"===o)return r;const i="player"===o,a=(i?e?.pets?.player:e?.pets?.opponent)??[];return{Tur:this.toFiniteNumber(e?.Turn)??this.toFiniteNumber(e?.turnNumber)??this.toFiniteNumber(e?.turn)??1,Vic:0,Back:0,GoSp:this.toFiniteNumber(i?e?.playerGoldSpent:e?.opponentGoldSpent)??0,Rold:this.toFiniteNumber(i?e?.playerRolls:e?.opponentRolls)??0,MiSu:this.toFiniteNumber(i?e?.playerSummons:e?.opponentSummons)??0,MSFL:0,TrTT:0,Mins:{Items:a.map(l=>this.mapReplaySummaryPet(l))}}}buildReplayBattleResponseFromTurns(e,o,r){const i=e?.turns??[],a=i.filter(b=>(this.toFiniteNumber(b?.Turn)??this.toFiniteNumber(b?.turn)??this.toFiniteNumber(b?.turnNumber))===o),l=a.find(b=>1===b.Type)??a.find(b=>0===b.Type)??a[0]??(o>0&&o<=i.length?i[o-1]:null);if(!l)throw{error:{error:`Replay ${r} does not contain turn ${o}.`},status:404};const s=!(!l?.user&&!l?.opponent);let c=null,m=null;if(!s){const b=a.find(A=>A.Build);if(b)try{const A=JSON.parse(b.Build);c=A?.Bor??A}catch{}const k=a.find(A=>A.Battle);if(k)try{const A=JSON.parse(k.Battle);m=A?.UserBoard||A?.OpponentBoard?A:null}catch{}if(!m?.OpponentBoard){const A=a.find(D=>D.Mode);if(A)try{const z=JSON.parse(A.Mode)?.Opponents?.[0];z&&(m||(m={}),m.OpponentBoard={Mins:{Items:z.Minions},Rel:{Items:z.Relics},Pack:z.Pack,Tur:o,GoSp:A.OpponentGoldSpent??0})}catch{}}}let g=e?.abilityPetMap??null;if(!g&&e?.replay?.raw_json?.Actions){g=ae(e.replay.raw_json.Actions);const b=a.find(k=>k.playerPets||k.opponentPets)||l;!c&&b.playerPets&&(c={Mins:{Items:b.playerPets}}),!m?.OpponentBoard&&b.opponentPets&&(m||(m={}),m.OpponentBoard={Mins:{Items:b.opponentPets}})}return{battle:s?{UserBoard:this.mapReplayTurnsSide(l?.user),OpponentBoard:this.mapReplayTurnsSide(l?.opponent)}:{UserBoard:this.mapReplaySummarySide(l,"player",c||m?.UserBoard),OpponentBoard:this.mapReplaySummarySide(l,"opponent",m?.OpponentBoard)},genesisBuildModel:e?.genesisBuildModel??e?.replay?.raw_json?.GenesisBuildModel??e?.replay?.GenesisBuildModel,abilityPetMap:g}}static \u0275fac=function(o){return new(o||t)(xe.KVO(Tt.Qq))};static \u0275prov=xe.jDH({token:t,factory:t.\u0275fac,providedIn:"root"})}return t})();const Bt=(t,n,e)=>({"text-success":t,"text-danger":n,"text-warning":e});function kt(t,n){if(1&t&&(u.j41(0,"div",10),u.EFF(1),u.k0s()),2&t){const e=u.XpG();u.Y8G("ngClass",u.sMw(2,Bt,"success"===e.statusTone,"error"===e.statusTone,"warning"===e.statusTone)),u.R7$(),u.SpI(" ",e.statusMessage," ")}}function It(t,n){if(1&t&&(u.j41(0,"div",11),u.EFF(1),u.k0s()),2&t){const e=u.XpG();u.R7$(),u.JRh(e.errorMessage)}}let Et=(()=>{class t{replayCalcService;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new I.gE({calcCode:new I.MJ(null,I.k0.required),turn:new I.MJ(1,I.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;statusTimer=null;constructor(e,o){this.replayCalcService=e,this.cdr=o}ngOnInit(){}submit(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode"),o=e?.value?.trim();if(!o)return void(this.errorMessage="Paste calculator JSON or replay JSON.");e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});const r=function ft(t){const n=t?.trim();if(!n||!n.startsWith("SAPR1:"))return null;const e=n.slice(6);if(!e)return null;try{const o=JSON.parse(function dt(t){const n=t.replace(/-/g,"+").replace(/_/g,"/"),o=`${n}${"=".repeat((4-n.length%4)%4)}`,r=atob(o),i=Uint8Array.from(r,a=>a.charCodeAt(0));return(new TextDecoder).decode(i)}(e));return Be(o)&&1===o.version&&Be(o.battle)?{battle:o.battle,genesisBuildModel:o.genesisBuildModel??null,abilityPetMap:o.abilityPetMap??null,turn:"number"==typeof o.turn&&Number.isFinite(o.turn)?o.turn:void 0}:null}catch{return null}}(o);if(r?.battle)return void this.importReplayBattle(r.battle,r.genesisBuildModel,void 0,{abilityPetMap:r.abilityPetMap??null});let i;try{i=JSON.parse(o)}catch{if(this.importFunc(o))return void this.setStatus("Import successful.","success");if(this.tryReplayPid(o))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((i?.Pid||i?.pid)&&!i?.Actions){const a=i?.Pid??i?.pid,l=Number(i?.T??i?.t??this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(s=>{if(!s.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();s.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:a,T:l},this.replayTimeoutMs).pipe((0,de.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:c=>{const m=c?.battle;m?this.importReplayBattle(m,c?.genesisBuildModel,void 0,{abilityPetMap:c?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:c=>{if("TimeoutError"===c?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=c?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(i?.UserBoard&&i?.OpponentBoard)this.importReplayBattle(i,i?.GenesisBuildModel,{userBoard:i?.UserBoard,opponentBoard:i?.OpponentBoard},{abilityPetMap:i?.AbilityPetMap??null});else{if(i?.Actions){const a=Number(this.formGroup.get("turn").value??i?.T);if(!Number.isFinite(a)||a<=0)return void(this.errorMessage="Enter a valid turn number.");let l=0,s=null;for(const m of i.Actions)if(0===m?.Type&&m?.Battle&&(l+=1,l===a)){try{s=JSON.parse(m.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${a}.`)}break}if(!s)return void(this.errorMessage=`No battle found for turn ${a}.`);const c=i?.AbilityPetMap??ae(i.Actions);return void this.importReplayBattle(s,i?.GenesisBuildModel,{userBoard:i?.UserBoard,opponentBoard:i?.OpponentBoard},{abilityPetMap:c})}if(i?.turns){const a=Number(this.formGroup.get("turn").value);if(!Number.isFinite(a)||a<=0)return void(this.errorMessage="Enter a valid turn number.");try{const l=this.replayCalcService.buildReplayBattleResponseFromTurns(i,a,i?.replay?.id||"manual-import");if(l?.battle)return void this.importReplayBattle(l.battle,l.genesisBuildModel,void 0,{abilityPetMap:l.abilityPetMap??null},{resetBattle:!0})}catch{return void(this.errorMessage="Failed to process turns JSON.")}}this.importFunc(o)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(e,o,r,i,a){const l=this.replayCalcService.parseReplayForCalculator(e,o,r,i);this.importFunc(JSON.stringify(l),a)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const o=e?.trim();if(!o||!/^[a-f0-9-]{16,}$/i.test(o)&&!/^\d+$/.test(o))return!1;const i=Number(this.formGroup.get("turn").value);return!Number.isFinite(i)||i<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(a=>{if(!a.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();a.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:o,T:i},this.replayTimeoutMs).pipe((0,de.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:l=>{const s=l?.battle;s?this.importReplayBattle(s,l?.genesisBuildModel,void 0,{abilityPetMap:l?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:l=>{if("TimeoutError"===l?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=l?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}setLoading(e){this.loading=e,this.cdr.markForCheck()}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,o){this.statusMessage=e,this.statusTone=o,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(o){return new(o||t)(u.rXU(Ft),u.rXU(Pt.gRc))};static \u0275cmp=u.VBU({type:t,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:19,vars:6,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(o,r){1&o&&(u.j41(0,"div",0)(1,"div",1),u.EFF(2," Paste calculator export code (compressed), replay export code, calculator JSON, or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),u.k0s(),u.j41(3,"div",1),u.EFF(4," Example Pid: "),u.j41(5,"code"),u.EFF(6),u.k0s()(),u.nrm(7,"textarea",2),u.j41(8,"div",3)(9,"div")(10,"label",4),u.EFF(11,"Turn (1-based)"),u.k0s(),u.nrm(12,"input",5),u.k0s(),u.j41(13,"button",6),u.bIt("click",function(){return r.submit()}),u.EFF(14),u.k0s()(),u.j41(15,"div",7),u.EFF(16," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),u.k0s(),u.DNE(17,kt,2,6,"div",8)(18,It,2,1,"div",9),u.k0s()),2&o&&(u.Y8G("formGroup",r.formGroup),u.R7$(6),u.JRh(r.pidExample),u.R7$(7),u.Y8G("disabled",r.loading),u.R7$(),u.SpI(" ",r.loading?"Fetching...":"Import"," "),u.R7$(3),u.Y8G("ngIf",r.statusMessage),u.R7$(),u.Y8G("ngIf",r.errorMessage))},dependencies:[te.MD,te.YU,te.bT,I.X1,I.me,I.Q0,I.BC,I.cb,I.VZ,I.j4,I.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return t})()}}]);