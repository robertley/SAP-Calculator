"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[737],{1737(_,$,c){c.d($,{ImportCalculatorComponent:()=>z});var g=c(9769),m=c(5119),s=c(5547),T=c(8935),H=c.t(T,2),h=c(7283),G=c.t(h,2),k=c(3276),O=c.t(k,2);const C=new Map,v=new Map;(k??O).forEach(r=>{const e=String(r.Id),o=Number(r.Tier);C.set(e,r.Name),Number.isFinite(o)&&v.set(e,{name:r.Name,tier:o})});const D=h??G,x=new Map((T??H).map(r=>[String(r.Id),r.Name])),Y=new Map(D.map(r=>[String(r.Id),r.Name])),L={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},j={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",triggersConsumed:"tc",showAdvanced:"sa",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const r={};for(let e=1;e<=3;e++){const o=`parrotCopyPetAbominationSwallowedPet${e}`,l=`pCPAS${e}`;r[o]=l,r[`${o}BelugaSwallowedPet`]=`${l}B`,r[`${o}Level`]=`${l}L`,r[`${o}TimesHurt`]=`${l}T`,r[`${o}ParrotCopyPet`]=`${l}PCP`,r[`${o}ParrotCopyPetBelugaSwallowedPet`]=`${l}PCPB`;for(let a=1;a<=3;a++){const n=`${o}ParrotCopyPetAbominationSwallowedPet${a}`,t=`${l}PCPAS${a}`;r[n]=t,r[`${n}BelugaSwallowedPet`]=`${t}B`,r[`${n}Level`]=`${t}L`,r[`${n}TimesHurt`]=`${t}T`}}return r})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};class U{parseReplayForCalculator(e,o,l){const a=e?.UserBoard??l?.userBoard,n=e?.OpponentBoard??l?.opponentBoard,t=(p,d,S=null)=>{const y=p?.[d];return void 0===y?S:y},u=p=>{const d=(p?.Mins?.Items||[]).filter(Boolean),S=Array(5).fill(null);return d.forEach((y,b)=>{let w=y.Poi?.x;void 0===w&&(w=b),w>=0&&w<5&&(S[w]=(p=>{if(!p)return null;const d=String(p.Enu??0),S=p.At?.Temp??0,y=p.Hp?.Temp??0;let b=null;if("182"===d){const f=p?.MiMs?.Lsts?.WhiteWhaleAbility||[];if(f.length>0){const R=f[0]?.Enu;b=C.get(String(R))||`Pet #${R}`}}const w=(p=>{const d=p?.Pow?.SabertoothTigerAbility;return Number.isFinite(d)?d:null})(p),I=(p?.Abil||[]).map(f=>f?.TrCo).filter(f=>Number.isFinite(f)),N={name:C.get(d)||null,attack:(p.At?.Perm??0)+S,health:(p.Hp?.Perm??0)+y,exp:p.Exp||0,equipment:p.Perk?{name:x.get(String(p.Perk))||"Unknown Perk"}:null,mana:p.Mana||0,belugaSwallowedPet:b,sarcasticFringeheadSwallowedPet:null,abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1,battlesFought:0,triggersConsumed:I.length>0?Math.max(...I):0};return null!==w&&(N.timesHurt=w),N})(y))}),S.reverse()},B=p=>{const d=(p?.Rel?.Items||[]).find(S=>S&&S.Enu);if(d){const S=String(d.Enu);return{name:Y.get(S)||null,level:d.Lvl||1}}return{name:null,level:1}},F=B(a),M=B(n),A=this.buildCustomPacksFromGenesis(o,e),W=this.findCustomPackFromDeck(A,a?.Deck),Q=this.findCustomPackFromDeck(A,n?.Deck);return{playerPack:L[a?.Pack]||W?.name||"Turtle",opponentPack:L[n?.Pack]||Q?.name||"Turtle",playerToy:F.name,playerToyLevel:String(F.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:M.name,opponentToyLevel:String(M.level),opponentHardToy:null,opponentHardToyLevel:1,turn:t(a,"Tur",1)||1,playerGoldSpent:t(a,"GoSp",0)||0,opponentGoldSpent:t(n,"GoSp",0)||0,playerRollAmount:t(a,"Rold",0)||0,opponentRollAmount:t(n,"Rold",0)||0,playerSummonedAmount:t(a,"MiSu",0)||0,opponentSummonedAmount:t(n,"MiSu",0)||0,playerLevel3Sold:t(a,"MSFL",0)||0,opponentLevel3Sold:t(n,"MSFL",0)||0,playerTransformationAmount:t(a,"TrTT",0)||0,opponentTransformationAmount:t(n,"TrTT",0)||0,playerPets:u(a),opponentPets:u(n),allPets:!1,logFilter:null,customPacks:A,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,triggersConsumed:!0,showAdvanced:!0,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(e,o){const l=[e?.Bor?.Deck,o?.UserBoard?.Deck,o?.OpponentBoard?.Deck].filter(i=>i&&Array.isArray(i.Minions)),a=[],n=new Set,t=new Set;for(const i of l){const P=i?.Id?String(i.Id):null;if(P&&n.has(P))continue;P&&n.add(P);const u=this.buildCustomPackFromDeck(i,t);u&&a.push({...u,deckId:P})}return a}generateCalculatorLink(e){const o=window.location.origin+window.location.pathname,l=this.stripDefaultValues(e),a=this.truncateKeys(l),n=JSON.stringify(a);return`${o}?c=${btoa(n)}`}buildCustomPackFromDeck(e,o){if(!e||!Array.isArray(e.Minions))return null;const l=e.Minions.map(P=>String(P)),a=Array.isArray(e.Spells)?e.Spells.slice():[],n={1:[],2:[],3:[],4:[],5:[],6:[]};for(const P of l){const u=v.get(P);u&&n[u.tier]&&n[u.tier].push(u.name)}const t=P=>{const u=P.slice(0,10);for(;u.length<10;)u.push(null);return u};let i=e.Title||"Custom Pack";if(o.has(i)){let P=2;for(;o.has(`${i} (${P})`);)P+=1;i=`${i} (${P})`}return o.add(i),{name:i,tier1Pets:t(n[1]),tier2Pets:t(n[2]),tier3Pets:t(n[3]),tier4Pets:t(n[4]),tier5Pets:t(n[5]),tier6Pets:t(n[6]),spells:a}}findCustomPackFromDeck(e,o){if(!o)return null;const l=o?.Id?String(o.Id):null;if(l){const n=e.find(t=>t.deckId===l);if(n)return n}const a=o?.Title;return a&&e.find(n=>n.name===a)||null}stripDefaultValues(e){const o={};"Turtle"!==e.playerPack&&(o.playerPack=e.playerPack),"Turtle"!==e.opponentPack&&(o.opponentPack=e.opponentPack),e.playerToy&&(o.playerToy=e.playerToy),e.playerToyLevel&&"1"!==e.playerToyLevel&&(o.playerToyLevel=e.playerToyLevel),e.opponentToy&&(o.opponentToy=e.opponentToy),e.opponentToyLevel&&"1"!==e.opponentToyLevel&&(o.opponentToyLevel=e.opponentToyLevel),11!==e.turn&&(o.turn=e.turn),10!==e.playerGoldSpent&&(o.playerGoldSpent=e.playerGoldSpent),10!==e.opponentGoldSpent&&(o.opponentGoldSpent=e.opponentGoldSpent),4!==e.playerRollAmount&&(o.playerRollAmount=e.playerRollAmount),4!==e.opponentRollAmount&&(o.opponentRollAmount=e.opponentRollAmount),0!==e.playerSummonedAmount&&(o.playerSummonedAmount=e.playerSummonedAmount),0!==e.opponentSummonedAmount&&(o.opponentSummonedAmount=e.opponentSummonedAmount),0!==e.playerLevel3Sold&&(o.playerLevel3Sold=e.playerLevel3Sold),0!==e.opponentLevel3Sold&&(o.opponentLevel3Sold=e.opponentLevel3Sold),0!==e.playerTransformationAmount&&(o.playerTransformationAmount=e.playerTransformationAmount),0!==e.opponentTransformationAmount&&(o.opponentTransformationAmount=e.opponentTransformationAmount),e.allPets&&(o.allPets=!0),e.oldStork&&(o.oldStork=!0),e.tokenPets&&(o.tokenPets=!0),e.komodoShuffle&&(o.komodoShuffle=!0),e.mana&&(o.mana=!0),e.triggersConsumed&&(o.triggersConsumed=!0),e.showAdvanced&&(o.showAdvanced=!0),e.showSwallowedLevels&&(o.showSwallowedLevels=!0),e.ailmentEquipment&&(o.ailmentEquipment=!0),e.logFilter&&(o.logFilter=e.logFilter),e.customPacks&&e.customPacks.length>0&&(o.customPacks=e.customPacks);const l=t=>{if(!t||!t.name)return null;const i={name:t.name};return 0!==t.attack&&(i.attack=t.attack),0!==t.health&&(i.health=t.health),0!==t.exp&&(i.exp=t.exp),0!==t.mana&&(i.mana=t.mana),t.equipment&&(i.equipment=t.equipment),t.triggersConsumed&&(i.triggersConsumed=t.triggersConsumed),null!==t.belugaSwallowedPet&&(i.belugaSwallowedPet=t.belugaSwallowedPet),t.timesHurt&&(i.timesHurt=t.timesHurt),i},a=e.playerPets.map(l);a.some(t=>null!==t)&&(o.playerPets=a);const n=e.opponentPets.map(l);return n.some(t=>null!==t)&&(o.opponentPets=n),o}truncateKeys(e){if(Array.isArray(e))return e.map(o=>this.truncateKeys(o));if(null!==e&&"object"==typeof e){const o={};for(const l in e)o[j[l]||l]=this.truncateKeys(e[l]);return o}return e}}var K=c(375);let V=(()=>{class r{parser=new U;parseReplayForCalculator(o,l,a){return this.parser.parseReplayForCalculator(o,l,a)}buildCustomPacksFromGenesis(o,l){return this.parser.buildCustomPacksFromGenesis(o,l)}generateCalculatorLink(o){return this.parser.generateCalculatorLink(o)}static \u0275fac=function(l){return new(l||r)};static \u0275prov=K.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var J=c(8799);function X(r,e){if(1&r&&(s.j41(0,"div",9),s.EFF(1),s.k0s()),2&r){const o=s.XpG();s.R7$(),s.JRh(o.errorMessage)}}let z=(()=>{class r{replayCalcService;http;importFunc;formGroup=new m.gE({calcCode:new m.MJ(null,m.k0.required),turn:new m.MJ(1,m.k0.min(1))});errorMessage="";loading=!1;constructor(o,l){this.replayCalcService=o,this.http=l}ngOnInit(){}submit(){this.errorMessage="";const o=this.formGroup.get("calcCode"),l=o?.value?.trim();if(!l)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let a;o?.setValue("",{emitEvent:!1}),o?.markAsPristine(),o?.markAsUntouched(),o?.updateValueAndValidity({emitEvent:!1});try{a=JSON.parse(l)}catch{if(this.tryReplayPid(l))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((a?.Pid||a?.pid)&&!a?.Actions){const n=a?.Pid??a?.pid,t=Number(a?.T??a?.t??this.formGroup.get("turn").value);return!Number.isFinite(t)||t<=0?void(this.errorMessage="Enter a valid turn number."):(this.loading=!0,void this.http.post("/api/replay-battle",{Pid:n,T:t}).subscribe({next:i=>{this.loading=!1;const P=i?.battle;P?this.importReplayBattle(P,i?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:i=>{this.loading=!1,this.errorMessage=i?.error?.error||"Failed to fetch replay data."}}))}if(a?.UserBoard&&a?.OpponentBoard)this.importReplayBattle(a,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard});else{if(a?.Actions){const n=Number(this.formGroup.get("turn").value??a?.T);if(!Number.isFinite(n)||n<=0)return void(this.errorMessage="Enter a valid turn number.");let t=0,i=null;for(const P of a.Actions)if(0===P?.Type&&P?.Battle&&(t+=1,t===n)){try{i=JSON.parse(P.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${n}.`)}break}return i?void this.importReplayBattle(i,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard}):void(this.errorMessage=`No battle found for turn ${n}.`)}this.importFunc(l)?alert("Import successful"):this.errorMessage="Import failed."}}importReplayBattle(o,l,a){const n=this.replayCalcService.parseReplayForCalculator(o,l,a);this.importFunc(JSON.stringify(n))?alert("Import successful"):this.errorMessage="Import failed."}tryReplayPid(o){const l=o?.trim();if(!l||!/^[a-f0-9-]{16,}$/i.test(l)&&!/^\d+$/.test(l))return!1;const n=Number(this.formGroup.get("turn").value);return!Number.isFinite(n)||n<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.loading=!0,this.http.post("/api/replay-battle",{Pid:l,T:n}).subscribe({next:t=>{this.loading=!1;const i=t?.battle;i?this.importReplayBattle(i,t?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:t=>{this.loading=!1,this.errorMessage=t?.error?.error||"Failed to fetch replay data."}}),!0)}static \u0275fac=function(l){return new(l||r)(s.rXU(V),s.rXU(J.Qq))};static \u0275cmp=s.VBU({type:r,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:14,vars:4,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","text-danger mb-2",4,"ngIf"],[1,"text-danger","mb-2"]],template:function(l,a){1&l&&(s.j41(0,"div",0)(1,"div",1),s.EFF(2," Paste calculator JSON or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),s.k0s(),s.nrm(3,"textarea",2),s.j41(4,"div",3)(5,"div")(6,"label",4),s.EFF(7,"Turn (1-based)"),s.k0s(),s.nrm(8,"input",5),s.k0s(),s.j41(9,"button",6),s.bIt("click",function(){return a.submit()}),s.EFF(10),s.k0s()(),s.j41(11,"div",7),s.EFF(12," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),s.k0s(),s.DNE(13,X,2,1,"div",8),s.k0s()),2&l&&(s.Y8G("formGroup",a.formGroup),s.R7$(9),s.Y8G("disabled",a.loading),s.R7$(),s.SpI(" ",a.loading?"Fetching...":"Import / Replay"," "),s.R7$(3),s.Y8G("ngIf",a.errorMessage))},dependencies:[g.MD,g.bT,m.X1,m.me,m.Q0,m.BC,m.cb,m.VZ,m.j4,m.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return r})()}}]);