"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[680],{7680(it,ye,f){f.d(ye,{ImportCalculatorComponent:()=>Ze});var D=f(9769),A=f(5119),z=f(7312),W=f(8935),Se=f.t(W,2),X=f(7283),be=f.t(X,2),Q=f(3276),we=f.t(Q,2);const N=new Map,Z=new Map;(Q??we).forEach(n=>{const t=String(n.Id),e=Number(n.Tier);N.set(t,n.Name),Number.isFinite(e)&&Z.set(t,{name:n.Name,tier:e})});const Ae=X??be,Te=new Map((W??Se).map(n=>[String(n.Id),n.Name])),Ce=new Map(Ae.map(n=>[String(n.Id),n.Name])),q={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},ke={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showPositionalArgsInLogs:"spa",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",abominationSwallowedPet1:"aSP1",abominationSwallowedPet2:"aSP2",abominationSwallowedPet3:"aSP3",abominationSwallowedPet1BelugaSwallowedPet:"aSP1B",abominationSwallowedPet2BelugaSwallowedPet:"aSP2B",abominationSwallowedPet3BelugaSwallowedPet:"aSP3B",abominationSwallowedPet1SarcasticFringeheadSwallowedPet:"aSP1SFS",abominationSwallowedPet2SarcasticFringeheadSwallowedPet:"aSP2SFS",abominationSwallowedPet3SarcasticFringeheadSwallowedPet:"aSP3SFS",abominationSwallowedPet1Level:"aSP1L",abominationSwallowedPet2Level:"aSP2L",abominationSwallowedPet3Level:"aSP3L",abominationSwallowedPet1TimesHurt:"aSP1T",abominationSwallowedPet2TimesHurt:"aSP2T",abominationSwallowedPet3TimesHurt:"aSP3T",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const n={};for(let t=1;t<=3;t++){const e=`parrotCopyPetAbominationSwallowedPet${t}`,o=`pCPAS${t}`;n[e]=o,n[`${e}BelugaSwallowedPet`]=`${o}B`,n[`${e}Level`]=`${o}L`,n[`${e}TimesHurt`]=`${o}T`,n[`${e}ParrotCopyPet`]=`${o}PCP`,n[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${o}PCPB`;for(let r=1;r<=3;r++){const a=`${e}ParrotCopyPetAbominationSwallowedPet${r}`,i=`${o}PCPAS${r}`;n[a]=i,n[`${a}BelugaSwallowedPet`]=`${i}B`,n[`${a}Level`]=`${i}L`,n[`${a}TimesHurt`]=`${i}T`}}return n})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};function M(n){if("number"==typeof n&&Number.isFinite(n))return n;if("string"==typeof n&&n.trim().length>0){const t=Number(n);return Number.isFinite(t)?t:null}return null}function k(n,t){return M(n)??t}function x(n){return null!==n&&"object"==typeof n&&!Array.isArray(n)}const Fe=new Set(["53","373"]),U=[{pet:"abominationSwallowedPet1",level:"abominationSwallowedPet1Level"},{pet:"abominationSwallowedPet2",level:"abominationSwallowedPet2Level"},{pet:"abominationSwallowedPet3",level:"abominationSwallowedPet3Level"}];function I(n){return"number"==typeof n&&Number.isFinite(n)?String(n):"string"==typeof n&&n.length>0?n:null}function B(n,t){if(Array.isArray(n))return void n.forEach(r=>B(r,t));if(!x(n))return;const e=I(n.Enu),o=n.Abil;e&&Array.isArray(o)&&!Fe.has(e)&&o.forEach(r=>{if(!x(r))return;const a=I(r.Enu);a&&function ve(n,t,e){let o=n.get(t);o||(o=new Map,n.set(t,o)),o.set(e,(o.get(e)??0)+1)}(t,a,e)}),Object.values(n).forEach(r=>{B(r,t)})}function Be(n){let t=null,e=-1;for(const[o,r]of n.entries())(r>e||r===e&&(null===t||o<t))&&(t=o,e=r);return t}function _(n){const t={};for(const[e,o]of n.entries()){const r=Be(o);r&&(t[e]=r)}return t}function $(n){if("string"!=typeof n||0===n.length)return null;try{return JSON.parse(n)}catch{return null}}class Ne{parseReplayForCalculator(t,e,o,r){const a=t?.UserBoard??o?.userBoard,i=t?.OpponentBoard??o?.opponentBoard,l=(p,m,d)=>k(p?.[m],d),u=new Map,c=new Map,b=p=>{p&&Object.entries(p).forEach(([m,d])=>{const y=I(m);if(!y)return;const w="number"==typeof d||"string"==typeof d?String(d):null,g=(w?N.get(w):null)||("string"==typeof d?d:null);g&&u.set(y,g),w&&N.has(w)&&c.set(y,w)})},O=new Map;B(t,O),B(e,O),B(o,O),b(_(O)),b(r?.abilityPetMap??null);const ue=p=>u.get(p)??(p=>{const m=Number(p);if(!Number.isInteger(m))return null;const d=new Map;for(const[T,v]of c.entries()){const P=Number(T),h=Number(v);if(!Number.isInteger(P)||!Number.isInteger(h))continue;const S=Math.abs(P-m);if(0===S||S>2)continue;const C=P-h;d.set(C,(d.get(C)??0)+1)}let y=null,w=0;for(const[T,v]of d.entries())(v>w||v===w&&(null===y||Math.abs(T)<Math.abs(y)))&&(y=T,w=v);if(null===y)return null;const g=String(m-y);return N.get(g)??null})(p),pe=p=>{const m=(p?.Mins?.Items??[]).filter(y=>null!==y),d=Array(5).fill(null);return m.forEach((y,w)=>{let g=M(y.Poi?.x);null===g&&(g=w),g>=0&&g<5&&(d[g]=(p=>{if(!p)return null;const m=p.Enu,d=String(m??0),y=N.get(d)||("string"==typeof m&&m.trim().length>0?m.trim():null),w=k(p.At?.Temp,0),g=k(p.Hp?.Temp,0);let T=null;if("182"===d){const F=p?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(F.length>0){const H=F[0]?.Enu;T=N.get(String(H))||`Pet #${H}`}}const v="373"===d?(p=>{const m={abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},d=(p?.Abil??[]).map((P,h)=>({ability:P,index:h})).filter(P=>null!==P.ability&&null!==I(P.ability?.Enu));if(0===d.length)return m;const y=new Map,w=[];d.forEach(P=>{const h=M(P.ability?.Grop)??0;y.has(h)||(y.set(h,[]),w.push(h)),y.get(h)?.push(P)});const g=new Set,T=[];if(U.forEach((P,h)=>{const S=w[h];if(void 0===S)return void T.push(h);const C=y.get(S);if(!C||0===C.length)return void T.push(h);let R=null,F=null;for(const Pe of C){const he=I(Pe.ability?.Enu);if(!he)continue;const fe=ue(he);if(fe){R=Pe,F=fe;break}}if(!R||!F)return void T.push(h);m[P.pet]=F;const H=M(R.ability?.Lvl);null!==H&&(m[P.level]=H),g.add(R.index)}),0===T.length)return m;const v=d.filter(P=>!g.has(P.index)).map(P=>{const h=I(P.ability?.Enu);if(!h)return null;const S=ue(h);return S?{ownerPetName:S,level:M(P.ability?.Lvl)}:null}).filter(P=>null!==P);return T.forEach((P,h)=>{const S=v[h];if(!S)return;const C=U[P];m[C.pet]=S.ownerPetName,null!==S.level&&(m[C.level]=S.level)}),m})(p):{abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},P=(p=>M(p?.Pow?.SabertoothTigerAbility))(p),h=(p?.Abil??[]).map(F=>M(F?.TrCo)).filter(F=>null!==F),S=p.Perk,C=null!=S?Te.get(String(S))||("string"==typeof S?S:"Unknown Perk"):null,R={name:y,attack:k(p.At?.Perm,0)+w,health:k(p.Hp?.Perm,0)+g,exp:k(p.Exp,0),equipment:C?{name:C}:null,mana:k(p.Mana,0),belugaSwallowedPet:T,sarcasticFringeheadSwallowedPet:null,...v,battlesFought:0,triggersConsumed:h.length>0?Math.max(...h):0};return null!==P&&(R.timesHurt=P),R})(y))}),d.reverse()},ce=p=>{const m=(p?.Rel?.Items??[]).find(d=>!!d?.Enu);if(m){const d=String(m.Enu);return{name:Ce.get(d)||null,level:k(m.Lvl,1)}}return{name:null,level:1}},me=ce(a),de=ce(i),J=this.buildCustomPacksFromGenesis(e,t),ot=this.findCustomPackFromDeck(J,a?.Deck),nt=this.findCustomPackFromDeck(J,i?.Deck);return{playerPack:q[k(a?.Pack,NaN)]||ot?.name||"Turtle",opponentPack:q[k(i?.Pack,NaN)]||nt?.name||"Turtle",playerToy:me.name,playerToyLevel:String(me.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:de.name,opponentToyLevel:String(de.level),opponentHardToy:null,opponentHardToyLevel:1,turn:l(a,"Tur",1)||1,playerGoldSpent:l(a,"GoSp",0)||0,opponentGoldSpent:l(i,"GoSp",0)||0,playerRollAmount:l(a,"Rold",0)||0,opponentRollAmount:l(i,"Rold",0)||0,playerSummonedAmount:l(a,"MiSu",0)||0,opponentSummonedAmount:l(i,"MiSu",0)||0,playerLevel3Sold:l(a,"MSFL",0)||0,opponentLevel3Sold:l(i,"MSFL",0)||0,playerTransformationAmount:l(a,"TrTT",0)||0,opponentTransformationAmount:l(i,"TrTT",0)||0,playerPets:pe(a),opponentPets:pe(i),allPets:!1,logFilter:null,customPacks:J,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showPositionalArgsInLogs:!0,ailmentEquipment:!1}}buildCustomPacksFromGenesis(t,e){const o=[t?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(l=>null!=l&&Array.isArray(l.Minions)),r=[],a=new Set,i=new Set;for(const l of o){const u=l?.Id?String(l.Id):null;if(u&&a.has(u))continue;u&&a.add(u);const c=this.buildCustomPackFromDeck(l,i);c&&r.push({...c,deckId:u})}return r}generateCalculatorLink(t){const e=window.location.origin+window.location.pathname,o=this.stripDefaultValues(t),r=this.truncateKeys(o),a=JSON.stringify(r);return`${e}#c=${btoa(a)}`}buildCustomPackFromDeck(t,e){if(!t||!Array.isArray(t.Minions))return null;const o=t.Minions.map(u=>String(u)),r=Array.isArray(t.Spells)?t.Spells.map(String):[],a={1:[],2:[],3:[],4:[],5:[],6:[]};for(const u of o){const c=Z.get(u);c&&a[c.tier]&&a[c.tier].push(c.name)}const i=u=>{const c=u.slice(0,10);for(;c.length<10;)c.push(null);return c};let l=t.Title||"Custom Pack";if(e.has(l)){let u=2;for(;e.has(`${l} (${u})`);)u+=1;l=`${l} (${u})`}return e.add(l),{name:l,tier1Pets:i(a[1]),tier2Pets:i(a[2]),tier3Pets:i(a[3]),tier4Pets:i(a[4]),tier5Pets:i(a[5]),tier6Pets:i(a[6]),spells:r}}findCustomPackFromDeck(t,e){if(!e)return null;const o=e?.Id?String(e.Id):null;if(o){const a=t.find(i=>i.deckId===o);if(a)return a}const r=e?.Title;return r&&t.find(a=>a.name===r)||null}stripDefaultValues(t){const e={};"Turtle"!==t.playerPack&&(e.playerPack=t.playerPack),"Turtle"!==t.opponentPack&&(e.opponentPack=t.opponentPack),t.playerToy&&(e.playerToy=t.playerToy),t.playerToyLevel&&"1"!==t.playerToyLevel&&(e.playerToyLevel=t.playerToyLevel),t.opponentToy&&(e.opponentToy=t.opponentToy),t.opponentToyLevel&&"1"!==t.opponentToyLevel&&(e.opponentToyLevel=t.opponentToyLevel),11!==t.turn&&(e.turn=t.turn),10!==t.playerGoldSpent&&(e.playerGoldSpent=t.playerGoldSpent),10!==t.opponentGoldSpent&&(e.opponentGoldSpent=t.opponentGoldSpent),4!==t.playerRollAmount&&(e.playerRollAmount=t.playerRollAmount),4!==t.opponentRollAmount&&(e.opponentRollAmount=t.opponentRollAmount),0!==t.playerSummonedAmount&&(e.playerSummonedAmount=t.playerSummonedAmount),0!==t.opponentSummonedAmount&&(e.opponentSummonedAmount=t.opponentSummonedAmount),0!==t.playerLevel3Sold&&(e.playerLevel3Sold=t.playerLevel3Sold),0!==t.opponentLevel3Sold&&(e.opponentLevel3Sold=t.opponentLevel3Sold),0!==t.playerTransformationAmount&&(e.playerTransformationAmount=t.playerTransformationAmount),0!==t.opponentTransformationAmount&&(e.opponentTransformationAmount=t.opponentTransformationAmount),t.allPets&&(e.allPets=!0),t.oldStork&&(e.oldStork=!0),t.tokenPets&&(e.tokenPets=!0),t.komodoShuffle&&(e.komodoShuffle=!0),t.mana&&(e.mana=!0),null!=t.seed&&(e.seed=t.seed),t.triggersConsumed&&(e.triggersConsumed=!0),t.foodsEaten&&(e.foodsEaten=!0),t.showAdvanced&&(e.showAdvanced=!0),t.showTriggerNamesInLogs&&(e.showTriggerNamesInLogs=!0),!1===t.showPositionalArgsInLogs&&(e.showPositionalArgsInLogs=!1),t.ailmentEquipment&&(e.ailmentEquipment=!0),t.logFilter&&(e.logFilter=t.logFilter),t.customPacks.length>0&&(e.customPacks=t.customPacks);const o=i=>{if(!i||!i.name)return null;const l={name:i.name};return"number"==typeof i.attack&&0!==i.attack&&(l.attack=i.attack),"number"==typeof i.health&&0!==i.health&&(l.health=i.health),"number"==typeof i.exp&&0!==i.exp&&(l.exp=i.exp),"number"==typeof i.mana&&0!==i.mana&&(l.mana=i.mana),i.equipment&&(l.equipment=i.equipment),i.triggersConsumed&&(l.triggersConsumed=i.triggersConsumed),i.foodsEaten&&(l.foodsEaten=i.foodsEaten),null!=i.belugaSwallowedPet&&(l.belugaSwallowedPet=i.belugaSwallowedPet),U.forEach(u=>{const c=i[u.pet];null!=c&&(l[u.pet]=c);const b=i[u.level];"number"==typeof b&&1!==b&&(l[u.level]=b)}),i.timesHurt&&(l.timesHurt=i.timesHurt),l},r=t.playerPets.map(o);r.some(i=>null!==i)&&(e.playerPets=r);const a=t.opponentPets.map(o);return a.some(i=>null!==i)&&(e.opponentPets=a),e}truncateKeys(t){if(Array.isArray(t))return t.map(e=>this.truncateKeys(e));if(x(t)){const e={};for(const o of Object.keys(t))e[ke[o]||o]=this.truncateKeys(t[o]);return e}return t}}function te(n){return null!==n&&"object"==typeof n&&!Array.isArray(n)}var s=f(5547),Oe=f(7705),oe=f(467),ne=f(7389);function E(n,t){return new ne.c(t?e=>t.schedule(He,0,{error:n,subscriber:e}):e=>e.error(n))}function He({error:n,subscriber:t}){t.error(n)}var xe=f(4421),L=f(3004);function Y(n){return function(e){const o=new $e(n),r=e.lift(o);return o.caught=r}}class $e{constructor(t){this.selector=t}call(t,e){return e.subscribe(new Ge(t,this.selector,this.caught))}}class Ge extends L.gn{constructor(t,e,o){super(t),this.selector=e,this.caught=o}error(t){if(!this.isStopped){let e;try{e=this.selector(t,this.caught)}catch(a){return void super.error(a)}this._unsubscribeAndRecycle();const o=new L.zA(this);this.add(o);const r=(0,L.tS)(e,o);r!==o&&this.add(r)}}}var re=f(1080);const De=(()=>{function n(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return n.prototype=Object.create(Error.prototype),n})();class Ye{constructor(t,e,o,r){this.waitFor=t,this.absoluteTimeout=e,this.withObservable=o,this.scheduler=r}call(t,e){return e.subscribe(new K(t,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class K extends L.gn{constructor(t,e,o,r,a){super(t),this.absoluteTimeout=e,this.waitFor=o,this.withObservable=r,this.scheduler=a,this.scheduleTimeout()}static dispatchTimeout(t){const{withObservable:e}=t;t._unsubscribeAndRecycle(),t.add((0,L.tS)(e,new L.zA(t)))}scheduleTimeout(){const{action:t}=this;t?this.action=t.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(K.dispatchTimeout,this.waitFor,this))}_next(t){this.absoluteTimeout||this.scheduleTimeout(),super._next(t)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}function G(n,t=re.b){return function je(n,t,e=re.b){return o=>{let r=function Ue(n){return n instanceof Date&&!isNaN(+n)}(n),a=r?+n-e.now():Math.abs(n);return o.lift(new Ye(a,r,t,e))}}(n,E(new De),t)}var Ke=f(9090),ae=f(5006);function le(n){return n.endsWith("/")?n.slice(0,-1):n}function V(n){return`${le("https://sap-library.vercel.app/api")}${n}`}var se=f(7868),Je=f(6980);let ze=(()=>{class n{http;parser=new Ne;constructor(e){this.http=e}parseReplayForCalculator(e,o,r,a){return this.parser.parseReplayForCalculator(e,o,r,a)}buildCustomPacksFromGenesis(e,o){return this.parser.buildCustomPacksFromGenesis(e,o)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}fetchReplayBattle(e,o){return this.fetchReplayBattleFromTurnsApi(e,o).pipe(Y(r=>404!==r?.status&&405!==r?.status?E(r):this.fetchReplayBattleFromReplayBattleApi(e,o)))}fetchReplayBattleFromReplayBattleApi(e,o){return this.http.post(V("/replay-battle"),e).pipe(G(o))}fetchReplayBattleFromTurnsApi(e,o){return this.http.post(V("/replays"),{participationId:e.Pid}).pipe(G(o),(0,Ke.n)(r=>{const a=r?.replayId;return a?this.http.get(function Ve(n){const t=encodeURIComponent(String(n));return`${le("https://sap-library.vercel.app/api")}/replays/${t}/turns`}(a)).pipe(G(o),(0,ae.T)(i=>this.buildReplayBattleResponseFromTurns(i,e.T,a))):E({error:{error:"This replay API does not expose turn battle JSON. Configure a replay backend that supports /api/replay-battle or /api/replays/:id/turns."},status:400})}),Y(r=>E(404===r?.status||400===r?.status?r:{error:{error:"This replay API does not expose turn battle JSON. Configure a replay backend that supports /api/replay-battle or /api/replays/:id/turns."},status:400})))}checkReplayApiHealth(e){var o=this;return(0,oe.A)(function*(){return(yield o.http.get(V("/health")).pipe(G(e),(0,ae.T)(a=>({reachable:!0,isReplayHealthContract:o.isReplayHealthResponse(a)})),Y(()=>(0,xe.of)({reachable:!1,isReplayHealthContract:!1}))).toPromise())??{reachable:!1,isReplayHealthContract:!1}})()}checkReplayApiReachable(e){var o=this;return(0,oe.A)(function*(){return(yield o.checkReplayApiHealth(e)).reachable})()}isReplayHealthResponse(e){return!(!e||"object"!=typeof e)&&("boolean"==typeof e.ok&&"boolean"==typeof e.hasCredentials&&"boolean"==typeof e.tokenLoaded)}toFiniteNumber(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e&&e.trim().length>0){const o=Number(e);return Number.isFinite(o)?o:null}return null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}mapReplayTurnsPet(e){const o=(e?.abilities??[]).map(r=>{const a=this.toReplayId(r?.id);return a?{Enu:a,Lvl:this.toFiniteNumber(r?.level)??1,Grop:this.toFiniteNumber(r?.group)??0,TrCo:this.toFiniteNumber(r?.triggersConsumed)??0}:null}).filter(r=>null!==r);return{Enu:this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perkId),At:{Perm:this.toFiniteNumber(e?.attack?.permanent)??0,Temp:this.toFiniteNumber(e?.attack?.temporary)??0,Max:this.toFiniteNumber(e?.attack?.max)},Hp:{Perm:this.toFiniteNumber(e?.health?.permanent)??0,Temp:this.toFiniteNumber(e?.health?.temporary)??0,Max:this.toFiniteNumber(e?.health?.max)},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:this.toFiniteNumber(e?.cosmetic)??0,Poi:{x:this.toFiniteNumber(e?.slot)??0},Abil:o}}mapReplaySummaryPet(e){return{Enu:this.toReplayId(e?.petName),Lvl:this.toFiniteNumber(e?.level)??1,Exp:0,Perk:this.toReplayId(e?.perk),At:{Perm:this.toFiniteNumber(e?.attack)??0,Temp:0,Max:null},Hp:{Perm:this.toFiniteNumber(e?.health)??0,Temp:0,Max:null},Mana:0,Cosm:0,Poi:{x:this.toFiniteNumber(e?.position)??0},Abil:[]}}mapReplayTurnsSide(e){const o=e?.stats??null;return{Tur:this.toFiniteNumber(o?.turn)??1,Vic:this.toFiniteNumber(o?.victories)??0,Back:this.toFiniteNumber(o?.health)??0,GoSp:this.toFiniteNumber(o?.goldSpent)??0,Rold:this.toFiniteNumber(o?.rolls)??0,MiSu:this.toFiniteNumber(o?.summons)??0,MSFL:this.toFiniteNumber(o?.level3Sold)??0,TrTT:this.toFiniteNumber(o?.transformed)??0,Mins:{Items:(e?.pets??[]).map(r=>this.mapReplayTurnsPet(r))}}}mapReplaySummarySide(e,o){const r="player"===o,a=(r?e?.pets?.player:e?.pets?.opponent)??[];return{Tur:this.toFiniteNumber(e?.turnNumber)??this.toFiniteNumber(e?.turn)??1,Vic:0,Back:0,GoSp:this.toFiniteNumber(r?e?.playerGoldSpent:e?.opponentGoldSpent)??0,Rold:this.toFiniteNumber(r?e?.playerRolls:e?.opponentRolls)??0,MiSu:this.toFiniteNumber(r?e?.playerSummons:e?.opponentSummons)??0,MSFL:0,TrTT:0,Mins:{Items:a.map(i=>this.mapReplaySummaryPet(i))}}}buildReplayBattleResponseFromTurns(e,o,r){const a=e?.turns??[],u=a.find(b=>this.toFiniteNumber(b?.turn)===o||this.toFiniteNumber(b?.turnNumber)===o)??(o>0?a[o-1]:null);if(!u)throw{error:{error:`Replay ${r} does not contain turn ${o}.`},status:404};const c=!(!u?.user&&!u?.opponent);return{battle:{UserBoard:c?this.mapReplayTurnsSide(u.user):this.mapReplaySummarySide(u,"player"),OpponentBoard:c?this.mapReplayTurnsSide(u.opponent):this.mapReplaySummarySide(u,"opponent")},genesisBuildModel:e?.genesisBuildModel,abilityPetMap:e?.abilityPetMap??null}}static \u0275fac=function(o){return new(o||n)(se.KVO(Je.Qq))};static \u0275prov=se.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();const We=(n,t,e)=>({"text-success":n,"text-danger":t,"text-warning":e});function Xe(n,t){if(1&n&&(s.j41(0,"div",10),s.EFF(1),s.k0s()),2&n){const e=s.XpG();s.Y8G("ngClass",s.sMw(2,We,"success"===e.statusTone,"error"===e.statusTone,"warning"===e.statusTone)),s.R7$(),s.SpI(" ",e.statusMessage," ")}}function Qe(n,t){if(1&n&&(s.j41(0,"div",11),s.EFF(1),s.k0s()),2&n){const e=s.XpG();s.R7$(),s.JRh(e.errorMessage)}}let Ze=(()=>{class n{replayCalcService;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new A.gE({calcCode:new A.MJ(null,A.k0.required),turn:new A.MJ(1,A.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;statusTimer=null;constructor(e,o){this.replayCalcService=e,this.cdr=o}ngOnInit(){}submit(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode"),o=e?.value?.trim();if(!o)return void(this.errorMessage="Paste calculator JSON or replay JSON.");e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});const r=function Ee(n){const t=n?.trim();if(!t||!t.startsWith("SAPR1:"))return null;const e=t.slice(6);if(!e)return null;try{const o=JSON.parse(function Le(n){const t=n.replace(/-/g,"+").replace(/_/g,"/"),o=`${t}${"=".repeat((4-t.length%4)%4)}`,r=atob(o),a=Uint8Array.from(r,i=>i.charCodeAt(0));return(new TextDecoder).decode(a)}(e));return te(o)&&1===o.version&&te(o.battle)?{battle:o.battle,genesisBuildModel:o.genesisBuildModel??null,abilityPetMap:o.abilityPetMap??null,turn:"number"==typeof o.turn&&Number.isFinite(o.turn)?o.turn:void 0}:null}catch{return null}}(o);if(r?.battle)return void this.importReplayBattle(r.battle,r.genesisBuildModel,void 0,{abilityPetMap:r.abilityPetMap??null});let a;try{a=JSON.parse(o)}catch{if(this.importFunc(o))return void this.setStatus("Import successful.","success");if(this.tryReplayPid(o))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((a?.Pid||a?.pid)&&!a?.Actions){const i=a?.Pid??a?.pid,l=Number(a?.T??a?.t??this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(u=>{if(!u.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();u.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:i,T:l},this.replayTimeoutMs).pipe((0,z.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:c=>{const b=c?.battle;b?this.importReplayBattle(b,c?.genesisBuildModel,void 0,{abilityPetMap:c?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:c=>{if("TimeoutError"===c?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=c?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(a?.UserBoard&&a?.OpponentBoard)this.importReplayBattle(a,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard},{abilityPetMap:a?.AbilityPetMap??null});else{if(a?.Actions){const i=Number(this.formGroup.get("turn").value??a?.T);if(!Number.isFinite(i)||i<=0)return void(this.errorMessage="Enter a valid turn number.");let l=0,u=null;for(const b of a.Actions)if(0===b?.Type&&b?.Battle&&(l+=1,l===i)){try{u=JSON.parse(b.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${i}.`)}break}if(!u)return void(this.errorMessage=`No battle found for turn ${i}.`);const c=a?.AbilityPetMap??function Re(n){const t=new Map;return(n??[]).forEach(e=>{const o=$(e?.Build),r=$(e?.Battle),a=$(e?.Mode);B(o,t),B(r,t),B(a,t)}),_(t)}(a.Actions);return void this.importReplayBattle(u,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard},{abilityPetMap:c})}this.importFunc(o)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(e,o,r,a,i){const l=this.replayCalcService.parseReplayForCalculator(e,o,r,a);this.importFunc(JSON.stringify(l),i)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const o=e?.trim();if(!o||!/^[a-f0-9-]{16,}$/i.test(o)&&!/^\d+$/.test(o))return!1;const a=Number(this.formGroup.get("turn").value);return!Number.isFinite(a)||a<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(i=>{if(!i.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();i.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:o,T:a},this.replayTimeoutMs).pipe((0,z.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:l=>{const u=l?.battle;u?this.importReplayBattle(u,l?.genesisBuildModel,void 0,{abilityPetMap:l?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:l=>{if("TimeoutError"===l?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=l?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}setLoading(e){this.loading=e,this.cdr.markForCheck()}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,o){this.statusMessage=e,this.statusTone=o,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(o){return new(o||n)(s.rXU(ze),s.rXU(Oe.gRc))};static \u0275cmp=s.VBU({type:n,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:19,vars:6,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(o,r){1&o&&(s.j41(0,"div",0)(1,"div",1),s.EFF(2," Paste calculator export code (compressed), replay export code, calculator JSON, or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),s.k0s(),s.j41(3,"div",1),s.EFF(4," Example Pid: "),s.j41(5,"code"),s.EFF(6),s.k0s()(),s.nrm(7,"textarea",2),s.j41(8,"div",3)(9,"div")(10,"label",4),s.EFF(11,"Turn (1-based)"),s.k0s(),s.nrm(12,"input",5),s.k0s(),s.j41(13,"button",6),s.bIt("click",function(){return r.submit()}),s.EFF(14),s.k0s()(),s.j41(15,"div",7),s.EFF(16," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),s.k0s(),s.DNE(17,Xe,2,6,"div",8)(18,Qe,2,1,"div",9),s.k0s()),2&o&&(s.Y8G("formGroup",r.formGroup),s.R7$(6),s.JRh(r.pidExample),s.R7$(7),s.Y8G("disabled",r.loading),s.R7$(),s.SpI(" ",r.loading?"Fetching...":"Import"," "),s.R7$(3),s.Y8G("ngIf",r.statusMessage),s.R7$(),s.Y8G("ngIf",r.errorMessage))},dependencies:[D.MD,D.YU,D.bT,A.X1,A.me,A.Q0,A.BC,A.cb,A.VZ,A.j4,A.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return n})()}}]);