"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[737],{1737(_,R,d){d.d(R,{ImportCalculatorComponent:()=>z});var g=d(9769),w=d(5119),i=d(5547),T=d(8935),G=d.t(T,2),h=d(7283),E=d.t(h,2),v=d(3276),O=d.t(v,2);const b=new Map,k=new Map;(v??O).forEach(P=>{const o=String(P.Id),e=Number(P.Tier);b.set(o,P.Name),Number.isFinite(e)&&k.set(o,{name:P.Name,tier:e})});const x=h??E,$=new Map((T??G).map(P=>[String(P.Id),P.Name])),j=new Map(x.map(P=>[String(P.Id),P.Name])),B={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},U={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",triggersConsumed:"tc",showAdvanced:"sa",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",parrotCopyPetAbominationSwallowedPet1:"pCPAS1",parrotCopyPetAbominationSwallowedPet2:"pCPAS2",parrotCopyPetAbominationSwallowedPet3:"pCPAS3",parrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"pCPAS1B",parrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"pCPAS2B",parrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"pCPAS3B",parrotCopyPetAbominationSwallowedPet1Level:"pCPAS1L",parrotCopyPetAbominationSwallowedPet2Level:"pCPAS2L",parrotCopyPetAbominationSwallowedPet3Level:"pCPAS3L",parrotCopyPetAbominationSwallowedPet1TimesHurt:"pCPAS1T",parrotCopyPetAbominationSwallowedPet2TimesHurt:"pCPAS2T",parrotCopyPetAbominationSwallowedPet3TimesHurt:"pCPAS3T",parrotCopyPetAbominationSwallowedPet1ParrotCopyPet:"pCPAS1PCP",parrotCopyPetAbominationSwallowedPet2ParrotCopyPet:"pCPAS2PCP",parrotCopyPetAbominationSwallowedPet3ParrotCopyPet:"pCPAS3PCP",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"pCPAS1PCPB",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"pCPAS2PCPB",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"pCPAS3PCPB",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"pCPAS1PCPAS1",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"pCPAS1PCPAS2",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"pCPAS1PCPAS3",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"pCPAS2PCPAS1",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"pCPAS2PCPAS2",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"pCPAS2PCPAS3",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"pCPAS3PCPAS1",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"pCPAS3PCPAS2",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"pCPAS3PCPAS3",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"pCPAS1PCPAS1B",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"pCPAS1PCPAS2B",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"pCPAS1PCPAS3B",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"pCPAS2PCPAS1B",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"pCPAS2PCPAS2B",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"pCPAS2PCPAS3B",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"pCPAS3PCPAS1B",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"pCPAS3PCPAS2B",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"pCPAS3PCPAS3B",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"pCPAS1PCPAS1L",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"pCPAS1PCPAS2L",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"pCPAS1PCPAS3L",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"pCPAS2PCPAS1L",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"pCPAS2PCPAS2L",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"pCPAS2PCPAS3L",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"pCPAS3PCPAS1L",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"pCPAS3PCPAS2L",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"pCPAS3PCPAS3L",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"pCPAS1PCPAS1T",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"pCPAS1PCPAS2T",parrotCopyPetAbominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"pCPAS1PCPAS3T",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"pCPAS2PCPAS1T",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"pCPAS2PCPAS2T",parrotCopyPetAbominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"pCPAS2PCPAS3T",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"pCPAS3PCPAS1T",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"pCPAS3PCPAS2T",parrotCopyPetAbominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"pCPAS3PCPAS3T",abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};class V{parseReplayForCalculator(o,e,l){const a=o?.UserBoard??l?.userBoard,n=o?.OpponentBoard??l?.opponentBoard,t=(m,s,u=null)=>{const A=m?.[s];return void 0===A?u:A},S=m=>{const s=(m?.Mins?.Items||[]).filter(Boolean),u=Array(5).fill(null);return s.forEach((A,c)=>{let C=A.Poi?.x;void 0===C&&(C=c),C>=0&&C<5&&(u[C]=(m=>{if(!m)return null;const s=String(m.Enu??0),u=m.At?.Temp??0,A=m.Hp?.Temp??0;let c=null;if("182"===s){const y=m?.MiMs?.Lsts?.WhiteWhaleAbility||[];if(y.length>0){const N=y[0]?.Enu;c=b.get(String(N))||`Pet #${N}`}}const C=(m=>{const s=m?.Pow?.SabertoothTigerAbility;return Number.isFinite(s)?s:null})(m),M=(m?.Abil||[]).map(y=>y?.TrCo).filter(y=>Number.isFinite(y)),I={name:b.get(s)||null,attack:(m.At?.Perm??0)+u,health:(m.Hp?.Perm??0)+A,exp:m.Exp||0,equipment:m.Perk?{name:$.get(String(m.Perk))||"Unknown Perk"}:null,mana:m.Mana||0,belugaSwallowedPet:c,sarcasticFringeheadSwallowedPet:null,abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1,battlesFought:0,triggersConsumed:M.length>0?Math.max(...M):0};return null!==C&&(I.timesHurt=C),I})(A))}),u.reverse()},L=m=>{const s=(m?.Rel?.Items||[]).find(u=>u&&u.Enu);if(s){const u=String(s.Enu);return{name:j.get(u)||null,level:s.Lvl||1}}return{name:null,level:1}},F=L(a),H=L(n),f=this.buildCustomPacksFromGenesis(e,o),W=this.findCustomPackFromDeck(f,a?.Deck),Q=this.findCustomPackFromDeck(f,n?.Deck);return{playerPack:B[a?.Pack]||W?.name||"Turtle",opponentPack:B[n?.Pack]||Q?.name||"Turtle",playerToy:F.name,playerToyLevel:String(F.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:H.name,opponentToyLevel:String(H.level),opponentHardToy:null,opponentHardToyLevel:1,turn:t(a,"Tur",1)||1,playerGoldSpent:t(a,"GoSp",0)||0,opponentGoldSpent:t(n,"GoSp",0)||0,playerRollAmount:t(a,"Rold",0)||0,opponentRollAmount:t(n,"Rold",0)||0,playerSummonedAmount:t(a,"MiSu",0)||0,opponentSummonedAmount:t(n,"MiSu",0)||0,playerLevel3Sold:t(a,"MSFL",0)||0,opponentLevel3Sold:t(n,"MSFL",0)||0,playerTransformationAmount:t(a,"TrTT",0)||0,opponentTransformationAmount:t(n,"TrTT",0)||0,playerPets:S(a),opponentPets:S(n),allPets:!1,logFilter:null,customPacks:f,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,triggersConsumed:!0,showAdvanced:!0,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(o,e){const l=[o?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(r=>r&&Array.isArray(r.Minions)),a=[],n=new Set,t=new Set;for(const r of l){const p=r?.Id?String(r.Id):null;if(p&&n.has(p))continue;p&&n.add(p);const S=this.buildCustomPackFromDeck(r,t);S&&a.push({...S,deckId:p})}return a}generateCalculatorLink(o){const e=window.location.origin+window.location.pathname,l=this.stripDefaultValues(o),a=this.truncateKeys(l),n=JSON.stringify(a);return`${e}?c=${btoa(n)}`}buildCustomPackFromDeck(o,e){if(!o||!Array.isArray(o.Minions))return null;const l=o.Minions.map(p=>String(p)),a=Array.isArray(o.Spells)?o.Spells.slice():[],n={1:[],2:[],3:[],4:[],5:[],6:[]};for(const p of l){const S=k.get(p);S&&n[S.tier]&&n[S.tier].push(S.name)}const t=p=>{const S=p.slice(0,10);for(;S.length<10;)S.push(null);return S};let r=o.Title||"Custom Pack";if(e.has(r)){let p=2;for(;e.has(`${r} (${p})`);)p+=1;r=`${r} (${p})`}return e.add(r),{name:r,tier1Pets:t(n[1]),tier2Pets:t(n[2]),tier3Pets:t(n[3]),tier4Pets:t(n[4]),tier5Pets:t(n[5]),tier6Pets:t(n[6]),spells:a}}findCustomPackFromDeck(o,e){if(!e)return null;const l=e?.Id?String(e.Id):null;if(l){const n=o.find(t=>t.deckId===l);if(n)return n}const a=e?.Title;return a&&o.find(n=>n.name===a)||null}stripDefaultValues(o){const e={};"Turtle"!==o.playerPack&&(e.playerPack=o.playerPack),"Turtle"!==o.opponentPack&&(e.opponentPack=o.opponentPack),o.playerToy&&(e.playerToy=o.playerToy),o.playerToyLevel&&"1"!==o.playerToyLevel&&(e.playerToyLevel=o.playerToyLevel),o.opponentToy&&(e.opponentToy=o.opponentToy),o.opponentToyLevel&&"1"!==o.opponentToyLevel&&(e.opponentToyLevel=o.opponentToyLevel),11!==o.turn&&(e.turn=o.turn),10!==o.playerGoldSpent&&(e.playerGoldSpent=o.playerGoldSpent),10!==o.opponentGoldSpent&&(e.opponentGoldSpent=o.opponentGoldSpent),4!==o.playerRollAmount&&(e.playerRollAmount=o.playerRollAmount),4!==o.opponentRollAmount&&(e.opponentRollAmount=o.opponentRollAmount),0!==o.playerSummonedAmount&&(e.playerSummonedAmount=o.playerSummonedAmount),0!==o.opponentSummonedAmount&&(e.opponentSummonedAmount=o.opponentSummonedAmount),0!==o.playerLevel3Sold&&(e.playerLevel3Sold=o.playerLevel3Sold),0!==o.opponentLevel3Sold&&(e.opponentLevel3Sold=o.opponentLevel3Sold),0!==o.playerTransformationAmount&&(e.playerTransformationAmount=o.playerTransformationAmount),0!==o.opponentTransformationAmount&&(e.opponentTransformationAmount=o.opponentTransformationAmount),o.allPets&&(e.allPets=!0),o.oldStork&&(e.oldStork=!0),o.tokenPets&&(e.tokenPets=!0),o.komodoShuffle&&(e.komodoShuffle=!0),o.mana&&(e.mana=!0),o.triggersConsumed&&(e.triggersConsumed=!0),o.showAdvanced&&(e.showAdvanced=!0),o.showSwallowedLevels&&(e.showSwallowedLevels=!0),o.ailmentEquipment&&(e.ailmentEquipment=!0),o.logFilter&&(e.logFilter=o.logFilter),o.customPacks&&o.customPacks.length>0&&(e.customPacks=o.customPacks);const l=t=>{if(!t||!t.name)return null;const r={name:t.name};return 0!==t.attack&&(r.attack=t.attack),0!==t.health&&(r.health=t.health),0!==t.exp&&(r.exp=t.exp),0!==t.mana&&(r.mana=t.mana),t.equipment&&(r.equipment=t.equipment),t.triggersConsumed&&(r.triggersConsumed=t.triggersConsumed),null!==t.belugaSwallowedPet&&(r.belugaSwallowedPet=t.belugaSwallowedPet),t.timesHurt&&(r.timesHurt=t.timesHurt),r},a=o.playerPets.map(l);a.some(t=>null!==t)&&(e.playerPets=a);const n=o.opponentPets.map(l);return n.some(t=>null!==t)&&(e.opponentPets=n),e}truncateKeys(o){if(Array.isArray(o))return o.map(e=>this.truncateKeys(e));if(null!==o&&"object"==typeof o){const e={};for(const l in o)e[U[l]||l]=this.truncateKeys(o[l]);return e}return o}}var Y=d(375);let K=(()=>{class P{parser=new V;parseReplayForCalculator(e,l,a){return this.parser.parseReplayForCalculator(e,l,a)}buildCustomPacksFromGenesis(e,l){return this.parser.buildCustomPacksFromGenesis(e,l)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}static \u0275fac=function(l){return new(l||P)};static \u0275prov=Y.jDH({token:P,factory:P.\u0275fac,providedIn:"root"})}return P})();var J=d(8799);function X(P,o){if(1&P&&(i.j41(0,"div",9),i.EFF(1),i.k0s()),2&P){const e=i.XpG();i.R7$(),i.JRh(e.errorMessage)}}let z=(()=>{class P{replayCalcService;http;importFunc;formGroup=new w.gE({calcCode:new w.MJ(null,w.k0.required),turn:new w.MJ(1,w.k0.min(1))});errorMessage="";loading=!1;constructor(e,l){this.replayCalcService=e,this.http=l}ngOnInit(){}submit(){this.errorMessage="";const e=this.formGroup.get("calcCode"),l=e?.value?.trim();if(!l)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let a;e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});try{a=JSON.parse(l)}catch{if(this.tryReplayPid(l))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((a?.Pid||a?.pid)&&!a?.Actions){const n=a?.Pid??a?.pid,t=Number(a?.T??a?.t??this.formGroup.get("turn").value);return!Number.isFinite(t)||t<=0?void(this.errorMessage="Enter a valid turn number."):(this.loading=!0,void this.http.post("/api/replay-battle",{Pid:n,T:t}).subscribe({next:r=>{this.loading=!1;const p=r?.battle;p?this.importReplayBattle(p,r?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:r=>{this.loading=!1,this.errorMessage=r?.error?.error||"Failed to fetch replay data."}}))}if(a?.UserBoard&&a?.OpponentBoard)this.importReplayBattle(a,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard});else{if(a?.Actions){const n=Number(this.formGroup.get("turn").value??a?.T);if(!Number.isFinite(n)||n<=0)return void(this.errorMessage="Enter a valid turn number.");let t=0,r=null;for(const p of a.Actions)if(0===p?.Type&&p?.Battle&&(t+=1,t===n)){try{r=JSON.parse(p.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${n}.`)}break}return r?void this.importReplayBattle(r,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard}):void(this.errorMessage=`No battle found for turn ${n}.`)}this.importFunc(l)?alert("Import successful"):this.errorMessage="Import failed."}}importReplayBattle(e,l,a){const n=this.replayCalcService.parseReplayForCalculator(e,l,a);this.importFunc(JSON.stringify(n))?alert("Import successful"):this.errorMessage="Import failed."}tryReplayPid(e){const l=e?.trim();if(!l||!/^[a-f0-9-]{16,}$/i.test(l)&&!/^\d+$/.test(l))return!1;const n=Number(this.formGroup.get("turn").value);return!Number.isFinite(n)||n<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.loading=!0,this.http.post("/api/replay-battle",{Pid:l,T:n}).subscribe({next:t=>{this.loading=!1;const r=t?.battle;r?this.importReplayBattle(r,t?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:t=>{this.loading=!1,this.errorMessage=t?.error?.error||"Failed to fetch replay data."}}),!0)}static \u0275fac=function(l){return new(l||P)(i.rXU(K),i.rXU(J.Qq))};static \u0275cmp=i.VBU({type:P,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:14,vars:4,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","text-danger mb-2",4,"ngIf"],[1,"text-danger","mb-2"]],template:function(l,a){1&l&&(i.j41(0,"div",0)(1,"div",1),i.EFF(2," Paste calculator JSON or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),i.k0s(),i.nrm(3,"textarea",2),i.j41(4,"div",3)(5,"div")(6,"label",4),i.EFF(7,"Turn (1-based)"),i.k0s(),i.nrm(8,"input",5),i.k0s(),i.j41(9,"button",6),i.bIt("click",function(){return a.submit()}),i.EFF(10),i.k0s()(),i.j41(11,"div",7),i.EFF(12," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),i.k0s(),i.DNE(13,X,2,1,"div",8),i.k0s()),2&l&&(i.Y8G("formGroup",a.formGroup),i.R7$(9),i.Y8G("disabled",a.loading),i.R7$(),i.SpI(" ",a.loading?"Fetching...":"Import / Replay"," "),i.R7$(3),i.Y8G("ngIf",a.errorMessage))},dependencies:[g.MD,g.bT,w.X1,w.me,w.Q0,w.BC,w.cb,w.VZ,w.j4,w.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return P})()}}]);