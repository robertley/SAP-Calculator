"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[737],{1737(ee,$,c){c.d($,{ImportCalculatorComponent:()=>W});var C=c(9769),m=c(5119),r=c(5547),T=c(8935),G=c.t(T,2),h=c(7283),H=c.t(h,2),v=c(3276),E=c.t(v,2);const A=new Map,k=new Map;(v??E).forEach(i=>{const o=String(i.Id),e=Number(i.Tier);A.set(o,i.Name),Number.isFinite(e)&&k.set(o,{name:i.Name,tier:e})});const x=h??H,D=new Map((T??G).map(i=>[String(i.Id),i.Name])),Y=new Map(x.map(i=>[String(i.Id),i.Name])),L={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},j={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",triggersConsumed:"tc",showAdvanced:"sa",showSwallowedLevels:"swl",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const i={};for(let o=1;o<=3;o++){const e=`parrotCopyPetAbominationSwallowedPet${o}`,n=`pCPAS${o}`;i[e]=n,i[`${e}BelugaSwallowedPet`]=`${n}B`,i[`${e}Level`]=`${n}L`,i[`${e}TimesHurt`]=`${n}T`,i[`${e}ParrotCopyPet`]=`${n}PCP`,i[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${n}PCPB`;for(let a=1;a<=3;a++){const l=`${e}ParrotCopyPetAbominationSwallowedPet${a}`,t=`${n}PCPAS${a}`;i[l]=t,i[`${l}BelugaSwallowedPet`]=`${t}B`,i[`${l}Level`]=`${t}L`,i[`${l}TimesHurt`]=`${t}T`}}return i})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"};class U{parseReplayForCalculator(o,e,n){const a=o?.UserBoard??n?.userBoard,l=o?.OpponentBoard??n?.opponentBoard,t=(u,d,S=null)=>{const y=u?.[d];return void 0===y?S:y},p=u=>{const d=(u?.Mins?.Items||[]).filter(Boolean),S=Array(5).fill(null);return d.forEach((y,b)=>{let w=y.Poi?.x;void 0===w&&(w=b),w>=0&&w<5&&(S[w]=(u=>{if(!u)return null;const d=String(u.Enu??0),S=u.At?.Temp??0,y=u.Hp?.Temp??0;let b=null;if("182"===d){const f=u?.MiMs?.Lsts?.WhiteWhaleAbility||[];if(f.length>0){const R=f[0]?.Enu;b=A.get(String(R))||`Pet #${R}`}}const w=(u=>{const d=u?.Pow?.SabertoothTigerAbility;return Number.isFinite(d)?d:null})(u),F=(u?.Abil||[]).map(f=>f?.TrCo).filter(f=>Number.isFinite(f)),N={name:A.get(d)||null,attack:(u.At?.Perm??0)+S,health:(u.Hp?.Perm??0)+y,exp:u.Exp||0,equipment:u.Perk?{name:D.get(String(u.Perk))||"Unknown Perk"}:null,mana:u.Mana||0,belugaSwallowedPet:b,sarcasticFringeheadSwallowedPet:null,abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1,battlesFought:0,triggersConsumed:F.length>0?Math.max(...F):0};return null!==w&&(N.timesHurt=w),N})(y))}),S.reverse()},B=u=>{const d=(u?.Rel?.Items||[]).find(S=>S&&S.Enu);if(d){const S=String(d.Enu);return{name:Y.get(S)||null,level:d.Lvl||1}}return{name:null,level:1}},M=B(a),I=B(l),g=this.buildCustomPacksFromGenesis(e,o),Q=this.findCustomPackFromDeck(g,a?.Deck),q=this.findCustomPackFromDeck(g,l?.Deck);return{playerPack:L[a?.Pack]||Q?.name||"Turtle",opponentPack:L[l?.Pack]||q?.name||"Turtle",playerToy:M.name,playerToyLevel:String(M.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:I.name,opponentToyLevel:String(I.level),opponentHardToy:null,opponentHardToyLevel:1,turn:t(a,"Tur",1)||1,playerGoldSpent:t(a,"GoSp",0)||0,opponentGoldSpent:t(l,"GoSp",0)||0,playerRollAmount:t(a,"Rold",0)||0,opponentRollAmount:t(l,"Rold",0)||0,playerSummonedAmount:t(a,"MiSu",0)||0,opponentSummonedAmount:t(l,"MiSu",0)||0,playerLevel3Sold:t(a,"MSFL",0)||0,opponentLevel3Sold:t(l,"MSFL",0)||0,playerTransformationAmount:t(a,"TrTT",0)||0,opponentTransformationAmount:t(l,"TrTT",0)||0,playerPets:p(a),opponentPets:p(l),allPets:!1,logFilter:null,customPacks:g,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,triggersConsumed:!0,showAdvanced:!0,showSwallowedLevels:!1,ailmentEquipment:!1}}buildCustomPacksFromGenesis(o,e){const n=[o?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(s=>s&&Array.isArray(s.Minions)),a=[],l=new Set,t=new Set;for(const s of n){const P=s?.Id?String(s.Id):null;if(P&&l.has(P))continue;P&&l.add(P);const p=this.buildCustomPackFromDeck(s,t);p&&a.push({...p,deckId:P})}return a}generateCalculatorLink(o){const e=window.location.origin+window.location.pathname,n=this.stripDefaultValues(o),a=this.truncateKeys(n),l=JSON.stringify(a);return`${e}?c=${btoa(l)}`}buildCustomPackFromDeck(o,e){if(!o||!Array.isArray(o.Minions))return null;const n=o.Minions.map(P=>String(P)),a=Array.isArray(o.Spells)?o.Spells.slice():[],l={1:[],2:[],3:[],4:[],5:[],6:[]};for(const P of n){const p=k.get(P);p&&l[p.tier]&&l[p.tier].push(p.name)}const t=P=>{const p=P.slice(0,10);for(;p.length<10;)p.push(null);return p};let s=o.Title||"Custom Pack";if(e.has(s)){let P=2;for(;e.has(`${s} (${P})`);)P+=1;s=`${s} (${P})`}return e.add(s),{name:s,tier1Pets:t(l[1]),tier2Pets:t(l[2]),tier3Pets:t(l[3]),tier4Pets:t(l[4]),tier5Pets:t(l[5]),tier6Pets:t(l[6]),spells:a}}findCustomPackFromDeck(o,e){if(!e)return null;const n=e?.Id?String(e.Id):null;if(n){const l=o.find(t=>t.deckId===n);if(l)return l}const a=e?.Title;return a&&o.find(l=>l.name===a)||null}stripDefaultValues(o){const e={};"Turtle"!==o.playerPack&&(e.playerPack=o.playerPack),"Turtle"!==o.opponentPack&&(e.opponentPack=o.opponentPack),o.playerToy&&(e.playerToy=o.playerToy),o.playerToyLevel&&"1"!==o.playerToyLevel&&(e.playerToyLevel=o.playerToyLevel),o.opponentToy&&(e.opponentToy=o.opponentToy),o.opponentToyLevel&&"1"!==o.opponentToyLevel&&(e.opponentToyLevel=o.opponentToyLevel),11!==o.turn&&(e.turn=o.turn),10!==o.playerGoldSpent&&(e.playerGoldSpent=o.playerGoldSpent),10!==o.opponentGoldSpent&&(e.opponentGoldSpent=o.opponentGoldSpent),4!==o.playerRollAmount&&(e.playerRollAmount=o.playerRollAmount),4!==o.opponentRollAmount&&(e.opponentRollAmount=o.opponentRollAmount),0!==o.playerSummonedAmount&&(e.playerSummonedAmount=o.playerSummonedAmount),0!==o.opponentSummonedAmount&&(e.opponentSummonedAmount=o.opponentSummonedAmount),0!==o.playerLevel3Sold&&(e.playerLevel3Sold=o.playerLevel3Sold),0!==o.opponentLevel3Sold&&(e.opponentLevel3Sold=o.opponentLevel3Sold),0!==o.playerTransformationAmount&&(e.playerTransformationAmount=o.playerTransformationAmount),0!==o.opponentTransformationAmount&&(e.opponentTransformationAmount=o.opponentTransformationAmount),o.allPets&&(e.allPets=!0),o.oldStork&&(e.oldStork=!0),o.tokenPets&&(e.tokenPets=!0),o.komodoShuffle&&(e.komodoShuffle=!0),o.mana&&(e.mana=!0),o.triggersConsumed&&(e.triggersConsumed=!0),o.showAdvanced&&(e.showAdvanced=!0),o.showSwallowedLevels&&(e.showSwallowedLevels=!0),o.ailmentEquipment&&(e.ailmentEquipment=!0),o.logFilter&&(e.logFilter=o.logFilter),o.customPacks&&o.customPacks.length>0&&(e.customPacks=o.customPacks);const n=t=>{if(!t||!t.name)return null;const s={name:t.name};return 0!==t.attack&&(s.attack=t.attack),0!==t.health&&(s.health=t.health),0!==t.exp&&(s.exp=t.exp),0!==t.mana&&(s.mana=t.mana),t.equipment&&(s.equipment=t.equipment),t.triggersConsumed&&(s.triggersConsumed=t.triggersConsumed),null!==t.belugaSwallowedPet&&(s.belugaSwallowedPet=t.belugaSwallowedPet),t.timesHurt&&(s.timesHurt=t.timesHurt),s},a=o.playerPets.map(n);a.some(t=>null!==t)&&(e.playerPets=a);const l=o.opponentPets.map(n);return l.some(t=>null!==t)&&(e.opponentPets=l),e}truncateKeys(o){if(Array.isArray(o))return o.map(e=>this.truncateKeys(e));if(null!==o&&"object"==typeof o){const e={};for(const n in o)e[j[n]||n]=this.truncateKeys(o[n]);return e}return o}}var K=c(375);let V=(()=>{class i{parser=new U;parseReplayForCalculator(e,n,a){return this.parser.parseReplayForCalculator(e,n,a)}buildCustomPacksFromGenesis(e,n){return this.parser.buildCustomPacksFromGenesis(e,n)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=K.jDH({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var X=c(8799);function J(i,o){if(1&i&&(r.j41(0,"div",10),r.EFF(1),r.k0s()),2&i){const e=r.XpG();r.Y8G("ngClass","success"===e.statusTone?"text-success":"text-danger"),r.R7$(),r.SpI(" ",e.statusMessage," ")}}function z(i,o){if(1&i&&(r.j41(0,"div",11),r.EFF(1),r.k0s()),2&i){const e=r.XpG();r.R7$(),r.JRh(e.errorMessage)}}let W=(()=>{class i{replayCalcService;http;importFunc;formGroup=new m.gE({calcCode:new m.MJ(null,m.k0.required),turn:new m.MJ(1,m.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;statusTimer=null;constructor(e,n){this.replayCalcService=e,this.http=n}ngOnInit(){}submit(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode"),n=e?.value?.trim();if(!n)return void(this.errorMessage="Paste calculator JSON or replay JSON.");let a;e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});try{a=JSON.parse(n)}catch{if(this.tryReplayPid(n))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((a?.Pid||a?.pid)&&!a?.Actions){const l=a?.Pid??a?.pid,t=Number(a?.T??a?.t??this.formGroup.get("turn").value);return!Number.isFinite(t)||t<=0?void(this.errorMessage="Enter a valid turn number."):(this.loading=!0,void this.http.post("/api/replay-battle",{Pid:l,T:t}).subscribe({next:s=>{this.loading=!1;const P=s?.battle;P?this.importReplayBattle(P,s?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:s=>{this.loading=!1,this.errorMessage=s?.error?.error||"Failed to fetch replay data."}}))}if(a?.UserBoard&&a?.OpponentBoard)this.importReplayBattle(a,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard});else{if(a?.Actions){const l=Number(this.formGroup.get("turn").value??a?.T);if(!Number.isFinite(l)||l<=0)return void(this.errorMessage="Enter a valid turn number.");let t=0,s=null;for(const P of a.Actions)if(0===P?.Type&&P?.Battle&&(t+=1,t===l)){try{s=JSON.parse(P.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${l}.`)}break}return s?void this.importReplayBattle(s,a?.GenesisBuildModel,{userBoard:a?.UserBoard,opponentBoard:a?.OpponentBoard}):void(this.errorMessage=`No battle found for turn ${l}.`)}this.importFunc(n)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(e,n,a){const l=this.replayCalcService.parseReplayForCalculator(e,n,a);this.importFunc(JSON.stringify(l))?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const n=e?.trim();if(!n||!/^[a-f0-9-]{16,}$/i.test(n)&&!/^\d+$/.test(n))return!1;const l=Number(this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.loading=!0,this.http.post("/api/replay-battle",{Pid:n,T:l}).subscribe({next:t=>{this.loading=!1;const s=t?.battle;s?this.importReplayBattle(s,t?.genesisBuildModel):this.errorMessage="Replay lookup failed to return a battle."},error:t=>{this.loading=!1,this.errorMessage=t?.error?.error||"Failed to fetch replay data."}}),!0)}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,n){this.statusMessage=e,this.statusTone=n,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(n){return new(n||i)(r.rXU(V),r.rXU(X.Qq))};static \u0275cmp=r.VBU({type:i,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:15,vars:5,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(n,a){1&n&&(r.j41(0,"div",0)(1,"div",1),r.EFF(2," Paste calculator JSON or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),r.k0s(),r.nrm(3,"textarea",2),r.j41(4,"div",3)(5,"div")(6,"label",4),r.EFF(7,"Turn (1-based)"),r.k0s(),r.nrm(8,"input",5),r.k0s(),r.j41(9,"button",6),r.bIt("click",function(){return a.submit()}),r.EFF(10),r.k0s()(),r.j41(11,"div",7),r.EFF(12," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),r.k0s(),r.DNE(13,J,2,2,"div",8)(14,z,2,1,"div",9),r.k0s()),2&n&&(r.Y8G("formGroup",a.formGroup),r.R7$(9),r.Y8G("disabled",a.loading),r.R7$(),r.SpI(" ",a.loading?"Fetching...":"Import / Replay"," "),r.R7$(3),r.Y8G("ngIf",a.statusMessage),r.R7$(),r.Y8G("ngIf",a.errorMessage))},dependencies:[C.MD,C.YU,C.bT,m.X1,m.me,m.Q0,m.BC,m.cb,m.VZ,m.j4,m.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return i})()}}]);