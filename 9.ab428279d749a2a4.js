"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[9],{4009(Qt,Xe,T){T.d(Xe,{ImportCalculatorComponent:()=>Jt});var ae=T(9769),L=T(5119),Se=T(7312),ge=T(8935),Qe=T.t(ge,2),Ae=T(7283),Ze=T.t(Ae,2),qe=T(3276),Ne=T.t(qe,2);const H=new Map,Te=new Map,Ce=new Map;function Me(n){return null!==n&&"object"==typeof n}const ee=Ne.default??Ne;(Array.isArray(ee)?ee:Me(ee)?Object.values(ee).filter(n=>"object"==typeof n&&null!==n&&("Id"in n||"id"in n)):[]).forEach(n=>{if(!Me(n))return;const t=n,e=String(t.Id??t.id),o=Number(t.Tier??t.tier),i=t.Name??t.name;if(i){H.set(e,i);const r=i.toLowerCase().replace(/[^a-z0-9]/g,"");Ce.set(r,e)}Number.isFinite(o)&&i&&Te.set(e,{name:i,tier:o})});const tt=Ae??Ze,nt=new Map((ge??Qe).map(n=>[String(n.Id),n.Name])),ot=new Map(tt.map(n=>[String(n.Id),n.Name])),le={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},rt={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showPositionalArgsInLogs:"spa",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",abominationSwallowedPet1:"aSP1",abominationSwallowedPet2:"aSP2",abominationSwallowedPet3:"aSP3",abominationSwallowedPet1BelugaSwallowedPet:"aSP1B",abominationSwallowedPet2BelugaSwallowedPet:"aSP2B",abominationSwallowedPet3BelugaSwallowedPet:"aSP3B",abominationSwallowedPet1SarcasticFringeheadSwallowedPet:"aSP1SFS",abominationSwallowedPet2SarcasticFringeheadSwallowedPet:"aSP2SFS",abominationSwallowedPet3SarcasticFringeheadSwallowedPet:"aSP3SFS",abominationSwallowedPet1Level:"aSP1L",abominationSwallowedPet2Level:"aSP2L",abominationSwallowedPet3Level:"aSP3L",abominationSwallowedPet1TimesHurt:"aSP1T",abominationSwallowedPet2TimesHurt:"aSP2T",abominationSwallowedPet3TimesHurt:"aSP3T",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const n={};for(let t=1;t<=3;t++){const e=`parrotCopyPetAbominationSwallowedPet${t}`,o=`pCPAS${t}`;n[e]=o,n[`${e}BelugaSwallowedPet`]=`${o}B`,n[`${e}Level`]=`${o}L`,n[`${e}TimesHurt`]=`${o}T`,n[`${e}ParrotCopyPet`]=`${o}PCP`,n[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${o}PCPB`;for(let i=1;i<=3;i++){const r=`${e}ParrotCopyPetAbominationSwallowedPet${i}`,a=`${o}PCPAS${i}`;n[r]=a,n[`${r}BelugaSwallowedPet`]=`${a}B`,n[`${r}Level`]=`${a}L`,n[`${r}TimesHurt`]=`${a}T`}}return n})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"},Fe={338:[368],373:[403],635:[669],763:[853,970]},it={actionfigure:294,airpalmtree:511,balloon:479,boot:299,bowlingball:300,brokenpiggybank:310,broom:301,cardboardbox:302,television:491,toymouse:327};function Be(n){return!!n&&"object"==typeof n&&!Array.isArray(n)}function h(n){return Be(n)?n:null}function ke(n,t){if(n)return n instanceof Map?n.get(t):n[t]}function se(n){const t=Number(n);return Number.isFinite(t)?Math.trunc(t):null}function w(n,t=0){const e=Number(n);return Number.isFinite(e)?e:t}function te(n,t){if(null==n)return null;if(Be(n)){const o=[n.id,n.Id,n.petId,n.PetId,n.enum,n.Enum,n.Enu,n.enu];for(const r of o){if(null==r)continue;const a=w(r,NaN);if(Number.isFinite(a))return Math.trunc(a)}const i=n.name??n.Name;if("string"==typeof i){const r=i.toLowerCase().replace(/[^a-z0-9]/g,""),s=se(ke(t?.petIdsByName??t?.PET_IDS_BY_NAME,r));if(null!==s)return s}return null}if("string"==typeof n){const o=n.trim();if(""===o)return null;const i=w(o,NaN);if(Number.isFinite(i))return Math.trunc(i);const r=o.toLowerCase().replace(/[^a-z0-9]/g,""),s=se(ke(t?.petIdsByName??t?.PET_IDS_BY_NAME,r));return null!==s?s:null}const e=w(n,NaN);return Number.isFinite(e)?Math.trunc(e):null}function ne(n){const t=[],e=new Set;for(const o of n){if(null==o)continue;const i=Number(o);if(!Number.isFinite(i))continue;const r=Math.trunc(i);e.has(r)||(e.add(r),t.push(r))}return t}function X(n,t){const e=t?.abilityIdsByPetId??{},o=String(n);return ne([...Array.isArray(e[o])?e[o]??[]:[],...Array.isArray(Fe[o])?Fe[o]:[]])}function z(n){const t=te(n);if(!Number.isFinite(t))return null;const e={Enu:t},o=h(n);if(!o)return e;const i=w(o.attack??o.At??o.at,NaN);Number.isFinite(i)&&(e.At=Math.max(0,Math.round(i)));const r=w(o.health??o.Hp??o.hp,NaN);Number.isFinite(r)&&(e.Hp=Math.max(1,Math.round(r)));const a=w(o.mana??o.Mana,NaN);Number.isFinite(a)&&(e.Mana=Math.max(0,Math.round(a)));const l=w(o.level??o.lvl??o.Lvl,NaN);Number.isFinite(l)&&(e.Lvl=Math.max(1,Math.min(3,Math.round(l))));const s=w(o.exp??o.Exp,NaN);Number.isFinite(s)&&(e.Exp=Math.max(0,Math.round(s)));const p=function at(n){const t=Number(n);return Number.isFinite(t)?t:null}(o.perk??o.Perk);return null!==p&&(e.Perk=p),e}function ue(n,t){const e=[{petKey:"abominationSwallowedPet1",levelKey:"abominationSwallowedPet1Level",belugaKey:"abominationSwallowedPet1BelugaSwallowedPet",sfsKey:"abominationSwallowedPet1SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet2",levelKey:"abominationSwallowedPet2Level",belugaKey:"abominationSwallowedPet2BelugaSwallowedPet",sfsKey:"abominationSwallowedPet2SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet3",levelKey:"abominationSwallowedPet3Level",belugaKey:"abominationSwallowedPet3BelugaSwallowedPet",sfsKey:"abominationSwallowedPet3SarcasticFringeheadSwallowedPet"}],o=h(n),i=[];for(const a of e){const l=o?.[a.petKey],s=te(l,t);if(!Number.isFinite(s))continue;const u=h(l),p=X(s,t),b=z(l)??{Enu:s},g=w(o?.[a.levelKey],NaN);if(Number.isFinite(g)&&(b.Lvl=Math.max(1,Math.min(3,Math.round(g)))),182===s){const S=z(o?.[a.belugaKey]??u?.belugaSwallowedPet??null);if(S){const v=X(182,t),K={WhiteWhaleAbility:[{...S}]};for(const D of v)K[String(D)]=[{...S}];b.MiMs={Lsts:K}}}if(763===s){const S=z(o?.[a.sfsKey]??u?.sarcasticFringeheadSwallowedPet??null);if(S){const v={SarcasticFringeheadAbility:[{...S}]};b.MiMs={Lsts:v}}}i.push({swallowedPetId:s,swallowedAbilityEnums:p,memoryEntry:b,belugaSwallowedEntry:b.MiMs??null})}const r=Array.isArray(o?.abominationSwallowedPets)?o?.abominationSwallowedPets:[];for(const a of r){const l=te(a,t);if(!Number.isFinite(l))continue;const s=X(l,t);i.push({swallowedPetId:l,swallowedAbilityEnums:s,memoryEntry:z(a)??{Enu:l},belugaSwallowedEntry:null})}return i}function Re(n,t){const e=ue(n,t),o=[];for(const i of e)Array.isArray(i.swallowedAbilityEnums)&&o.push(...i.swallowedAbilityEnums);return ne(o)}function Ee(n,t){const e=h(n);if(!e)return null;for(const[o,i]of Object.entries(e)){if(!t(o))continue;const r=w(i,NaN);if(Number.isFinite(r))return r}return null}function ce(n){if("string"==typeof n)return n;const t=h(n);return"string"==typeof t?.name?t.name:null}function M(n){if("number"==typeof n&&Number.isFinite(n))return n;if("string"==typeof n&&n.trim().length>0){const t=Number(n);return Number.isFinite(t)?t:null}return null}function F(n,t){return M(n)??t}function J(n){return null!==n&&"object"==typeof n&&!Array.isArray(n)}function j(n){return J(n)?n:null}(()=>{try{if("1"===localStorage.getItem("sapReplayDebug"))return!0}catch{return!1}try{return"1"===new URL(window.location.href).searchParams.get("sapReplayDebug")}catch{return!1}})();const Pt=new Set(["53","373"]),pe=[{pet:"abominationSwallowedPet1",level:"abominationSwallowedPet1Level"},{pet:"abominationSwallowedPet2",level:"abominationSwallowedPet2Level"},{pet:"abominationSwallowedPet3",level:"abominationSwallowedPet3Level"}];function $(n){return"number"==typeof n&&Number.isFinite(n)?String(n):"string"==typeof n&&n.length>0?n:null}function G(n,t){if(Array.isArray(n))return void n.forEach(i=>G(i,t));if(!J(n))return;const e=$(n.Enu),o=n.Abil;e&&Array.isArray(o)&&!Pt.has(e)&&o.forEach(i=>{if(!J(i))return;const r=$(i.Enu);r&&function bt(n,t,e){let o=n.get(t);o||(o=new Map,n.set(t,o)),o.set(e,(o.get(e)??0)+1)}(t,r,e)}),Object.values(n).forEach(i=>{G(i,t)})}function ht(n){let t=null,e=-1;for(const[o,i]of n.entries())(i>e||i===e&&(null===t||o<t))&&(t=o,e=i);return t}function ve(n){const t={};for(const[e,o]of n.entries()){const i=ht(o);i&&(t[e]=i)}return t}function oe(n){if(J(n)||Array.isArray(n))return n;if("string"!=typeof n||0===n.length)return null;try{return JSON.parse(n)}catch{return null}}function de(n){const t=new Map;return(n??[]).forEach(e=>{const o=oe(e?.Build),i=oe(e?.Battle),r=oe(e?.Mode);G(o,t),G(i,t),G(r,t)}),ve(t)}!function St(){const n=new Map;Object.entries(le).forEach(([t,e])=>{if("string"!=typeof e)return;const o=Number(t);Number.isFinite(o)&&n.set(e.toLowerCase(),o)})}();class me{parseReplayForCalculator(t,e,o,i){console.log(`[ReplayCalcParser] PETS_BY_ID size: ${H.size}`);const r=t?.UserBoard??o?.userBoard,a=t?.OpponentBoard??o?.opponentBoard,l=(m,d,P)=>F(m?.[d],P),s=new Map,u=new Map,p=m=>{m&&Object.entries(m).forEach(([d,P])=>{const y=$(d);if(!y)return;let A="number"==typeof P||"string"==typeof P?String(P):null;if(A&&!H.has(A)){const k=Number(A);if(Number.isInteger(k)){const E=k-30;if(Number.isInteger(E)&&E>0){const f=String(E);H.has(f)&&(A=f)}}}const C=(A?H.get(A):null)||("string"==typeof P?P:null);C&&s.set(y,C),A&&H.has(A)&&u.set(y,A)})},b=new Map;G(t,b),G(e,b),G(o,b),p(ve(b)),p(i?.abilityPetMap??null);const I=m=>s.get(m)??(m=>{const d=Number(m);if(!Number.isInteger(d))return null;const P=new Map;for(const[k,E]of u.entries()){const f=Number(k),N=Number(E);if(!Number.isInteger(f)||!Number.isInteger(N))continue;const R=Math.abs(f-d);if(0===R||R>2)continue;const O=f-N;P.set(O,(P.get(O)??0)+1)}let y=null,A=0;for(const[k,E]of P.entries())(E>A||E===A&&(null===y||Math.abs(k)<Math.abs(y)))&&(y=k,A=E);if(null===y)return null;const C=String(d-y);return H.get(C)??null})(m),K=m=>{if(!m)return null;const d=j(m),P={PET_IDS_BY_NAME:Ce},y=m.Enu??d?.enu??d?.Id??d?.id,A=te(y,P),C=String(null!==A?A:y??0),k=H.get(C)||("string"==typeof d?.name?d.name:null)||("string"==typeof d?.Name?d.Name:null)||("string"==typeof y&&y.trim().length>0?y.trim():`Pet #${C}`);console.log(`[ReplayCalcParser] Pet Enu:${y} -> Id:${C} -> Name:${k}`);const E=m.At??j(d?.at),f=m.Hp??j(d?.hp),N=j(E),R=j(f),O=F(E?.Temp??N?.temp,0),W=F(f?.Temp??R?.temp,0);let _=null;if("182"===C){const B=m?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(B.length>0){const x=B[0]?.Enu;_=H.get(String(x))||`Pet #${x}`}}const ie="373"===C?(m=>{const d={abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},P=(m?.Abil??[]).map((f,N)=>({ability:f,index:N})).filter(f=>null!==f.ability&&null!==$(f.ability?.Enu));if(0===P.length)return d;const y=new Map,A=[];P.forEach(f=>{const N=M(f.ability?.Grop)??0;y.has(N)||(y.set(N,[]),A.push(N)),y.get(N)?.push(f)});const C=new Set,k=[];if(pe.forEach((f,N)=>{const R=A[N];if(void 0===R)return void k.push(N);const O=y.get(R);if(!O||0===O.length)return void k.push(N);let W=null,_=null;for(const U of O){const Q=$(U.ability?.Enu);if(!Q)continue;const Z=I(Q);if(Z){W=U,_=Z;break}}if(!W||!_)return void k.push(N);d[f.pet]=_;const ie=M(W.ability?.Lvl);null!==ie&&(d[f.level]=ie),C.add(W.index)}),0===k.length)return d;const E=P.filter(f=>!C.has(f.index)).map(f=>{const N=$(f.ability?.Enu);if(!N)return null;const R=I(N);return R?{ownerPetName:R,level:M(f.ability?.Lvl)}:null}).filter(f=>null!==f);return k.forEach((f,N)=>{const R=E[N];if(!R)return;const O=pe[f];d[O.pet]=R.ownerPetName,null!==R.level&&(d[O.level]=R.level)}),d})(m):{abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},U={};for(const[B,x]of u.entries()){const Y=String(x);U[Y]=U[Y]||[],U[Y].push(String(B))}P.abilityIdsByPetId=U;const Q=(m=>function pt(n){const t=h(n),e=h(t?.Pow),o=h(t?.pow),i=[t?.timesHurt,t?.TimesHurt,e?.SabertoothTigerAbility,o?.SabertoothTigerAbility];for(const r of i){const a=w(r,NaN);if(Number.isFinite(a))return Math.max(0,Math.round(a))}return null}(m))(m),Z=(()=>{const B=function ct(n){const t=h(n),e=[t?.triggersConsumed,t?.TrCo,t?.trco,t?.triggerConsumed];for(const s of e){const u=w(s,NaN);if(Number.isFinite(u))return Math.max(0,Math.round(u))}const o=s=>{const u=s.toLowerCase(),p=u.includes("trigger")||u.includes("trig"),b=u.includes("consum"),g=["trgc","trgcn","trc","trcn","trco"].includes(u);return p&&b||g},i=[t,h(t?.pow),h(t?.Pow)];for(const s of i){const u=Ee(s,o);if(Number.isFinite(u))return Math.max(0,Math.round(u))}const r=Array.isArray(t?.abilities)?t?.abilities:[],a=Array.isArray(t?.Abil)?t?.Abil:[],l=[];for(const s of[r,a])for(const u of s){const p=Ee(u,o);Number.isFinite(p)&&l.push(p)}return l.length>0?Math.max(0,Math.round(Math.max(...l))):null}(m);return null===B?[]:[B]})(),q=m.Perk,_e=null!=q?nt.get(String(q))||("string"==typeof q?q:"Unknown Perk"):null,we={name:k,attack:F(E?.Perm??N?.perm??d?.attack,0)+O,health:F(f?.Perm??R?.perm??d?.health,0)+W,exp:(()=>{const B=M(m.Exp);if(null!==B&&B>0)return B;const x=M(m.Lvl);return 2===x?2:3===x?5:B??0})(),equipment:_e?{name:_e}:null,mana:F(m.Mana,0),belugaSwallowedPet:_,sarcasticFringeheadSwallowedPet:null,...ie,battlesFought:0,triggersConsumed:Z.length>0?Math.max(...Z):0};if("373"===String(C))try{const B=function st(n,t,e){const o=ue(n,e);if(0===o.length)return null;const i=function Ie(n,t,e){const o=h(n),i=Array.isArray(o?.Abil)?o?.Abil:[],r=Array.isArray(o?.abilities)?o?.abilities:[],a=[o?.abilityEnum,o?.abilityId,h(i[0])?.Enu,h(r[0])?.Enu];for(const s of a){const u=w(s,NaN);if(Number.isFinite(u))return Math.trunc(u)}if(373===t||338===t){const s=function lt(n,t){const e=Re(n,t);return e.length>0?e[0]:null}(n,e);if(Number.isFinite(s))return Math.trunc(s)}const l=X(t,e);return l.length>0?l[0]:null}(n,t,e),r=null!==i?[Math.trunc(i)]:[],a={};for(const l of o){const s=ne(Array.isArray(l.swallowedAbilityEnums)?l.swallowedAbilityEnums:[]),u=s.length>0?s:r;if(0!==u.length)for(const p of u){const b=String(p);Array.isArray(a[b])||(a[b]=[]);const I=182===l.swallowedPetId&&Array.isArray(l.swallowedAbilityEnums)&&l.swallowedAbilityEnums.includes(p)&&l.belugaSwallowedEntry?l.belugaSwallowedEntry:l.memoryEntry;a[b].push(I)}}return 0===Object.keys(a).length?null:{Lsts:a}}(m,Number(C),P);if(B){const x=we;x.abominationMemory=B;const Y=Re(m,P);Array.isArray(Y)&&Y.length>0&&(x.abominationInferredAbilityEnums=Y)}}catch(B){}return null!==Q&&(we.timesHurt=Q),we},D=m=>{const d=m?.Mins?.Items??[],P=Array(5).fill(null);return d.forEach((y,A)=>{if(!y)return;let C=F(y.Poi?.x,-1);-1===C&&(C=A),C>=0&&C<5&&(P[C]=K(y))}),P.reverse()},Je=m=>{const d=(m?.Rel?.Items??[]).find(P=>!!P);if(d){const P=j(d),y=function Le(n,t){if(null==n)return null;const e=h(n);if(e){const l=[e.id,e.toyId,e.enum,e.Enu];for(const s of l){const u=w(s,NaN);if(Number.isFinite(u))return Math.trunc(u)}}const o=ce(n)??n,i="string"==typeof o?o.toLowerCase().replace(/[^a-z0-9]/g,""):"";if(!i)return null;const r=se(t?.toyIdsByName?.[i]);if(null!==r)return r;const a=it[i];return Number.isFinite(a)?a:null}(d)??null;return{name:(y?ot.get(String(y)):ce(d))||null,level:F(P?.Lvl,1)}}return{name:null,level:1}},Ve=Je(r),We=Je(a),he=this.buildCustomPacksFromGenesis(e,t),Vt=this.findCustomPackFromDeck(he,r?.Deck),Wt=this.findCustomPackFromDeck(he,a?.Deck);return{playerPack:le[F(r?.Pack,NaN)]||Vt?.name||"Turtle",opponentPack:le[F(a?.Pack,NaN)]||Wt?.name||"Turtle",playerToy:Ve.name,playerToyLevel:String(Ve.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:We.name,opponentToyLevel:String(We.level),opponentHardToy:null,opponentHardToyLevel:1,turn:l(r,"Tur",1)||1,playerGoldSpent:l(r,"GoSp",0)||0,opponentGoldSpent:l(a,"GoSp",0)||0,playerRollAmount:l(r,"Rold",0)||0,opponentRollAmount:l(a,"Rold",0)||0,playerSummonedAmount:l(r,"MiSu",0)||0,opponentSummonedAmount:l(a,"MiSu",0)||0,playerLevel3Sold:l(r,"MSFL",0)||0,opponentLevel3Sold:l(a,"MSFL",0)||0,playerTransformationAmount:l(r,"TrTT",0)||0,opponentTransformationAmount:l(a,"TrTT",0)||0,playerPets:D(r),opponentPets:D(a),allPets:!1,logFilter:null,customPacks:he,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showPositionalArgsInLogs:!0,ailmentEquipment:!1}}buildCustomPacksFromGenesis(t,e){const o=[t?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(l=>null!=l&&Array.isArray(l.Minions)),i=[],r=new Set,a=new Set;for(const l of o){const s=l?.Id?String(l.Id):null;if(s&&r.has(s))continue;s&&r.add(s);const u=this.buildCustomPackFromDeck(l,a);u&&i.push({...u,deckId:s})}return i}generateCalculatorLink(t){const e=window.location.origin+window.location.pathname,o=this.stripDefaultValues(t),i=this.truncateKeys(o),r=JSON.stringify(i);return`${e}#c=${btoa(r)}`}buildCustomPackFromDeck(t,e){if(!t||!Array.isArray(t.Minions))return null;const o=t.Minions.map(s=>String(s)),i=Array.isArray(t.Spells)?t.Spells.map(String):[],r={1:[],2:[],3:[],4:[],5:[],6:[]};for(const s of o){const u=Te.get(s);u&&r[u.tier]&&r[u.tier].push(u.name)}const a=s=>{const u=s.slice(0,10);for(;u.length<10;)u.push(null);return u};let l=t.Title||"Custom Pack";if(e.has(l)){let s=2;for(;e.has(`${l} (${s})`);)s+=1;l=`${l} (${s})`}return e.add(l),{name:l,tier1Pets:a(r[1]),tier2Pets:a(r[2]),tier3Pets:a(r[3]),tier4Pets:a(r[4]),tier5Pets:a(r[5]),tier6Pets:a(r[6]),spells:i}}findCustomPackFromDeck(t,e){if(!e)return null;const o=e?.Id?String(e.Id):null;if(o){const r=t.find(a=>a.deckId===o);if(r)return r}const i=e?.Title;return i&&t.find(r=>r.name===i)||null}stripDefaultValues(t){const e={};"Turtle"!==t.playerPack&&(e.playerPack=t.playerPack),"Turtle"!==t.opponentPack&&(e.opponentPack=t.opponentPack),t.playerToy&&(e.playerToy=t.playerToy),t.playerToyLevel&&"1"!==t.playerToyLevel&&(e.playerToyLevel=t.playerToyLevel),t.opponentToy&&(e.opponentToy=t.opponentToy),t.opponentToyLevel&&"1"!==t.opponentToyLevel&&(e.opponentToyLevel=t.opponentToyLevel),11!==t.turn&&(e.turn=t.turn),10!==t.playerGoldSpent&&(e.playerGoldSpent=t.playerGoldSpent),10!==t.opponentGoldSpent&&(e.opponentGoldSpent=t.opponentGoldSpent),4!==t.playerRollAmount&&(e.playerRollAmount=t.playerRollAmount),4!==t.opponentRollAmount&&(e.opponentRollAmount=t.opponentRollAmount),0!==t.playerSummonedAmount&&(e.playerSummonedAmount=t.playerSummonedAmount),0!==t.opponentSummonedAmount&&(e.opponentSummonedAmount=t.opponentSummonedAmount),0!==t.playerLevel3Sold&&(e.playerLevel3Sold=t.playerLevel3Sold),0!==t.opponentLevel3Sold&&(e.opponentLevel3Sold=t.opponentLevel3Sold),0!==t.playerTransformationAmount&&(e.playerTransformationAmount=t.playerTransformationAmount),0!==t.opponentTransformationAmount&&(e.opponentTransformationAmount=t.opponentTransformationAmount),t.allPets&&(e.allPets=!0),t.oldStork&&(e.oldStork=!0),t.tokenPets&&(e.tokenPets=!0),t.komodoShuffle&&(e.komodoShuffle=!0),t.mana&&(e.mana=!0),null!=t.seed&&(e.seed=t.seed),t.triggersConsumed&&(e.triggersConsumed=!0),t.foodsEaten&&(e.foodsEaten=!0),t.showAdvanced&&(e.showAdvanced=!0),t.showTriggerNamesInLogs&&(e.showTriggerNamesInLogs=!0),!1===t.showPositionalArgsInLogs&&(e.showPositionalArgsInLogs=!1),t.ailmentEquipment&&(e.ailmentEquipment=!0),t.logFilter&&(e.logFilter=t.logFilter),t.customPacks.length>0&&(e.customPacks=t.customPacks);const o=a=>{if(!a||!a.name)return null;const l={name:a.name};return"number"==typeof a.attack&&0!==a.attack&&(l.attack=a.attack),"number"==typeof a.health&&0!==a.health&&(l.health=a.health),"number"==typeof a.exp&&0!==a.exp&&(l.exp=a.exp),"number"==typeof a.mana&&0!==a.mana&&(l.mana=a.mana),a.equipment&&(l.equipment=a.equipment),a.triggersConsumed&&(l.triggersConsumed=a.triggersConsumed),a.foodsEaten&&(l.foodsEaten=a.foodsEaten),null!=a.belugaSwallowedPet&&(l.belugaSwallowedPet=a.belugaSwallowedPet),pe.forEach(s=>{const u=a[s.pet];null!=u&&(l[s.pet]=u);const p=a[s.level];"number"==typeof p&&1!==p&&(l[s.level]=p)}),a.timesHurt&&(l.timesHurt=a.timesHurt),l},i=t.playerPets.map(o);i.some(a=>null!==a)&&(e.playerPets=i);const r=t.opponentPets.map(o);return r.some(a=>null!==a)&&(e.opponentPets=r),e}truncateKeys(t){if(Array.isArray(t))return t.map(e=>this.truncateKeys(e));if(J(t)){const e={};for(const o of Object.keys(t))e[rt[o]||o]=this.truncateKeys(t[o]);return e}return t}}function He(n){return null!==n&&"object"==typeof n&&!Array.isArray(n)}var c=T(5547),Rt=T(7705),$e=T(467),De=T(7389);function re(n,t){return new De.c(t?e=>t.schedule(It,0,{error:n,subscriber:e}):e=>e.error(n))}function It({error:n,subscriber:t}){t.error(n)}var Et=T(4421),V=T(3004);function ye(n){return function(e){const o=new Lt(n),i=e.lift(o);return o.caught=i}}class Lt{constructor(t){this.selector=t}call(t,e){return e.subscribe(new vt(t,this.selector,this.caught))}}class vt extends V.gn{constructor(t,e,o){super(t),this.selector=e,this.caught=o}error(t){if(!this.isStopped){let e;try{e=this.selector(t,this.caught)}catch(r){return void super.error(r)}this._unsubscribeAndRecycle();const o=new V.zA(this);this.add(o);const i=(0,V.tS)(e,o);i!==o&&this.add(i)}}}var Ge=T(1080);const Ot=(()=>{function n(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return n.prototype=Object.create(Error.prototype),n})();class $t{constructor(t,e,o,i){this.waitFor=t,this.absoluteTimeout=e,this.withObservable=o,this.scheduler=i}call(t,e){return e.subscribe(new Pe(t,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class Pe extends V.gn{constructor(t,e,o,i,r){super(t),this.absoluteTimeout=e,this.waitFor=o,this.withObservable=i,this.scheduler=r,this.scheduleTimeout()}static dispatchTimeout(t){const{withObservable:e}=t;t._unsubscribeAndRecycle(),t.add((0,V.tS)(e,new V.zA(t)))}scheduleTimeout(){const{action:t}=this;t?this.action=t.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(Pe.dispatchTimeout,this.waitFor,this))}_next(t){this.absoluteTimeout||this.scheduleTimeout(),super._next(t)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}function be(n,t=Ge.b){return function Ht(n,t,e=Ge.b){return o=>{let i=function xt(n){return n instanceof Date&&!isNaN(+n)}(n),r=i?+n-e.now():Math.abs(n);return o.lift(new $t(r,i,t,e))}}(n,re(new Ot),t)}var Dt=T(9090),je=T(5006);function Ue(n){return n.endsWith("/")?n.slice(0,-1):n}function Ye(n){return`${Ue("https://sap-library.vercel.app/api")}${n}`}var ze=T(7868),jt=T(6980);let Kt=(()=>{class n{http;parser=new me;constructor(e){this.http=e}parseReplayForCalculator(e,o,i,r){return this.parser.parseReplayForCalculator(e,o,i,r)}buildCustomPacksFromGenesis(e,o){return this.parser.buildCustomPacksFromGenesis(e,o)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}fetchReplayBattle(e,o){return this.fetchReplayBattleFromTurnsApi(e,o)}fetchReplayBattleFromTurnsApi(e,o){const i=String(e.Pid);return this.fetchReplayBattleByReplayId(i,e.T,o).pipe(ye(r=>404!==r?.status?this.normalizeReplayFetchError(r):this.http.post(Ye("/replays"),{Pid:i,participationId:i}).pipe(be(o),(0,Dt.n)(a=>{const l=a?.replayId;return l?this.fetchReplayBattleByReplayId(String(l),e.T,o):re({error:{error:"Replay indexing did not return a replayId."},status:400})}),ye(a=>this.normalizeReplayFetchError(a)))))}fetchReplayBattleByReplayId(e,o,i){return this.http.get(function Gt(n){const t=encodeURIComponent(String(n));return`${Ue("https://sap-library.vercel.app/api")}/replays/${t}/turns`}(e)).pipe(be(i),(0,je.T)(r=>this.buildReplayBattleResponseFromTurns(r,o,e)))}normalizeReplayFetchError(e){const o=e?.status;return re(404===o||400===o?e:{error:{error:"This replay API does not expose turn battle JSON. Configure a replay backend that supports /api/replay-battle or /api/replays/:id/turns."},status:400})}checkReplayApiHealth(e){var o=this;return(0,$e.A)(function*(){return(yield o.http.get(Ye("/health")).pipe(be(e),(0,je.T)(r=>({reachable:!0,isReplayHealthContract:o.isReplayHealthResponse(r)})),ye(()=>(0,Et.of)({reachable:!1,isReplayHealthContract:!1}))).toPromise())??{reachable:!1,isReplayHealthContract:!1}})()}checkReplayApiReachable(e){var o=this;return(0,$e.A)(function*(){return(yield o.checkReplayApiHealth(e)).reachable})()}isReplayHealthResponse(e){return!(!e||"object"!=typeof e)&&("boolean"==typeof e.ok&&"boolean"==typeof e.hasCredentials&&"boolean"==typeof e.tokenLoaded)}toFiniteNumber(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e&&e.trim().length>0){const o=Number(e);return Number.isFinite(o)?o:null}return null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}isRecord(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}parseJsonObject(e){if("string"!=typeof e||0===e.trim().length)return null;try{const o=JSON.parse(e);return this.isRecord(o)?o:null}catch{return null}}mapReplayTurnsPet(e){const o=(e?.abilities??[]).map(i=>{const r=this.toReplayId(i?.id);return r?{Enu:r,Lvl:this.toFiniteNumber(i?.level)??1,Grop:this.toFiniteNumber(i?.group)??0,TrCo:this.toFiniteNumber(i?.triggersConsumed)??0}:null}).filter(i=>null!==i);return{Enu:this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perkId),At:{Perm:this.toFiniteNumber(e?.attack?.permanent)??0,Temp:this.toFiniteNumber(e?.attack?.temporary)??0,Max:this.toFiniteNumber(e?.attack?.max)},Hp:{Perm:this.toFiniteNumber(e?.health?.permanent)??0,Temp:this.toFiniteNumber(e?.health?.temporary)??0,Max:this.toFiniteNumber(e?.health?.max)},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:this.toFiniteNumber(e?.cosmetic)??0,Poi:{x:this.toFiniteNumber(e?.slot)??0},Abil:o,...e}}mapReplaySummaryPet(e){const o=(e?.abilities??[]).map(i=>{const r=this.toReplayId(i?.id);return r?{Enu:r,Lvl:this.toFiniteNumber(i?.level)??1,Grop:this.toFiniteNumber(i?.group)??0,TrCo:this.toFiniteNumber(i?.triggersConsumed)??0}:null}).filter(i=>null!==i);return{Enu:this.toReplayId(e?.petName)||this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perk),At:{Perm:this.toFiniteNumber(e?.attack)??0,Temp:0,Max:null},Hp:{Perm:this.toFiniteNumber(e?.health)??0,Temp:0,Max:null},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:0,Poi:{x:this.toFiniteNumber(e?.position)??0},Abil:o,...e}}mapReplayTurnsSide(e){const o=e?.stats??null;return{Tur:this.toFiniteNumber(o?.turn)??1,Vic:this.toFiniteNumber(o?.victories)??0,Back:this.toFiniteNumber(o?.health)??0,GoSp:this.toFiniteNumber(o?.goldSpent)??0,Rold:this.toFiniteNumber(o?.rolls)??0,MiSu:this.toFiniteNumber(o?.summons)??0,MSFL:this.toFiniteNumber(o?.level3Sold)??0,TrTT:this.toFiniteNumber(o?.transformed)??0,Mins:{Items:(e?.pets??[]).map(i=>this.mapReplayTurnsPet(i))}}}mapReplaySummarySide(e,o,i){if(i&&"player"===o)return i;const r="player"===o,a=(r?e?.pets?.player:e?.pets?.opponent)??[];return{Tur:this.toFiniteNumber(e?.Turn)??this.toFiniteNumber(e?.turnNumber)??this.toFiniteNumber(e?.turn)??1,Vic:0,Back:0,GoSp:this.toFiniteNumber(r?e?.playerGoldSpent:e?.opponentGoldSpent)??0,Rold:this.toFiniteNumber(r?e?.playerRolls:e?.opponentRolls)??0,MiSu:this.toFiniteNumber(r?e?.playerSummons:e?.opponentSummons)??0,MSFL:0,TrTT:0,Mins:{Items:a.map(l=>this.mapReplaySummaryPet(l))}}}buildReplayBattleResponseFromTurns(e,o,i){const r=e?.turns??[],a=r.filter(g=>(this.toFiniteNumber(g?.Turn)??this.toFiniteNumber(g?.turn)??this.toFiniteNumber(g?.turnNumber))===o),l=a.find(g=>1===g.Type)??a.find(g=>0===g.Type)??a[0]??(o>0&&o<=r.length?r[o-1]:null);if(!l)throw{error:{error:`Replay ${i} does not contain turn ${o}.`},status:404};const s=!(!l?.user&&!l?.opponent);let u=null,p=null;if(!s){const g=a.find(S=>S.Build);if(g){const S=this.parseJsonObject(g.Build);u=(this.isRecord(S?.Bor)?S.Bor:null)??S}const I=a.find(S=>S.Battle);if(I){const S=this.parseJsonObject(I.Battle);(S?.UserBoard||S?.OpponentBoard)&&(p=S)}if(!p?.OpponentBoard){const S=a.find(v=>v.Mode);if(S){const v=this.parseJsonObject(S.Mode),K=Array.isArray(v?.Opponents)?v.Opponents:[],D=this.isRecord(K[0])?K[0]:null;D&&(p||(p={}),p.OpponentBoard={Mins:{Items:D.Minions},Rel:{Items:D.Relics},Pack:D.Pack,Tur:o,GoSp:S.OpponentGoldSpent??0})}}}let b=e?.abilityPetMap??null;if(!b&&e?.replay?.raw_json?.Actions){b=de(e.replay.raw_json.Actions);const g=a.find(I=>I.playerPets||I.opponentPets)??l;!u&&g?.playerPets&&(u={Mins:{Items:g.playerPets}}),!p?.OpponentBoard&&g?.opponentPets&&(p||(p={}),p.OpponentBoard={Mins:{Items:g.opponentPets}})}return{battle:s?{UserBoard:this.mapReplayTurnsSide(l?.user),OpponentBoard:this.mapReplayTurnsSide(l?.opponent)}:{UserBoard:this.mapReplaySummarySide(l,"player",u??(this.isRecord(p?.UserBoard)?p.UserBoard:null)),OpponentBoard:this.mapReplaySummarySide(l,"opponent",this.isRecord(p?.OpponentBoard)?p.OpponentBoard:null)},genesisBuildModel:e?.genesisBuildModel??e?.replay?.raw_json?.GenesisBuildModel??e?.replay?.GenesisBuildModel,abilityPetMap:b}}static \u0275fac=function(o){return new(o||n)(ze.KVO(jt.Qq))};static \u0275prov=ze.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();const Ut=(n,t,e)=>({"text-success":n,"text-danger":t,"text-warning":e});function Yt(n,t){if(1&n&&(c.j41(0,"div",10),c.EFF(1),c.k0s()),2&n){const e=c.XpG();c.Y8G("ngClass",c.sMw(2,Ut,"success"===e.statusTone,"error"===e.statusTone,"warning"===e.statusTone)),c.R7$(),c.SpI(" ",e.statusMessage," ")}}function zt(n,t){if(1&n&&(c.j41(0,"div",11),c.EFF(1),c.k0s()),2&n){const e=c.XpG();c.R7$(),c.JRh(e.errorMessage)}}let Jt=(()=>{class n{replayCalcService;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new L.gE({calcCode:new L.MJ(null,L.k0.required),turn:new L.MJ(1,L.k0.min(1))});errorMessage="";statusMessage="";statusTone="success";loading=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;statusTimer=null;constructor(e,o){this.replayCalcService=e,this.cdr=o}ngOnInit(){}isReplayTurnsPayload(e){return Array.isArray(e.turns)}submit(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode"),o=e?.value?.trim();if(!o)return void(this.errorMessage="Paste calculator JSON or replay JSON.");e?.setValue("",{emitEvent:!1}),e?.markAsPristine(),e?.markAsUntouched(),e?.updateValueAndValidity({emitEvent:!1});const i=function kt(n){const t=n?.trim();if(!t||!t.startsWith("SAPR1:"))return null;const e=t.slice(6);if(!e)return null;try{const o=JSON.parse(function Bt(n){const t=n.replace(/-/g,"+").replace(/_/g,"/"),o=`${t}${"=".repeat((4-t.length%4)%4)}`,i=atob(o),r=Uint8Array.from(i,a=>a.charCodeAt(0));return(new TextDecoder).decode(r)}(e));return He(o)&&1===o.version&&He(o.battle)?{battle:o.battle,genesisBuildModel:o.genesisBuildModel??null,abilityPetMap:o.abilityPetMap??null,turn:"number"==typeof o.turn&&Number.isFinite(o.turn)?o.turn:void 0}:null}catch{return null}}(o);if(i?.battle)return void this.importReplayBattle(i.battle,i.genesisBuildModel,void 0,{abilityPetMap:i.abilityPetMap??null});let r;try{r=JSON.parse(o)}catch{if(this.importFunc(o))return void this.setStatus("Import successful.","success");if(this.tryReplayPid(o))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((r?.Pid||r?.pid)&&!r?.Actions){const a=r?.Pid??r?.pid,l=Number(r?.T??r?.t??this.formGroup.get("turn").value);return!Number.isFinite(l)||l<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(s=>{if(!s.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();s.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:a,T:l},this.replayTimeoutMs).pipe((0,Se.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:u=>{const p=u?.battle;p?this.importReplayBattle(p,u?.genesisBuildModel,void 0,{abilityPetMap:u?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:u=>{if("TimeoutError"===u?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=u?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(r?.UserBoard&&r?.OpponentBoard)this.importReplayBattle(r,r?.GenesisBuildModel,{userBoard:r?.UserBoard,opponentBoard:r?.OpponentBoard},{abilityPetMap:r?.AbilityPetMap??null});else{if(r?.Actions){const a=Number(this.formGroup.get("turn").value??r?.T);if(!Number.isFinite(a)||a<=0)return void(this.errorMessage="Enter a valid turn number.");let l=0,s=null;for(const p of r.Actions)if(0===p?.Type&&p?.Battle&&(l+=1,l===a)){try{s=JSON.parse(p.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${a}.`)}break}if(!s)return void(this.errorMessage=`No battle found for turn ${a}.`);const u=r?.AbilityPetMap??de(r.Actions);return void this.importReplayBattle(s,r?.GenesisBuildModel,{userBoard:r?.UserBoard,opponentBoard:r?.OpponentBoard},{abilityPetMap:u})}if(this.isReplayTurnsPayload(r)){const a=Number(this.formGroup.get("turn").value);if(!Number.isFinite(a)||a<=0)return void(this.errorMessage="Enter a valid turn number.");try{const s=this.replayCalcService.buildReplayBattleResponseFromTurns(r,a,r?.replay?.id||"manual-import");if(s?.battle)return void this.importReplayBattle(s.battle,s.genesisBuildModel,void 0,{abilityPetMap:s.abilityPetMap??null},{resetBattle:!0})}catch(l){return void(this.errorMessage="Failed to process turns JSON.")}}this.importFunc(o)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}importReplayBattle(e,o,i,r,a){const l=this.replayCalcService.parseReplayForCalculator(e,o,i,r);this.importFunc(JSON.stringify(l),a)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const o=e?.trim();if(!o||!/^[a-f0-9-]{16,}$/i.test(o)&&!/^\d+$/.test(o))return!1;const r=Number(this.formGroup.get("turn").value);return!Number.isFinite(r)||r<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(a=>{if(!a.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();a.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:o,T:r},this.replayTimeoutMs).pipe((0,Se.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:l=>{const s=l?.battle;s?this.importReplayBattle(s,l?.genesisBuildModel,void 0,{abilityPetMap:l?.abilityPetMap??null},{resetBattle:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:l=>{if("TimeoutError"===l?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=l?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}setLoading(e){this.loading=e,this.cdr.markForCheck()}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,o){this.statusMessage=e,this.statusTone=o,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(o){return new(o||n)(c.rXU(Kt),c.rXU(Rt.gRc))};static \u0275cmp=c.VBU({type:n,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:19,vars:6,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],[1,"btn","btn-primary",3,"click","disabled"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2",3,"ngClass"],[1,"text-danger","mb-2"]],template:function(o,i){1&o&&(c.j41(0,"div",0)(1,"div",1),c.EFF(2," Paste calculator export code (compressed), replay export code, calculator JSON, or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),c.k0s(),c.j41(3,"div",1),c.EFF(4," Example Pid: "),c.j41(5,"code"),c.EFF(6),c.k0s()(),c.nrm(7,"textarea",2),c.j41(8,"div",3)(9,"div")(10,"label",4),c.EFF(11,"Turn (1-based)"),c.k0s(),c.nrm(12,"input",5),c.k0s(),c.j41(13,"button",6),c.bIt("click",function(){return i.submit()}),c.EFF(14),c.k0s()(),c.j41(15,"div",7),c.EFF(16," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),c.k0s(),c.DNE(17,Yt,2,6,"div",8)(18,zt,2,1,"div",9),c.k0s()),2&o&&(c.Y8G("formGroup",i.formGroup),c.R7$(6),c.JRh(i.pidExample),c.R7$(7),c.Y8G("disabled",i.loading),c.R7$(),c.SpI(" ",i.loading?"Fetching...":"Import"," "),c.R7$(3),c.Y8G("ngIf",i.statusMessage),c.R7$(),c.Y8G("ngIf",i.errorMessage))},dependencies:[ae.MD,ae.YU,ae.bT,L.X1,L.me,L.Q0,L.BC,L.cb,L.VZ,L.j4,L.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}"]})}return n})()}}]);