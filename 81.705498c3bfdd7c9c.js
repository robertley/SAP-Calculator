"use strict";(self.webpackChunksap_calculator=self.webpackChunksap_calculator||[]).push([[81],{41081(Yn,Tt,A){A.d(Tt,{ImportCalculatorComponent:()=>zn});var K=A(10467),Ne=A(49769),j=A(75119),Ge=A(77312),ye=A(98935),ve=A.t(ye,2),ge=A(37283),Fe=A.t(ge,2),Re=A(13276),Pe=A.t(Re,2);const X=new Map,We=new Map,Ve=new Map;function ze(r){return null!==r&&"object"==typeof r}const be=Pe.default??Pe;(Array.isArray(be)?be:ze(be)?Object.values(be).filter(r=>"object"==typeof r&&null!==r&&("Id"in r||"id"in r)):[]).forEach(r=>{if(!ze(r))return;const o=r,e=String(o.Id??o.id),t=Number(o.Tier??o.tier),n=o.Name??o.name;if(n){X.set(e,n);const i=n.toLowerCase().replace(/[^a-z0-9]/g,"");Ve.set(i,e)}Number.isFinite(t)&&n&&We.set(e,{name:n,tier:t})});const Nt=ge??Fe,vt=new Map((ye??ve).map(r=>[String(r.Id),r.Name])),Ft=new Map(Nt.map(r=>[String(r.Id),r.Name])),Ce={0:"Turtle",1:"Puppy",2:"Star",5:"Golden",6:"Unicorn",7:"Danger"},Rt={playerPack:"pP",opponentPack:"oP",playerToy:"pT",playerToyLevel:"pTL",playerHardToy:"pHT",playerHardToyLevel:"pHTL",opponentToy:"oT",opponentToyLevel:"oTL",opponentHardToy:"oHT",opponentHardToyLevel:"oHTL",turn:"t",playerGoldSpent:"pGS",opponentGoldSpent:"oGS",playerRollAmount:"pRA",opponentRollAmount:"oRA",playerSummonedAmount:"pSA",opponentSummonedAmount:"oSA",playerLevel3Sold:"pL3",opponentLevel3Sold:"oL3",playerTransformationAmount:"pTA",opponentTransformationAmount:"oTA",playerPets:"p",opponentPets:"o",allPets:"ap",logFilter:"lf",customPacks:"cp",oldStork:"os",tokenPets:"tp",komodoShuffle:"ks",mana:"m",seed:"sd",triggersConsumed:"tc",showAdvanced:"sa",showTriggerNamesInLogs:"stn",showPositionalArgsInLogs:"spa",ailmentEquipment:"ae",name:"n",attack:"a",health:"h",exp:"e",equipment:"eq",belugaSwallowedPet:"bSP",abominationSwallowedPet1:"aSP1",abominationSwallowedPet2:"aSP2",abominationSwallowedPet3:"aSP3",abominationSwallowedPet1BelugaSwallowedPet:"aSP1B",abominationSwallowedPet2BelugaSwallowedPet:"aSP2B",abominationSwallowedPet3BelugaSwallowedPet:"aSP3B",abominationSwallowedPet1SarcasticFringeheadSwallowedPet:"aSP1SFS",abominationSwallowedPet2SarcasticFringeheadSwallowedPet:"aSP2SFS",abominationSwallowedPet3SarcasticFringeheadSwallowedPet:"aSP3SFS",abominationSwallowedPet1Level:"aSP1L",abominationSwallowedPet2Level:"aSP2L",abominationSwallowedPet3Level:"aSP3L",abominationSwallowedPet1TimesHurt:"aSP1T",abominationSwallowedPet2TimesHurt:"aSP2T",abominationSwallowedPet3TimesHurt:"aSP3T",parrotCopyPet:"pCP",parrotCopyPetBelugaSwallowedPet:"pCPB",...(()=>{const r={};for(let o=1;o<=3;o++){const e=`parrotCopyPetAbominationSwallowedPet${o}`,t=`pCPAS${o}`;r[e]=t,r[`${e}BelugaSwallowedPet`]=`${t}B`,r[`${e}Level`]=`${t}L`,r[`${e}TimesHurt`]=`${t}T`,r[`${e}ParrotCopyPet`]=`${t}PCP`,r[`${e}ParrotCopyPetBelugaSwallowedPet`]=`${t}PCPB`;for(let n=1;n<=3;n++){const i=`${e}ParrotCopyPetAbominationSwallowedPet${n}`,s=`${t}PCPAS${n}`;r[i]=s,r[`${i}BelugaSwallowedPet`]=`${s}B`,r[`${i}Level`]=`${s}L`,r[`${i}TimesHurt`]=`${s}T`}}return r})(),abominationSwallowedPet1ParrotCopyPet:"aSP1PCP",abominationSwallowedPet2ParrotCopyPet:"aSP2PCP",abominationSwallowedPet3ParrotCopyPet:"aSP3PCP",abominationSwallowedPet1ParrotCopyPetBelugaSwallowedPet:"aSP1PCPB",abominationSwallowedPet2ParrotCopyPetBelugaSwallowedPet:"aSP2PCPB",abominationSwallowedPet3ParrotCopyPetBelugaSwallowedPet:"aSP3PCPB",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1:"aSP1PCPAS1",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2:"aSP1PCPAS2",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3:"aSP1PCPAS3",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1:"aSP2PCPAS1",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2:"aSP2PCPAS2",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3:"aSP2PCPAS3",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1:"aSP3PCPAS1",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2:"aSP3PCPAS2",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3:"aSP3PCPAS3",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP1PCPAS1B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP1PCPAS2B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP1PCPAS3B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP2PCPAS1B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP2PCPAS2B",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP2PCPAS3B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1BelugaSwallowedPet:"aSP3PCPAS1B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2BelugaSwallowedPet:"aSP3PCPAS2B",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3BelugaSwallowedPet:"aSP3PCPAS3B",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1Level:"aSP1PCPAS1L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2Level:"aSP1PCPAS2L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3Level:"aSP1PCPAS3L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1Level:"aSP2PCPAS1L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2Level:"aSP2PCPAS2L",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3Level:"aSP2PCPAS3L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1Level:"aSP3PCPAS1L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2Level:"aSP3PCPAS2L",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3Level:"aSP3PCPAS3L",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP1PCPAS1T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP1PCPAS2T",abominationSwallowedPet1ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP1PCPAS3T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP2PCPAS1T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP2PCPAS2T",abominationSwallowedPet2ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP2PCPAS3T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet1TimesHurt:"aSP3PCPAS1T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet2TimesHurt:"aSP3PCPAS2T",abominationSwallowedPet3ParrotCopyPetAbominationSwallowedPet3TimesHurt:"aSP3PCPAS3T",timesHurt:"tH"},Ye={338:[368],373:[403],635:[669],763:[853,970]},Ct={actionfigure:294,airpalmtree:511,balloon:479,boot:299,bowlingball:300,brokenpiggybank:310,broom:301,cardboardbox:302,television:491,toymouse:327};function Ke(r){return!!r&&"object"==typeof r&&!Array.isArray(r)}function L(r){return Ke(r)?r:null}function Je(r,o){if(r)return r instanceof Map?r.get(o):r[o]}function Be(r){const o=Number(r);return Number.isFinite(o)?Math.trunc(o):null}function x(r,o=0){const e=Number(r);return Number.isFinite(e)?e:o}function Se(r,o){if(null==r)return null;if(Ke(r)){const t=[r.id,r.Id,r.petId,r.PetId,r.enum,r.Enum,r.Enu,r.enu];for(const i of t){if(null==i)continue;const s=x(i,NaN);if(Number.isFinite(s))return Math.trunc(s)}const n=r.name??r.Name;if("string"==typeof n){const i=n.toLowerCase().replace(/[^a-z0-9]/g,""),l=Be(Je(o?.petIdsByName??o?.PET_IDS_BY_NAME,i));if(null!==l)return l}return null}if("string"==typeof r){const t=r.trim();if(""===t)return null;const n=x(t,NaN);if(Number.isFinite(n))return Math.trunc(n);const i=t.toLowerCase().replace(/[^a-z0-9]/g,""),l=Be(Je(o?.petIdsByName??o?.PET_IDS_BY_NAME,i));return null!==l?l:null}const e=x(r,NaN);return Number.isFinite(e)?Math.trunc(e):null}function we(r){const o=[],e=new Set;for(const t of r){if(null==t)continue;const n=Number(t);if(!Number.isFinite(n))continue;const i=Math.trunc(n);e.has(i)||(e.add(i),o.push(i))}return o}function pe(r,o){const e=o?.abilityIdsByPetId??{},t=String(r);return we([...Array.isArray(e[t])?e[t]??[]:[],...Array.isArray(Ye[t])?Ye[t]:[]])}function oe(r){const o=Se(r);if(!Number.isFinite(o))return null;const e={Enu:o},t=L(r);if(!t)return e;const n=x(t.attack??t.At??t.at,NaN);Number.isFinite(n)&&(e.At=Math.max(0,Math.round(n)));const i=x(t.health??t.Hp??t.hp,NaN);Number.isFinite(i)&&(e.Hp=Math.max(1,Math.round(i)));const s=x(t.mana??t.Mana,NaN);Number.isFinite(s)&&(e.Mana=Math.max(0,Math.round(s)));const a=x(t.level??t.lvl??t.Lvl,NaN);Number.isFinite(a)&&(e.Lvl=Math.max(1,Math.min(3,Math.round(a))));const l=x(t.exp??t.Exp,NaN);Number.isFinite(l)&&(e.Exp=Math.max(0,Math.round(l)));const d=function Bt(r){const o=Number(r);return Number.isFinite(o)?o:null}(t.perk??t.Perk);return null!==d&&(e.Perk=d),e}function Ee(r,o){const e=[{petKey:"abominationSwallowedPet1",levelKey:"abominationSwallowedPet1Level",belugaKey:"abominationSwallowedPet1BelugaSwallowedPet",sfsKey:"abominationSwallowedPet1SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet2",levelKey:"abominationSwallowedPet2Level",belugaKey:"abominationSwallowedPet2BelugaSwallowedPet",sfsKey:"abominationSwallowedPet2SarcasticFringeheadSwallowedPet"},{petKey:"abominationSwallowedPet3",levelKey:"abominationSwallowedPet3Level",belugaKey:"abominationSwallowedPet3BelugaSwallowedPet",sfsKey:"abominationSwallowedPet3SarcasticFringeheadSwallowedPet"}],t=L(r),n=[];for(const s of e){const a=t?.[s.petKey],l=Se(a,o);if(!Number.isFinite(l))continue;const c=L(a),d=pe(l,o),h=oe(a)??{Enu:l},S=x(t?.[s.levelKey],NaN);if(Number.isFinite(S)&&(h.Lvl=Math.max(1,Math.min(3,Math.round(S)))),182===l){const P=oe(t?.[s.belugaKey]??c?.belugaSwallowedPet??null);if(P){const p=pe(182,o),b={WhiteWhaleAbility:[{...P}]};for(const v of p)b[String(v)]=[{...P}];h.MiMs={Lsts:b}}}if(763===l){const P=oe(t?.[s.sfsKey]??c?.sarcasticFringeheadSwallowedPet??null);if(P){const p={SarcasticFringeheadAbility:[{...P}]};h.MiMs={Lsts:p}}}n.push({swallowedPetId:l,swallowedAbilityEnums:d,memoryEntry:h,belugaSwallowedEntry:h.MiMs??null})}const i=Array.isArray(t?.abominationSwallowedPets)?t?.abominationSwallowedPets:[];for(const s of i){const a=Se(s,o);if(!Number.isFinite(a))continue;const l=pe(a,o);n.push({swallowedPetId:a,swallowedAbilityEnums:l,memoryEntry:oe(s)??{Enu:a},belugaSwallowedEntry:null})}return n}function Xe(r,o){const e=Ee(r,o),t=[];for(const n of e)Array.isArray(n.swallowedAbilityEnums)&&t.push(...n.swallowedAbilityEnums);return we(t)}function Qe(r,o){const e=L(r);if(!e)return null;for(const[t,n]of Object.entries(e)){if(!o(t))continue;const i=x(n,NaN);if(Number.isFinite(i))return i}return null}function Me(r){if("string"==typeof r)return r;const o=L(r);return"string"==typeof o?.name?o.name:null}function $(r){if("number"==typeof r&&Number.isFinite(r))return r;if("string"==typeof r&&r.trim().length>0){const o=Number(r);return Number.isFinite(o)?o:null}return null}function G(r,o){return $(r)??o}function re(r){return null!==r&&"object"==typeof r&&!Array.isArray(r)}function ee(r){return re(r)?r:null}(()=>{try{if("1"===localStorage.getItem("sapReplayDebug"))return!0}catch{return!1}try{return"1"===new URL(window.location.href).searchParams.get("sapReplayDebug")}catch{return!1}})();const jt=new Set(["53","373"]),Oe=[{pet:"abominationSwallowedPet1",level:"abominationSwallowedPet1Level"},{pet:"abominationSwallowedPet2",level:"abominationSwallowedPet2Level"},{pet:"abominationSwallowedPet3",level:"abominationSwallowedPet3Level"}];function Z(r){return"number"==typeof r&&Number.isFinite(r)?String(r):"string"==typeof r&&r.length>0?r:null}function q(r,o){if(Array.isArray(r))return void r.forEach(n=>q(n,o));if(!re(r))return;const e=Z(r.Enu),t=r.Abil;e&&Array.isArray(t)&&!jt.has(e)&&t.forEach(n=>{if(!re(n))return;const i=Z(n.Enu);i&&function $t(r,o,e){let t=r.get(o);t||(t=new Map,r.set(o,t)),t.set(e,(t.get(e)??0)+1)}(o,i,e)}),Object.values(r).forEach(n=>{q(n,o)})}function Ut(r){let o=null,e=-1;for(const[t,n]of r.entries())(n>e||n===e&&(null===o||t<o))&&(o=t,e=n);return o}function et(r){const o={};for(const[e,t]of r.entries()){const n=Ut(t);n&&(o[e]=n)}return o}function Ae(r){if(re(r)||Array.isArray(r))return r;if("string"!=typeof r||0===r.length)return null;try{return JSON.parse(r)}catch{return null}}function se(r){const o=new Map;return(r??[]).forEach(e=>{const t=Ae(e?.Build),n=Ae(e?.Battle),i=Ae(e?.Mode);q(t,o),q(n,o),q(i,o)}),et(o)}!function Wt(){const r=new Map;Object.entries(Ce).forEach(([o,e])=>{if("string"!=typeof e)return;const t=Number(o);Number.isFinite(t)&&r.set(e.toLowerCase(),t)})}();class ke{parseReplayForCalculator(o,e,t,n){console.log(`[ReplayCalcParser] PETS_BY_ID size: ${X.size}`);const i=o?.UserBoard??t?.userBoard,s=o?.OpponentBoard??t?.opponentBoard,a=(m,f,I)=>G(m?.[f],I),l=new Map,c=new Map,d=m=>{m&&Object.entries(m).forEach(([f,I])=>{const y=Z(f);if(!y)return;let R="number"==typeof I||"string"==typeof I?String(I):null;if(R&&!X.has(R)){const k=Number(R);if(Number.isInteger(k)){const N=k-30;if(Number.isInteger(N)&&N>0){const g=String(N);X.has(g)&&(R=g)}}}const C=(R?X.get(R):null)||("string"==typeof I?I:null);C&&l.set(y,C),R&&X.has(R)&&c.set(y,R)})},h=new Map;q(o,h),q(e,h),q(t,h),d(et(h)),d(n?.abilityPetMap??null);const T=m=>l.get(m)??(m=>{const f=Number(m);if(!Number.isInteger(f))return null;const I=new Map;for(const[k,N]of c.entries()){const g=Number(k),w=Number(N);if(!Number.isInteger(g)||!Number.isInteger(w))continue;const M=Math.abs(g-f);if(0===M||M>2)continue;const _=g-w;I.set(_,(I.get(_)??0)+1)}let y=null,R=0;for(const[k,N]of I.entries())(N>R||N===R&&(null===y||Math.abs(k)<Math.abs(y)))&&(y=k,R=N);if(null===y)return null;const C=String(f-y);return X.get(C)??null})(m),b=m=>{if(!m)return null;const f=ee(m),I={PET_IDS_BY_NAME:Ve},y=m.Enu??f?.enu??f?.Id??f?.id,R=Se(y,I),C=String(null!==R?R:y??0),k=X.get(C)||("string"==typeof f?.name?f.name:null)||("string"==typeof f?.Name?f.Name:null)||("string"==typeof y&&y.trim().length>0?y.trim():`Pet #${C}`);console.log(`[ReplayCalcParser] Pet Enu:${y} -> Id:${C} -> Name:${k}`);const N=m.At??ee(f?.at),g=m.Hp??ee(f?.hp),w=ee(N),M=ee(g),_=G(N?.Temp??w?.temp,0),Q=G(g?.Temp??M?.temp,0);let ce=null;if("182"===C){const W=m?.MiMs?.Lsts?.WhiteWhaleAbility??[];if(W.length>0){const J=W[0]?.Enu;ce=X.get(String(J))||`Pet #${J}`}}const Ie="373"===C?(m=>{const f={abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},I=(m?.Abil??[]).map((g,w)=>({ability:g,index:w})).filter(g=>null!==g.ability&&null!==Z(g.ability?.Enu));if(0===I.length)return f;const y=new Map,R=[];I.forEach(g=>{const w=$(g.ability?.Grop)??0;y.has(w)||(y.set(w,[]),R.push(w)),y.get(w)?.push(g)});const C=new Set,k=[];if(Oe.forEach((g,w)=>{const M=R[w];if(void 0===M)return void k.push(w);const _=y.get(M);if(!_||0===_.length)return void k.push(w);let Q=null,ce=null;for(const ne of _){const me=Z(ne.ability?.Enu);if(!me)continue;const fe=T(me);if(fe){Q=ne,ce=fe;break}}if(!Q||!ce)return void k.push(w);f[g.pet]=ce;const Ie=$(Q.ability?.Lvl);null!==Ie&&(f[g.level]=Ie),C.add(Q.index)}),0===k.length)return f;const N=I.filter(g=>!C.has(g.index)).map(g=>{const w=Z(g.ability?.Enu);if(!w)return null;const M=T(w);return M?{ownerPetName:M,level:$(g.ability?.Lvl)}:null}).filter(g=>null!==g);return k.forEach((g,w)=>{const M=N[w];if(!M)return;const _=Oe[g];f[_.pet]=M.ownerPetName,null!==M.level&&(f[_.level]=M.level)}),f})(m):{abominationSwallowedPet1:null,abominationSwallowedPet2:null,abominationSwallowedPet3:null,abominationSwallowedPet1Level:1,abominationSwallowedPet2Level:1,abominationSwallowedPet3Level:1},ne={};for(const[W,J]of c.entries()){const ie=String(J);ne[ie]=ne[ie]||[],ne[ie].push(String(W))}I.abilityIdsByPetId=ne;const me=(m=>function Lt(r){const o=L(r),e=L(o?.Pow),t=L(o?.pow),n=[o?.timesHurt,o?.TimesHurt,e?.SabertoothTigerAbility,t?.SabertoothTigerAbility];for(const i of n){const s=x(i,NaN);if(Number.isFinite(s))return Math.max(0,Math.round(s))}return null}(m))(m),fe=(()=>{const W=function kt(r){const o=L(r),e=[o?.triggersConsumed,o?.TrCo,o?.trco,o?.triggerConsumed];for(const l of e){const c=x(l,NaN);if(Number.isFinite(c))return Math.max(0,Math.round(c))}const t=l=>{const c=l.toLowerCase(),d=c.includes("trigger")||c.includes("trig"),h=c.includes("consum"),S=["trgc","trgcn","trc","trcn","trco"].includes(c);return d&&h||S},n=[o,L(o?.pow),L(o?.Pow)];for(const l of n){const c=Qe(l,t);if(Number.isFinite(c))return Math.max(0,Math.round(c))}const i=Array.isArray(o?.abilities)?o?.abilities:[],s=Array.isArray(o?.Abil)?o?.Abil:[],a=[];for(const l of[i,s])for(const c of l){const d=Qe(c,t);Number.isFinite(d)&&a.push(d)}return a.length>0?Math.max(0,Math.round(Math.max(...a))):null}(m);return null===W?[]:[W]})(),he=m.Perk,At=null!=he?vt.get(String(he))||("string"==typeof he?he:"Unknown Perk"):null,Ue={name:k,attack:G(N?.Perm??w?.perm??f?.attack,0)+_,health:G(g?.Perm??M?.perm??f?.health,0)+Q,exp:(()=>{const W=$(m.Exp);if(null!==W&&W>0)return W;const J=$(m.Lvl);return 2===J?2:3===J?5:W??0})(),equipment:At?{name:At}:null,mana:G(m.Mana,0),belugaSwallowedPet:ce,sarcasticFringeheadSwallowedPet:null,...Ie,battlesFought:0,triggersConsumed:fe.length>0?Math.max(...fe):0};if("373"===String(C))try{const W=function Mt(r,o,e){const t=Ee(r,e);if(0===t.length)return null;const n=function Ze(r,o,e){const t=L(r),n=Array.isArray(t?.Abil)?t?.Abil:[],i=Array.isArray(t?.abilities)?t?.abilities:[],s=[t?.abilityEnum,t?.abilityId,L(n[0])?.Enu,L(i[0])?.Enu];for(const l of s){const c=x(l,NaN);if(Number.isFinite(c))return Math.trunc(c)}if(373===o||338===o){const l=function Et(r,o){const e=Xe(r,o);return e.length>0?e[0]:null}(r,e);if(Number.isFinite(l))return Math.trunc(l)}const a=pe(o,e);return a.length>0?a[0]:null}(r,o,e),i=null!==n?[Math.trunc(n)]:[],s={};for(const a of t){const l=we(Array.isArray(a.swallowedAbilityEnums)?a.swallowedAbilityEnums:[]),c=l.length>0?l:i;if(0!==c.length)for(const d of c){const h=String(d);Array.isArray(s[h])||(s[h]=[]);const T=182===a.swallowedPetId&&Array.isArray(a.swallowedAbilityEnums)&&a.swallowedAbilityEnums.includes(d)&&a.belugaSwallowedEntry?a.belugaSwallowedEntry:a.memoryEntry;s[h].push(T)}}return 0===Object.keys(s).length?null:{Lsts:s}}(m,Number(C),I);if(W){const J=Ue;J.abominationMemory=W;const ie=Xe(m,I);Array.isArray(ie)&&ie.length>0&&(J.abominationInferredAbilityEnums=ie)}}catch(W){}return null!==me&&(Ue.timesHurt=me),Ue},v=m=>{const f=m?.Mins?.Items??[],I=Array(5).fill(null);return f.forEach((y,R)=>{if(!y)return;let C=G(y.Poi?.x,-1);-1===C&&(C=R),C>=0&&C<5&&(I[C]=b(y))}),I.reverse()},O=m=>{const f=(m?.Rel?.Items??[]).find(I=>!!I);if(f){const I=ee(f),y=function qe(r,o){if(null==r)return null;const e=L(r);if(e){const a=[e.id,e.toyId,e.enum,e.Enu];for(const l of a){const c=x(l,NaN);if(Number.isFinite(c))return Math.trunc(c)}}const t=Me(r)??r,n="string"==typeof t?t.toLowerCase().replace(/[^a-z0-9]/g,""):"";if(!n)return null;const i=Be(o?.toyIdsByName?.[n]);if(null!==i)return i;const s=Ct[n];return Number.isFinite(s)?s:null}(f)??null;return{name:(y?Ft.get(String(y)):Me(f))||null,level:G(I?.Lvl,1)}}return{name:null,level:1}},U=O(i),z=O(s),V=this.buildCustomPacksFromGenesis(e,o),D=this.findCustomPackFromDeck(V,i?.Deck),F=this.findCustomPackFromDeck(V,s?.Deck);return{playerPack:Ce[G(i?.Pack,NaN)]||D?.name||"Turtle",opponentPack:Ce[G(s?.Pack,NaN)]||F?.name||"Turtle",playerToy:U.name,playerToyLevel:String(U.level),playerHardToy:null,playerHardToyLevel:1,opponentToy:z.name,opponentToyLevel:String(z.level),opponentHardToy:null,opponentHardToyLevel:1,turn:a(i,"Tur",1)||1,playerGoldSpent:a(i,"GoSp",0)||0,opponentGoldSpent:a(s,"GoSp",0)||0,playerRollAmount:a(i,"Rold",0)||0,opponentRollAmount:a(s,"Rold",0)||0,playerSummonedAmount:a(i,"MiSu",0)||0,opponentSummonedAmount:a(s,"MiSu",0)||0,playerLevel3Sold:a(i,"MSFL",0)||0,opponentLevel3Sold:a(s,"MSFL",0)||0,playerTransformationAmount:a(i,"TrTT",0)||0,opponentTransformationAmount:a(s,"TrTT",0)||0,playerPets:v(i),opponentPets:v(s),allPets:!1,logFilter:null,customPacks:V,oldStork:!1,tokenPets:!1,komodoShuffle:!1,mana:!0,seed:null,triggersConsumed:!0,showAdvanced:!0,showTriggerNamesInLogs:!1,showPositionalArgsInLogs:!0,ailmentEquipment:!1}}buildCustomPacksFromGenesis(o,e){const t=[o?.Bor?.Deck,e?.UserBoard?.Deck,e?.OpponentBoard?.Deck].filter(a=>null!=a&&Array.isArray(a.Minions)),n=[],i=new Set,s=new Set;for(const a of t){const l=a?.Id?String(a.Id):null;if(l&&i.has(l))continue;l&&i.add(l);const c=this.buildCustomPackFromDeck(a,s);c&&n.push({...c,deckId:l})}return n}generateCalculatorLink(o){const e=window.location.origin+window.location.pathname,t=this.stripDefaultValues(o),n=this.truncateKeys(t),i=JSON.stringify(n);return`${e}#c=${btoa(i)}`}buildCustomPackFromDeck(o,e){if(!o||!Array.isArray(o.Minions))return null;const t=o.Minions.map(l=>String(l)),n=Array.isArray(o.Spells)?o.Spells.map(String):[],i={1:[],2:[],3:[],4:[],5:[],6:[]};for(const l of t){const c=We.get(l);c&&i[c.tier]&&i[c.tier].push(c.name)}const s=l=>{const c=l.slice(0,10);for(;c.length<10;)c.push(null);return c};let a=o.Title||"Custom Pack";if(e.has(a)){let l=2;for(;e.has(`${a} (${l})`);)l+=1;a=`${a} (${l})`}return e.add(a),{name:a,tier1Pets:s(i[1]),tier2Pets:s(i[2]),tier3Pets:s(i[3]),tier4Pets:s(i[4]),tier5Pets:s(i[5]),tier6Pets:s(i[6]),spells:n}}findCustomPackFromDeck(o,e){if(!e)return null;const t=e?.Id?String(e.Id):null;if(t){const i=o.find(s=>s.deckId===t);if(i)return i}const n=e?.Title;return n&&o.find(i=>i.name===n)||null}stripDefaultValues(o){const e={};"Turtle"!==o.playerPack&&(e.playerPack=o.playerPack),"Turtle"!==o.opponentPack&&(e.opponentPack=o.opponentPack),o.playerToy&&(e.playerToy=o.playerToy),o.playerToyLevel&&"1"!==o.playerToyLevel&&(e.playerToyLevel=o.playerToyLevel),o.opponentToy&&(e.opponentToy=o.opponentToy),o.opponentToyLevel&&"1"!==o.opponentToyLevel&&(e.opponentToyLevel=o.opponentToyLevel),11!==o.turn&&(e.turn=o.turn),10!==o.playerGoldSpent&&(e.playerGoldSpent=o.playerGoldSpent),10!==o.opponentGoldSpent&&(e.opponentGoldSpent=o.opponentGoldSpent),4!==o.playerRollAmount&&(e.playerRollAmount=o.playerRollAmount),4!==o.opponentRollAmount&&(e.opponentRollAmount=o.opponentRollAmount),0!==o.playerSummonedAmount&&(e.playerSummonedAmount=o.playerSummonedAmount),0!==o.opponentSummonedAmount&&(e.opponentSummonedAmount=o.opponentSummonedAmount),0!==o.playerLevel3Sold&&(e.playerLevel3Sold=o.playerLevel3Sold),0!==o.opponentLevel3Sold&&(e.opponentLevel3Sold=o.opponentLevel3Sold),0!==o.playerTransformationAmount&&(e.playerTransformationAmount=o.playerTransformationAmount),0!==o.opponentTransformationAmount&&(e.opponentTransformationAmount=o.opponentTransformationAmount),o.allPets&&(e.allPets=!0),o.oldStork&&(e.oldStork=!0),o.tokenPets&&(e.tokenPets=!0),o.komodoShuffle&&(e.komodoShuffle=!0),o.mana&&(e.mana=!0),null!=o.seed&&(e.seed=o.seed),o.triggersConsumed&&(e.triggersConsumed=!0),o.foodsEaten&&(e.foodsEaten=!0),o.showAdvanced&&(e.showAdvanced=!0),o.showTriggerNamesInLogs&&(e.showTriggerNamesInLogs=!0),!1===o.showPositionalArgsInLogs&&(e.showPositionalArgsInLogs=!1),o.ailmentEquipment&&(e.ailmentEquipment=!0),o.logFilter&&(e.logFilter=o.logFilter),o.customPacks.length>0&&(e.customPacks=o.customPacks);const t=s=>{if(!s||!s.name)return null;const a={name:s.name};return"number"==typeof s.attack&&0!==s.attack&&(a.attack=s.attack),"number"==typeof s.health&&0!==s.health&&(a.health=s.health),"number"==typeof s.exp&&0!==s.exp&&(a.exp=s.exp),"number"==typeof s.mana&&0!==s.mana&&(a.mana=s.mana),s.equipment&&(a.equipment=s.equipment),s.triggersConsumed&&(a.triggersConsumed=s.triggersConsumed),s.foodsEaten&&(a.foodsEaten=s.foodsEaten),null!=s.belugaSwallowedPet&&(a.belugaSwallowedPet=s.belugaSwallowedPet),Oe.forEach(l=>{const c=s[l.pet];null!=c&&(a[l.pet]=c);const d=s[l.level];"number"==typeof d&&1!==d&&(a[l.level]=d)}),s.timesHurt&&(a.timesHurt=s.timesHurt),a},n=o.playerPets.map(t);n.some(s=>null!==s)&&(e.playerPets=n);const i=o.opponentPets.map(t);return i.some(s=>null!==s)&&(e.opponentPets=i),e}truncateKeys(o){if(Array.isArray(o))return o.map(e=>this.truncateKeys(e));if(re(o)){const e={};for(const t of Object.keys(o))e[Rt[t]||t]=this.truncateKeys(o[t]);return e}return o}}function it(r){return null!==r&&"object"==typeof r&&!Array.isArray(r)}function xe(r){const o=r?.trim();if(!o||!o.startsWith("SAPR1:"))return null;const e=o.slice(6);if(!e)return null;try{const t=JSON.parse(function Qt(r){const o=r.replace(/-/g,"+").replace(/_/g,"/"),t=`${o}${"=".repeat((4-o.length%4)%4)}`,n=atob(t),i=Uint8Array.from(n,s=>s.charCodeAt(0));return(new TextDecoder).decode(i)}(e));return it(t)&&1===t.version&&it(t.battle)?{battle:t.battle,genesisBuildModel:t.genesisBuildModel??null,abilityPetMap:t.abilityPetMap??null,turn:"number"==typeof t.turn&&Number.isFinite(t.turn)?t.turn:void 0}:null}catch{return null}}var u=A(35547),B=A(47868),qt=A(17705),ot=A(27389);function te(r,o){return new ot.c(o?e=>o.schedule(en,0,{error:r,subscriber:e}):e=>e.error(r))}function en({error:r,subscriber:o}){o.error(r)}var rt=A(14421),st=A(41080);const tn=(()=>{function r(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return r.prototype=Object.create(Error.prototype),r})();var ae=A(13004);class rn{constructor(o,e,t,n){this.waitFor=o,this.absoluteTimeout=e,this.withObservable=t,this.scheduler=n}call(o,e){return e.subscribe(new He(o,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))}}class He extends ae.gn{constructor(o,e,t,n,i){super(o),this.absoluteTimeout=e,this.waitFor=t,this.withObservable=n,this.scheduler=i,this.scheduleTimeout()}static dispatchTimeout(o){const{withObservable:e}=o;o._unsubscribeAndRecycle(),o.add((0,ae.tS)(e,new ae.zA(o)))}scheduleTimeout(){const{action:o}=this;o?this.action=o.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(He.dispatchTimeout,this.waitFor,this))}_next(o){this.absoluteTimeout||this.scheduleTimeout(),super._next(o)}_unsubscribe(){this.action=void 0,this.scheduler=null,this.withObservable=null}}function de(r,o=st.b){return function on(r,o,e=st.b){return t=>{let n=function nn(r){return r instanceof Date&&!isNaN(+r)}(r),i=n?+r-e.now():Math.abs(r);return t.lift(new rn(i,n,o,e))}}(r,te(new tn),o)}var sn=A(45286),an=A(68189),un=A(76228);const pn=new class cn extends un.q{}(class ln extends an.R{constructor(o,e){super(o,e),this.scheduler=o,this.work=e}schedule(o,e=0){return e>0?super.schedule(o,e):(this.delay=e,this.state=o,this.scheduler.flush(this),this)}execute(o,e){return e>0||this.closed?super.execute(o,e):this._execute(o,e)}requestAsyncId(o,e,t=0){return null!==t&&t>0||null===t&&this.delay>0?super.requestAsyncId(o,e,t):o.flush(this)}});var dn=A(31805),mn=A(70762),fn=A(51235);class Y{constructor(o,e,t){this.kind=o,this.value=e,this.error=t,this.hasValue="N"===o}observe(o){switch(this.kind){case"N":return o.next&&o.next(this.value);case"E":return o.error&&o.error(this.error);case"C":return o.complete&&o.complete()}}do(o,e,t){switch(this.kind){case"N":return o&&o(this.value);case"E":return e&&e(this.error);case"C":return t&&t()}}accept(o,e,t){return o&&"function"==typeof o.next?this.observe(o):this.do(o,e,t)}toObservable(){switch(this.kind){case"N":return(0,rt.of)(this.value);case"E":return te(this.error);case"C":return(0,fn.I)()}throw new Error("unexpected notification kind value")}static createNext(o){return typeof o<"u"?new Y("N",o):Y.undefinedValueNotification}static createError(o){return new Y("E",void 0,o)}static createComplete(){return Y.completeNotification}}Y.completeNotification=new Y("C"),Y.undefinedValueNotification=new Y("N",void 0);class Te extends mn.v{constructor(o,e,t=0){super(o),this.scheduler=e,this.delay=t}static dispatch(o){const{notification:e,destination:t}=o;e.observe(t),this.unsubscribe()}scheduleMessage(o){this.destination.add(this.scheduler.schedule(Te.dispatch,this.delay,new gn(o,this.destination)))}_next(o){this.scheduleMessage(Y.createNext(o))}_error(o){this.scheduleMessage(Y.createError(o)),this.unsubscribe()}_complete(){this.scheduleMessage(Y.createComplete()),this.unsubscribe()}}class gn{constructor(o,e){this.notification=o,this.destination=e}}var Pn=A(2145),bn=A(21259);class Sn extends sn.B7{constructor(o=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,t){super(),this.scheduler=t,this._events=[],this._infiniteTimeWindow=!1,this._bufferSize=o<1?1:o,this._windowTime=e<1?1:e,e===Number.POSITIVE_INFINITY?(this._infiniteTimeWindow=!0,this.next=this.nextInfiniteTimeWindow):this.next=this.nextTimeWindow}nextInfiniteTimeWindow(o){if(!this.isStopped){const e=this._events;e.push(o),e.length>this._bufferSize&&e.shift()}super.next(o)}nextTimeWindow(o){this.isStopped||(this._events.push(new wn(this._getNow(),o)),this._trimBufferThenGetEvents()),super.next(o)}_subscribe(o){const e=this._infiniteTimeWindow,t=e?this._events:this._trimBufferThenGetEvents(),n=this.scheduler,i=t.length;let s;if(this.closed)throw new Pn.P;if(this.isStopped||this.hasError?s=dn.y.EMPTY:(this.observers.push(o),s=new bn.Y(this,o)),n&&o.add(o=new Te(o,n)),e)for(let a=0;a<i&&!o.closed;a++)o.next(t[a]);else for(let a=0;a<i&&!o.closed;a++)o.next(t[a].value);return this.hasError?o.error(this.thrownError):this.isStopped&&o.complete(),s}_getNow(){return(this.scheduler||pn).now()}_trimBufferThenGetEvents(){const o=this._getNow(),e=this._bufferSize,t=this._windowTime,n=this._events,i=n.length;let s=0;for(;s<i&&!(o-n[s].time<t);)s++;return i>e&&(s=Math.max(s,i-e)),s>0&&n.splice(0,s),n}}class wn{constructor(o,e){this.time=o,this.value=e}}function at(r,o,e){let t;return t=r&&"object"==typeof r?r:{bufferSize:r,windowTime:o,refCount:!1,scheduler:e},n=>n.lift(function An({bufferSize:r=Number.POSITIVE_INFINITY,windowTime:o=Number.POSITIVE_INFINITY,refCount:e,scheduler:t}){let n,s,i=0,a=!1,l=!1;return function(d){let h;i++,!n||a?(a=!1,n=new Sn(r,o,t),h=n.subscribe(this),s=d.subscribe({next(S){n.next(S)},error(S){a=!0,n.error(S)},complete(){l=!0,s=void 0,n.complete()}}),l&&(s=void 0)):h=n.subscribe(this),this.add(()=>{i--,h.unsubscribe(),h=void 0,s&&!l&&e&&0===i&&(s.unsubscribe(),s=void 0,n=void 0)})}}(t))}function le(r){return function(e){const t=new Tn(r),n=e.lift(t);return t.caught=n}}class Tn{constructor(o){this.selector=o}call(o,e){return e.subscribe(new In(o,this.selector,this.caught))}}class In extends ae.gn{constructor(o,e,t){super(o),this.selector=e,this.caught=t}error(o){if(!this.isStopped){let e;try{e=this.selector(o,this.caught)}catch(i){return void super.error(i)}this._unsubscribeAndRecycle();const t=new ae.zA(this);this.add(t);const n=(0,ae.tS)(e,t);n!==t&&this.add(n)}}}var lt=A(49090),Nn=A(15539),ut=A(95006);function pt(r){return r.endsWith("/")?r.slice(0,-1):r}function De(r){return`${pt("https://sap-library.vercel.app/api")}${r}`}function dt(r){const o=encodeURIComponent(String(r));return`${pt("https://sap-library.vercel.app/api")}/replays/${o}/turns`}var vn=A(26980);let _e=(()=>{class r{http;parser=new ke;constructor(e){this.http=e}parseReplayForCalculator(e,t,n,i){return this.parser.parseReplayForCalculator(e,t,n,i)}buildCustomPacksFromGenesis(e,t){return this.parser.buildCustomPacksFromGenesis(e,t)}generateCalculatorLink(e){return this.parser.generateCalculatorLink(e)}fetchReplayBattle(e,t){return this.fetchReplayBattleFromTurnsApi(e,t)}fetchReplayBattleDirect(e,t){return this.http.post(De("/replay-battle"),e).pipe(de(t))}fetchReplayTurns(e,t){const n=String(e.Pid),i=this.requestReplayIndex(n,t,e).pipe(at(1));return i.subscribe({next:()=>{},error:()=>{}}),this.fetchReplayTurnsByReplayId(n,t).pipe(le(s=>404!==s?.status?this.normalizeReplayFetchError(s):i.pipe((0,lt.n)(a=>{const l=a?.replayId;return l?this.fetchReplayTurnsByReplayId(String(l),t):te({error:{error:"Replay indexing did not return a replayId."},status:400})}),le(a=>this.normalizeReplayFetchError(a)))))}fetchReplayBattleFromTurnsApi(e,t){const n=String(e.Pid),i=this.requestReplayIndex(n,t,e).pipe(at(1));return i.subscribe({next:()=>{},error:()=>{}}),this.fetchReplayBattleByReplayId(n,e.T,t).pipe(le(s=>404!==s?.status?this.normalizeReplayFetchError(s):i.pipe((0,lt.n)(a=>{const l=a?.replayId;return l?this.fetchReplayBattleByReplayId(String(l),e.T,t):te({error:{error:"Replay indexing did not return a replayId."},status:400})}),le(a=>this.normalizeReplayFetchError(a)))))}requestReplayIndex(e,t,n){return this.http.post(De("/replays"),{Pid:e,participationId:e}).pipe(de(t),(0,Nn.M)(()=>{this.notifyReplayIndexUploadStatus(n,{outcome:"success",message:"Replay uploaded to SAP Library."})}),le(i=>{const s=this.toReplayIndexUploadErrorStatus(i);return this.notifyReplayIndexUploadStatus(n,s),"error"===s.outcome&&console.warn("[replay] replay index upload failed",i),te(i)}))}notifyReplayIndexUploadStatus(e,t){e?.onReplayIndexUploadStatus&&e.onReplayIndexUploadStatus(t)}toReplayIndexUploadErrorStatus(e){const t=e?.status;return 400===t||404===t?{outcome:"unsupported",message:"SAP Library upload is not available on this replay API.",statusCode:t}:{outcome:"error",message:"Failed to upload replay to SAP Library.",statusCode:"number"==typeof t?t:void 0}}fetchReplayBattleByReplayId(e,t,n){return this.http.get(dt(e)).pipe(de(n),(0,ut.T)(i=>this.buildReplayBattleResponseFromTurns(i,t,e)))}fetchReplayTurnsByReplayId(e,t){return this.http.get(dt(e)).pipe(de(t))}normalizeReplayFetchError(e){const t=e?.status;return te(404===t||400===t?e:{error:{error:"This replay API does not expose turn battle JSON. Configure a replay backend that supports /api/replay-battle or /api/replays/:id/turns."},status:400})}checkReplayApiHealth(e){var t=this;return(0,K.A)(function*(){return(yield t.http.get(De("/health")).pipe(de(e),(0,ut.T)(i=>({reachable:!0,isReplayHealthContract:t.isReplayHealthResponse(i)})),le(()=>(0,rt.of)({reachable:!1,isReplayHealthContract:!1}))).toPromise())??{reachable:!1,isReplayHealthContract:!1}})()}checkReplayApiReachable(e){var t=this;return(0,K.A)(function*(){return(yield t.checkReplayApiHealth(e)).reachable})()}isReplayHealthResponse(e){return!(!e||"object"!=typeof e)&&("boolean"==typeof e.ok&&"boolean"==typeof e.hasCredentials&&"boolean"==typeof e.tokenLoaded)}toFiniteNumber(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}isRecord(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}parseJsonObject(e){if("string"!=typeof e||0===e.trim().length)return null;try{const t=JSON.parse(e);return this.isRecord(t)?t:null}catch{return null}}mapReplayTurnsPet(e){const t=(e?.abilities??[]).map(n=>{const i=this.toReplayId(n?.id);return i?{Enu:i,Lvl:this.toFiniteNumber(n?.level)??1,Grop:this.toFiniteNumber(n?.group)??0,TrCo:this.toFiniteNumber(n?.triggersConsumed)??0}:null}).filter(n=>null!==n);return{Enu:this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perkId),At:{Perm:this.toFiniteNumber(e?.attack?.permanent)??0,Temp:this.toFiniteNumber(e?.attack?.temporary)??0,Max:this.toFiniteNumber(e?.attack?.max)},Hp:{Perm:this.toFiniteNumber(e?.health?.permanent)??0,Temp:this.toFiniteNumber(e?.health?.temporary)??0,Max:this.toFiniteNumber(e?.health?.max)},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:this.toFiniteNumber(e?.cosmetic)??0,Poi:{x:this.toFiniteNumber(e?.slot)??0},Abil:t,...e}}mapReplaySummaryPet(e){const t=(e?.abilities??[]).map(n=>{const i=this.toReplayId(n?.id);return i?{Enu:i,Lvl:this.toFiniteNumber(n?.level)??1,Grop:this.toFiniteNumber(n?.group)??0,TrCo:this.toFiniteNumber(n?.triggersConsumed)??0}:null}).filter(n=>null!==n);return{Enu:this.toReplayId(e?.petName)||this.toReplayId(e?.id),Lvl:this.toFiniteNumber(e?.level)??1,Exp:this.toFiniteNumber(e?.experience)??0,Perk:this.toReplayId(e?.perk),At:{Perm:this.toFiniteNumber(e?.attack)??0,Temp:0,Max:null},Hp:{Perm:this.toFiniteNumber(e?.health)??0,Temp:0,Max:null},Mana:this.toFiniteNumber(e?.mana)??0,Cosm:0,Poi:{x:this.toFiniteNumber(e?.position)??0},Abil:t,...e}}mapReplayTurnsSide(e){const t=e?.stats??null,n=this.toFiniteNumber(t?.victories)??this.toFiniteNumber(t?.rawVictories)??0,i=this.toFiniteNumber(t?.lives)??this.toFiniteNumber(t?.health)??null,s=this.toFiniteNumber(t?.rawBack)??this.toFiniteNumber(t?.health)??i??0;return{Tur:this.toFiniteNumber(t?.turn)??1,Vic:n,Back:s,Lives:i??s,GoSp:this.toFiniteNumber(t?.goldSpent)??0,Rold:this.toFiniteNumber(t?.rolls)??0,MiSu:this.toFiniteNumber(t?.summons)??0,MSFL:this.toFiniteNumber(t?.level3Sold)??0,TrTT:this.toFiniteNumber(t?.transformed)??0,Mins:{Items:(e?.pets??[]).map(a=>this.mapReplayTurnsPet(a))}}}mapReplaySummarySide(e,t,n){if(n&&"player"===t)return n;const i="player"===t,s=(i?e?.pets?.player:e?.pets?.opponent)??[];return{Tur:this.toFiniteNumber(e?.Turn)??this.toFiniteNumber(e?.turnNumber)??this.toFiniteNumber(e?.turn)??1,Vic:0,Back:0,GoSp:this.toFiniteNumber(i?e?.playerGoldSpent:e?.opponentGoldSpent)??0,Rold:this.toFiniteNumber(i?e?.playerRolls:e?.opponentRolls)??0,MiSu:this.toFiniteNumber(i?e?.playerSummons:e?.opponentSummons)??0,MSFL:0,TrTT:0,Mins:{Items:s.map(a=>this.mapReplaySummaryPet(a))}}}buildReplayBattleResponseFromTurns(e,t,n){const i=e?.turns??[],s=i.filter(P=>(this.toFiniteNumber(P?.Turn)??this.toFiniteNumber(P?.turn)??this.toFiniteNumber(P?.turnNumber))===t),a=s.find(P=>0===P.Type)??s.find(P=>1===P.Type)??s[0]??(t>0&&t<=i.length?i[t-1]:null);if(!a)throw{error:{error:`Replay ${n} does not contain turn ${t}.`},status:404};const l=!(!a?.user&&!a?.opponent);let c=null,d=null;if(!l){const P=s.find(b=>b.Build);if(P){const b=this.parseJsonObject(P.Build);c=(this.isRecord(b?.Bor)?b.Bor:null)??b}const p=s.find(b=>b.Battle);if(p){const b=this.parseJsonObject(p.Battle);(b?.UserBoard||b?.OpponentBoard)&&(d=b)}if(!d?.OpponentBoard){const b=s.find(v=>v.Mode);if(b){const v=this.parseJsonObject(b.Mode),O=Array.isArray(v?.Opponents)?v.Opponents:[],U=this.isRecord(O[0])?O[0]:null;U&&(d||(d={}),d.OpponentBoard={Mins:{Items:U.Minions},Rel:{Items:U.Relics},Pack:U.Pack,Tur:t,GoSp:b.OpponentGoldSpent??0})}}}let h=e?.abilityPetMap??null;if(!h&&e?.replay?.raw_json?.Actions){h=se(e.replay.raw_json.Actions);const P=s.find(p=>p.playerPets||p.opponentPets)??a;!c&&P?.playerPets&&(c={Mins:{Items:P.playerPets}}),!d?.OpponentBoard&&P?.opponentPets&&(d||(d={}),d.OpponentBoard={Mins:{Items:P.opponentPets}})}const S=l?{UserBoard:this.mapReplayTurnsSide(a?.user),OpponentBoard:this.mapReplayTurnsSide(a?.opponent)}:{UserBoard:this.mapReplaySummarySide(a,"player",c??(this.isRecord(d?.UserBoard)?d.UserBoard:null)),OpponentBoard:this.mapReplaySummarySide(a,"opponent",this.isRecord(d?.OpponentBoard)?d.OpponentBoard:null)},T=this.resolveBattleOutcomeFromSources(i,a,t,d);return null!==T&&(S.Outcome=T),this.isRecord(d?.User)&&(S.User=d.User),this.isRecord(d?.Opponent)&&(S.Opponent=d.Opponent),{battle:S,genesisBuildModel:e?.genesisBuildModel??e?.replay?.raw_json?.GenesisBuildModel??e?.replay?.GenesisBuildModel,abilityPetMap:h}}resolveBattleOutcomeFromSources(e,t,n,i){const s=this.resolveOutcomeIdFromUnknown(i?.Outcome??i?.outcome);if(null!==s)return s;const l=this.resolveOutcomeIdFromUnknown(t.Outcome??t.outcome??t.Result??t.result);if(null!==l)return l;const c=this.toFiniteNumber(t?.Turn)??this.toFiniteNumber(t?.turn)??this.toFiniteNumber(t?.turnNumber)??n,d=e.find(F=>(this.toFiniteNumber(F?.Turn)??this.toFiniteNumber(F?.turn)??this.toFiniteNumber(F?.turnNumber))===(c??n)-1)??(n>1?e[n-2]:null)??null,h=this.readTurnsSideVictories(t?.user),S=this.readTurnsSideVictories(t?.opponent),T=this.readTurnsSideVictories(d?.user),P=this.readTurnsSideVictories(d?.opponent),p=this.toNonNegativeIntOrZero(h),b=this.toNonNegativeIntOrZero(S),v=this.toNonNegativeIntOrZero(T),O=this.toNonNegativeIntOrZero(P);if(p>v)return 1;if(b>O)return 2;const U=this.readTurnsSideLivesOrHealth(t?.user),z=this.readTurnsSideLivesOrHealth(t?.opponent),V=this.readTurnsSideLivesOrHealth(d?.user),D=this.readTurnsSideLivesOrHealth(d?.opponent);return null!==z&&null!==D&&z<D?1:null!==U&&null!==V&&U<V?2:3}readTurnsSideVictories(e){return this.toFiniteNumber(e?.stats?.victories??null)??this.toFiniteNumber(e?.stats?.rawVictories??null)}readTurnsSideLivesOrHealth(e){return this.toFiniteNumber(e?.stats?.lives??null)??this.toFiniteNumber(e?.stats?.health??null)??this.toFiniteNumber(e?.stats?.rawBack??null)}toOutcomeValue(e){return 1===e||2===e||3===e?e:null}resolveOutcomeIdFromUnknown(e){const t=this.toOutcomeValue(this.toFiniteNumber(e));if(null!==t)return t;if(!this.isRecord(e))return null;const n=this.toOutcomeValue(this.toFiniteNumber(e.id));if(null!==n)return n;const i=this.toOutcomeValueFromText(e.user);if(null!==i)return i;const s=this.toOutcomeValueFromText(e.opponent);return 1===s?2:2===s?1:3===s?3:null}toOutcomeValueFromText(e){if("string"!=typeof e)return null;const t=e.trim().toLowerCase();return"win"===t?1:"loss"===t?2:"tie"===t||"draw"===t?3:null}toNonNegativeIntOrZero(e){return null!==e&&Number.isFinite(e)?Math.max(0,Math.trunc(e)):0}static \u0275fac=function(t){return new(t||r)(B.KVO(vn.Qq))};static \u0275prov=B.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var mt=A(46791),ft=A(24111),ht=A(1744),yt=A(49230),gt=A(56990),Pt=A(90966),bt=A(26886);const Rn=ye??ve??[],Cn=ge??Fe??[],Bn=new Map((Re??Pe??[]).filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId])),En=new Map(Rn.filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId])),Mn=new Map(Cn.filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId]));let On=(()=>{class r{replayCalcService;logService;gameService;abilityService;petService;equipmentService;toyService;constructor(e,t,n,i,s,a,l){this.replayCalcService=e,this.logService=t,this.gameService=n,this.abilityService=i,this.petService=s,this.equipmentService=a,this.toyService=l}buildOddsImageBlob(e){var t=this;return(0,K.A)(function*(){const n=t.resolveReplayActionsContainer(e.replayPayload),i=t.extractBattleRows(n);if(0===i.length)throw new Error("Replay JSON did not contain battle turns.");const s=t.getReplayActions(n),a=e.abilityPetMap??t.getReplayAbilityPetMap(n)??(s?se(s):null),l=t.getReplayBuildModel(n),c=i.map(h=>t.computeTurnOdds(h.battle,l,a,e.simulationCount)),d=i.map(h=>t.toRenderBattleInfo(h.battle));return t.renderOddsImage(i,d,c,e.simulationCount)})()}computeTurnOdds(e,t,n,i){try{const s=this.replayCalcService.parseReplayForCalculator(e,t??void 0,void 0,{abilityPetMap:n}),a=this.createSimulationConfigFromCalculatorState(s,i),l=this.runLocalSimulation(a),c=l.playerWins+l.opponentWins+l.draws;return c<=0?null:{player:`${(l.playerWins/c*100).toFixed(1)}%`,opponent:`${(l.opponentWins/c*100).toFixed(1)}%`,draw:`${(l.draws/c*100).toFixed(1)}%`}}catch{return null}}runLocalSimulation(e){const t=this.gameService.gameApi?{...this.gameService.gameApi}:null,n=this.logService.isEnabled(),i=this.logService.isDeferDecorations(),s=this.logService.isShowTriggerNamesInLogs(),a=new mt.O(this.logService,this.gameService,this.abilityService,this.petService,this.equipmentService,this.toyService);try{return a.run(e)}finally{t&&(this.gameService.gameApi=t),this.logService.setEnabled(n),this.logService.setDeferDecorations(i),this.logService.setShowTriggerNamesInLogs(s)}}createSimulationConfigFromCalculatorState(e,t){return{playerPack:e.playerPack,opponentPack:e.opponentPack,playerToy:e.playerToy,playerToyLevel:this.toNumberOrFallback(e.playerToyLevel,1),playerHardToy:e.playerHardToy,playerHardToyLevel:e.playerHardToyLevel,opponentToy:e.opponentToy,opponentToyLevel:this.toNumberOrFallback(e.opponentToyLevel,1),opponentHardToy:e.opponentHardToy,opponentHardToyLevel:e.opponentHardToyLevel,turn:e.turn,playerGoldSpent:e.playerGoldSpent,opponentGoldSpent:e.opponentGoldSpent,playerRollAmount:e.playerRollAmount,opponentRollAmount:e.opponentRollAmount,playerSummonedAmount:e.playerSummonedAmount,opponentSummonedAmount:e.opponentSummonedAmount,playerLevel3Sold:e.playerLevel3Sold,opponentLevel3Sold:e.opponentLevel3Sold,playerTransformationAmount:e.playerTransformationAmount,opponentTransformationAmount:e.opponentTransformationAmount,playerPets:e.playerPets,opponentPets:e.opponentPets,customPacks:e.customPacks,allPets:e.allPets,oldStork:e.oldStork,tokenPets:e.tokenPets,komodoShuffle:e.komodoShuffle,mana:e.mana,seed:e.seed,simulationCount:t,logsEnabled:!1,maxLoggedBattles:0}}resolveReplayActionsContainer(e){const t=this.getRecord(e,"raw_json");if(t&&Array.isArray(t.Actions))return t;const n=this.getRecord(e,"replay"),i=n?this.getRecord(n,"raw_json"):null;return i&&Array.isArray(i.Actions)?i:e}extractBattleRows(e){const t=this.getReplayActions(e);if(!t||0===t.length){const i=e.turns;if(!Array.isArray(i))return[];const s=this.replayCalcService,a=this.getReplayIdFromPayload(e)??"manual-replay",l=[];for(let c=0;c<i.length;c+=1)try{const d=c+1,h=s.buildReplayBattleResponseFromTurns(e,d,a);h?.battle&&l.push({turn:d,battle:h.battle})}catch{}return l}let n=1;return t.map(i=>{const s=this.toNumberOrFallback(i?.Type,0);if(0!==s&&1!==s||"string"!=typeof i.Battle)return null;const a=this.safeParseBattleJson(i.Battle);if(!a)return null;const c={turn:this.toPositiveInt(i.Turn)??n,battle:a};return n+=1,c}).filter(i=>null!==i)}toRenderBattleInfo(e){const t=this.getBoard(e,"UserBoard"),n=this.getBoard(e,"OpponentBoard");return{outcome:this.getBattleOutcome(e),playerName:this.getDisplayName(e,"User"),opponentName:this.getDisplayName(e,"Opponent"),playerLives:this.getBoardLives(t),opponentLives:this.getBoardLives(n),playerPets:this.getBoardPets(t),opponentPets:this.getBoardPets(n),playerToy:this.getBoardToy(t),opponentToy:this.getBoardToy(n)}}renderOddsImage(e,t,n,i){var s=this;return(0,K.A)(function*(){const T=document.createElement("canvas"),P=t[0]?.playerName&&t[0]?.opponentName?36:0;T.width=1510,T.height=P+125*e.length+60;const p=T.getContext("2d");if(!p)throw new Error("Canvas rendering is not available in this browser.");const b=new Map,v=D=>{if(!D)return Promise.resolve(null);const F=b.get(D);if(F)return F;const H=new Promise(E=>{const m=new Image;m.onload=()=>E(m),m.onerror=()=>E(null),m.src=D});return b.set(D,H),H},z=yield v("/assets/art/Public/Public/Icons/heart-from-textmap.png");p.fillStyle="#FFFFFF",p.fillRect(0,0,1510,T.height),P>0&&(p.fillStyle="#000000",p.font="18px Arial",p.textAlign="center",p.fillText(`${t[0]?.playerName} vs ${t[0]?.opponentName}`,755,24),p.textAlign="left");for(let D=0;D<e.length;D+=1){const F=t[D],H=n[D],E=P+125*D,m=E+25,f=H?s.parsePercentValue(H.player):null,I=H?s.parsePercentValue(H.opponent):null,y=H?s.parsePercentValue(H.draw):null,R=1===F.outcome&&null!==f&&Number.isFinite(f)&&f<=5;p.fillStyle=R?"#F4D35E":1===F.outcome?"#E6F4EA":2===F.outcome?"#FDECEA":"#F2F2F2",p.fillRect(0,E,1510,125),p.fillStyle="#000000",p.font="24px Arial",p.fillText(String(e[D].turn),90,m+25+6),z&&(p.drawImage(z,150,m,50,50),null!==F.playerLives&&(p.fillStyle="#FFFFFF",p.font="24px Arial",p.textAlign="center",p.fillText(String(F.playerLives),175,m+26+6),p.textAlign="left")),p.fillStyle="#111111",p.font="18px Arial",p.fillText(1===F.outcome?"WIN":2===F.outcome?"LOSS":"DRAW",157,m+50+26);for(let N=0;N<F.playerPets.length&&N<5;N+=1){const g=F.playerPets[N],w=75*N+25+150+65;yield s.drawPet(p,g,w,m,!0,50,v)}F.playerToy&&(yield s.drawToy(p,F.playerToy,590,m,50,v));for(let N=0;N<F.opponentPets.length&&N<5;N+=1){const g=F.opponentPets[N],w=1250-(75*N+50+25);yield s.drawPet(p,g,w,m,!1,50,v)}F.opponentToy&&(yield s.drawToy(p,F.opponentToy,800,m,50,v));const k=1260;if(p.textAlign="left",H){const N=Math.max(f??-1,I??-1,y??-1),g=100===f||100===I||100===y,w=m+8,M=18;if((!g||100===f)&&(p.fillStyle="#137333",p.font=f===N?"bold 16px Arial":"16px Arial",p.fillText(`Win ${H.player}`,k,w)),!g||100===I){const _=g?w:w+M;p.fillStyle="#B00020",p.font=I===N?"bold 16px Arial":"16px Arial",p.fillText(`Loss ${H.opponent}`,k,_)}if(!g||100===y){const _=g?w:w+2*M;p.fillStyle="#000000",p.font=y===N?"bold 16px Arial":"16px Arial",p.fillText(`Draw ${H.draw}`,k,_)}if(!g&&null!==f&&null!==y){const _=f/100+y/100*.5,Q=w+3*M;p.fillStyle="#444444",p.font="14px Arial",p.fillText(`Expected: ${_.toFixed(3)}`,k,Q),R&&(p.fillStyle="#7A5C00",p.font="bold 16px Arial",p.fillText("GAPED",k,Q+M))}}else p.fillStyle="#444444",p.font="16px Arial",p.fillText("Win% unavailable",k,m+22);p.textAlign="center"}const V=P+125*e.length;return p.fillStyle="#FFFFFF",p.fillRect(0,V,1510,60),p.fillStyle="#111111",p.font="14px Arial",p.textAlign="left",p.fillText(`Simulations per turn: ${i}`,25,V+24),new Promise((D,F)=>{T.toBlob(H=>{H?D(H):F(new Error("Failed to create PNG image."))},"image/png")})})()}drawPet(e,t,n,i,s,a,l){var c=this;return(0,K.A)(function*(){const d=yield l(t.imagePath);d&&(s?(e.save(),e.scale(-1,1),e.drawImage(d,-(n+a),i,a,a),e.restore()):e.drawImage(d,n,i,a,a));const h=yield l(t.perkImagePath);h&&e.drawImage(h,n+30,i-10,30,30),e.font="18px Arial",e.fillStyle="green",e.textAlign="center",e.fillText(String(t.attack+t.tempAttack),n+a/4,i+a+20),e.fillStyle="red",e.fillText(String(t.health+t.tempHealth),n+3*a/4,i+a+20),e.font="12px Arial",e.fillStyle="grey",e.fillText("Lvl",n,i-6),e.font="18px Arial",e.fillStyle="orange",e.fillText(String(t.level),n+18,i-7.5);const S=t.xp<2?2:3,T=n-9,P=t.xp<2?14:10,p=t.xp<2?16:12;for(let b=0;b<S;b+=1)c.fillRoundedRect(e,T+b*p,i-2,P,6,2,(t.xp<2?b<t.xp:b<t.xp-2)?"orange":"grey");e.textAlign="left"})()}drawToy(e,t,n,i,s,a){return(0,K.A)(function*(){const l=yield a(t.imagePath);l&&e.drawImage(l,n,i,s,s),e.fillStyle="#111111",e.font="12px Arial",e.textAlign="center",e.fillText(`Lv${t.level}`,n+s/2,i+3*s/2),e.textAlign="left"})()}getReplayActions(e){const t=e.Actions;return Array.isArray(t)?t:null}getReplayBuildModel(e){const t=e.GenesisBuildModel;return this.isObject(t)?t:null}getReplayAbilityPetMap(e){const t=e.abilityPetMap??e.AbilityPetMap;if(!this.isObject(t))return null;const n={};return Object.entries(t).forEach(([i,s])=>{("string"==typeof s||"number"==typeof s)&&(n[i]=s)}),Object.keys(n).length>0?n:null}getReplayIdFromPayload(e){const t=e.replayId;if("string"==typeof t&&t.length>0)return t;const i=this.getRecord(e,"replay")?.id;return"string"==typeof i&&i.length>0?i:null}safeParseBattleJson(e){try{const t=JSON.parse(e);return this.isObject(t)?t:null}catch{return null}}parsePercentValue(e){const t=Number(String(e).replace("%",""));return Number.isFinite(t)?t:null}getBoard(e,t){const i=e[t];return this.isObject(i)?i:null}getBoardPets(e){if(!e)return[];const n=this.getRecord(e,"Mins")?.Items;if(!Array.isArray(n))return[];const i=[];return n.forEach(s=>{if(!this.isObject(s))return;const a=this.toReplayId(s.Enu);if(!a)return;const l=this.toReplayId(s.Perk),c=this.getRecord(s,"At"),d=this.getRecord(s,"Hp"),h=this.toNumberOrFallback(c?.Perm,0),S=this.toNumberOrFallback(d?.Perm,0),T=this.toNumberOrFallback(c?.Temp,0),P=this.toNumberOrFallback(d?.Temp,0),p=Bn.get(a)??null,b=l?En.get(l)??null:null;i.push({imagePath:p?`/assets/art/Public/Public/Pets/${p}.png`:null,perkImagePath:b?`/assets/art/Public/Public/Food/${b}.png`:null,attack:h,health:S,tempAttack:T,tempHealth:P,level:this.toNumberOrFallback(s.Lvl,1),xp:this.toNumberOrFallback(s.Exp,0)})}),i}getBoardToy(e){if(!e)return null;const n=(this.getRecord(e,"Rel")??this.getRecord(e,"Relics"))?.Items??(Array.isArray(e.Relics)?e.Relics:void 0);if(!Array.isArray(n))return null;const i=n.find(l=>this.isObject(l)&&null!==this.toReplayId(l.Enu));if(!i)return null;const s=this.toReplayId(i.Enu);if(!s)return null;const a=Mn.get(s)??null;return{imagePath:a?`/assets/art/Public/Public/Toys/${a}.png`:null,level:this.toNumberOrFallback(i.Lvl,1)}}getBoardLives(e){return e?this.toPositiveInt(e.Lives??e.lives??e.Back??e.health??e.Health):null}getBattleOutcome(e){return this.toNumberOrFallback(e.Outcome,3)}getDisplayName(e,t){if(!e)return null;const i=e[t];if(!this.isObject(i))return null;const s=i.DisplayName;return"string"==typeof s&&s.length>0?s:null}getRecord(e,t){const n=e[t];return this.isObject(n)?n:null}isObject(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}toPositiveInt(e){const t="number"==typeof e?e:Number(e);if(!Number.isFinite(t))return null;const n=Math.trunc(t);return n>0?n:null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}toNumberOrFallback(e,t){const n="number"==typeof e?e:Number(e);return Number.isFinite(n)?n:t}fillRoundedRect(e,t,n,i,s,a,l){const c=Math.max(0,Math.min(a,Math.min(i,s)/2));e.beginPath(),e.moveTo(t+c,n),e.lineTo(t+i-c,n),e.quadraticCurveTo(t+i,n,t+i,n+c),e.lineTo(t+i,n+s-c),e.quadraticCurveTo(t+i,n+s,t+i-c,n+s),e.lineTo(t+c,n+s),e.quadraticCurveTo(t,n+s,t,n+s-c),e.lineTo(t,n+c),e.quadraticCurveTo(t,n,t+c,n),e.closePath(),e.fillStyle=l,e.fill()}static \u0275fac=function(t){return new(t||r)(B.KVO(_e),B.KVO(ft.K),B.KVO(ht.w),B.KVO(yt.K),B.KVO(gt.T),B.KVO(Pt.m),B.KVO(bt.w))};static \u0275prov=B.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var kn=A(19661);const St=Re??Pe??[],wt=ye??ve??[],Ln=ge??Fe??[],xn=new Map(St.filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId])),Hn=new Map(wt.filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId])),Dn=new Map(Ln.filter(r=>typeof r?.Id<"u"&&"string"==typeof r?.NameId).map(r=>[String(r.Id),r.NameId])),je=new Map,$e=new Map;function ue(r){return"string"!=typeof r?"":r.toLowerCase().replace(/[^a-z0-9]/g,"")}St.forEach(r=>{if("string"!=typeof r?.NameId)return;const o=ue(r.Name),e=ue(r.NameId);o&&je.set(o,r.NameId),e&&je.set(e,r.NameId)}),wt.forEach(r=>{if("string"!=typeof r?.NameId)return;const o=ue(r.Name),e=ue(r.NameId);o&&$e.set(o,r.NameId),e&&$e.set(e,r.NameId)});let _n=(()=>{class r{replayCalcService;logService;gameService;abilityService;petService;equipmentService;toyService;constructor(e,t,n,i,s,a,l){this.replayCalcService=e,this.logService=t,this.gameService=n,this.abilityService=i,this.petService=s,this.equipmentService=a,this.toyService=l}buildPositioningImageBlob(e){var t=this;return(0,K.A)(function*(){t.throwIfAborted(e.abortSignal),t.emitProgress(e,0,"Preparing replay turns...","preparing",0,0);const n=t.resolveReplayActionsContainer(e.replayPayload),i=t.extractBattleRows(n);if(0===i.length)throw new Error("Replay JSON did not contain battle turns.");t.emitProgress(e,3,"Parsed replay turns.","preparing",0,i.length);const s=t.getReplayActions(n),a=e.abilityPetMap??t.getReplayAbilityPetMap(n)??(s?se(s):null),l=t.getReplayBuildModel(n),c=[],d=i.length;for(let S=0;S<i.length;S+=1){const T=i[S];t.throwIfAborted(e.abortSignal),t.emitProgress(e,t.computeOverallProgress(S,d,0),`Preparing turn ${S+1}/${d}...`,"optimizing",S+1,d);const P=t.replayCalcService.parseReplayForCalculator(T.battle,l??void 0,void 0,{abilityPetMap:a}),p=S>0?t.getBattleOutcome(i[S-1].battle):null,b={...t.createSimulationConfigFromCalculatorState(P,e.simulationCount),playerLostLastBattle:2===p,opponentLostLastBattle:1===p},v=t.runLocalSimulation(b),O=yield t.runOptimization(b,e.simulationCount,e.optimizationSide,e.abortSignal,C=>{t.emitProgress(e,t.computeOverallProgress(S,d,C),`Optimizing turn ${S+1}/${d} (${Math.round(C)}%)`,"optimizing",S+1,d)});t.throwIfAborted(e.abortSignal);const U={...b,playerPets:"player"===e.optimizationSide?O.bestPermutation.lineup:b.playerPets,opponentPets:"opponent"===e.optimizationSide?O.bestPermutation.lineup:b.opponentPets,simulationCount:e.simulationCount},z=t.runLocalSimulation(U);t.throwIfAborted(e.abortSignal);const V=t.toOddsSummary(v,e.optimizationSide),D=t.toOddsSummary(z,e.optimizationSide),F=t.toOptimizationScore(V),H=t.toOptimizationScore(D),m=t.isStatisticallySignificantImprovement(O,v,e.optimizationSide)&&H>F,I=t.buildDeltaSummary(v,m?z:v,e.optimizationSide),y=m&&"player"===e.optimizationSide?t.buildRenderPetsFromPetConfigLineup(O.bestPermutation.lineup):[],R=m&&"opponent"===e.optimizationSide?t.buildRenderPetsFromPetConfigLineup(O.bestPermutation.lineup):[];c.push({turn:T.turn,battle:T.battle,optimizedPlayerPets:y,optimizedOpponentPets:R,delta:I}),t.emitProgress(e,t.computeOverallProgress(S+1,d,0),`Completed turn ${S+1}/${d}.`,"optimizing",S+1,d)}const h=c.map(S=>t.toRenderBattleInfo(S.battle));return t.emitProgress(e,98,"Rendering image...","rendering",d,d),t.renderPositioningImage(c,h,e.simulationCount,e.optimizationSide)})()}runOptimization(e,t,n,i,s){return typeof Worker<"u"?this.runOptimizationInWorker(e,t,n,i,s):Promise.resolve((0,kn.i)({baseConfig:{...e,simulationCount:t},options:{side:n,maxSimulationsPerPermutation:t,batchSize:Math.max(10,Math.min(25,t))},shouldAbort:()=>!!i?.aborted,onProgress:a=>{if(a.totalBattlesEstimate<=0)return;const l=Math.min(100,Math.max(0,a.completedBattles/a.totalBattlesEstimate*100));s?.(l)},simulateBatch:a=>this.runLocalSimulation(a)}))}runOptimizationInWorker(e,t,n,i,s){return new Promise((a,l)=>{const c=new Worker(A.tu(new URL(A.p+A.u(444),A.b)),{type:void 0});let d=!1;const h=()=>{c.terminate(),i?.removeEventListener("abort",P)},T=p=>{d||(d=!0,h(),l(p))},P=()=>{try{c.postMessage({type:"cancel"})}catch{}T(new Error("Positioning image build cancelled."))};i?.aborted?T(new Error("Positioning image build cancelled.")):(i?.addEventListener("abort",P,{once:!0}),c.onmessage=({data:p})=>{if(p&&p.type){if("positioning-progress"===p.type){const b=p.progress;if(b.totalBattlesEstimate>0){const v=Math.min(100,Math.max(0,b.completedBattles/b.totalBattlesEstimate*100));s?.(v)}return}if("positioning-result"===p.type)return void(p=>{d||(d=!0,h(),a(p))})(p.result);if("positioning-aborted"===p.type)return void T(new Error("Positioning image build cancelled."));"error"===p.type&&T(new Error(p.message||"Worker optimization failed."))}},c.onerror=p=>{T(new Error(p.message||"Worker optimization failed."))},c.postMessage({type:"optimize-positioning-start",config:{...e,simulationCount:t},options:{side:n,maxSimulationsPerPermutation:t,batchSize:Math.max(10,Math.min(25,t))}}))})}buildDeltaSummary(e,t,n){const i=this.toOddsSummary(e,n),s=this.toOddsSummary(t,n);return{baseline:i,optimized:s,deltaWin:s.win-i.win,deltaDraw:s.draw-i.draw,deltaLoss:s.loss-i.loss}}toOddsSummary(e,t){const n=e.playerWins+e.opponentWins+e.draws;return n<=0?{win:0,draw:0,loss:0}:{win:("player"===t?e.playerWins:e.opponentWins)/n*100,draw:e.draws/n*100,loss:("player"===t?e.opponentWins:e.playerWins)/n*100}}toOptimizationScore(e){return e.win+.5*e.draw}isStatisticallySignificantImprovement(e,t,n){const i=e?.bestPermutation?.lowerBound;if(!Number.isFinite(i))return!1;const s=t.playerWins+t.opponentWins+t.draws;if(s<=0)return!1;const a=this.toOddsSummary(t,n),l=this.toOptimizationScore(a)/100,c=Math.max(0,l*(1-l)),d=1.96*Math.sqrt(c/s);return i>Math.min(1,l+d)}buildRenderPetsFromPetConfigLineup(e){return e.map(t=>{if(!t?.name)return null;const n=je.get(ue(t.name))??null,i=t?.equipment?.name??null,s=i?$e.get(ue(i))??null:null;return{imagePath:n?`/assets/art/Public/Public/Pets/${n}.png`:null,perkImagePath:s?`/assets/art/Public/Public/Food/${s}.png`:null,attack:this.toNumberOrFallback(t.attack,0),health:this.toNumberOrFallback(t.health,0),level:this.toNumberOrFallback(t.exp,1)>=5?3:this.toNumberOrFallback(t.exp,1)>=2?2:1,xp:this.toNumberOrFallback(t.exp,0)}})}renderPositioningImage(e,t,n,i){var s=this;return(0,K.A)(function*(){const T=document.createElement("canvas"),P=t[0]?.playerName&&t[0]?.opponentName?36:0;T.width=1610,T.height=P+125*e.length+60;const p=T.getContext("2d");if(!p)throw new Error("Canvas rendering is not available in this browser.");const b=new Map,v=E=>{if(!E)return Promise.resolve(null);const m=b.get(E);if(m)return m;const f=new Promise(I=>{const y=new Image;y.onload=()=>I(y),y.onerror=()=>I(null),y.src=E});return b.set(E,f),f},z=yield v("/assets/art/Public/Public/Icons/heart-from-textmap.png");p.fillStyle="#FFFFFF",p.fillRect(0,0,1610,T.height),P>0&&(p.fillStyle="#000000",p.font="18px Arial",p.textAlign="center",p.fillText(`${t[0]?.playerName} vs ${t[0]?.opponentName} (Optimized Positioning)`,805,24),p.textAlign="left");for(let E=0;E<e.length;E+=1){const m=t[E],f=e[E],I=P+125*E,y=I+25,R="player"===i&&f.optimizedPlayerPets.length>0?f.optimizedPlayerPets:m.playerPets,C="opponent"===i&&f.optimizedOpponentPets.length>0?f.optimizedOpponentPets:m.opponentPets;p.fillStyle=1===m.outcome?"#E6F4EA":2===m.outcome?"#FDECEA":"#F2F2F2",p.fillRect(0,I,1610,125),p.fillStyle="#000000",p.font="24px Arial",p.fillText(String(f.turn),90,y+25+6),z&&(p.drawImage(z,150,y,50,50),null!==m.playerLives&&(p.fillStyle="#FFFFFF",p.font="24px Arial",p.textAlign="center",p.fillText(String(m.playerLives),175,y+26+6),p.textAlign="left")),p.fillStyle="#111111",p.font="18px Arial",p.fillText(1===m.outcome?"WIN":2===m.outcome?"LOSS":"DRAW",157,y+50+26);for(let w=0;w<R.length&&w<5;w+=1){const M=R[w];if(!M)continue;const _=75*w+25+150+65;yield s.drawPet(p,M,_,y,!0,50,v)}m.playerToy&&(yield s.drawToy(p,m.playerToy,590,y,50,v));for(let w=0;w<C.length&&w<5;w+=1){const M=C[w];if(!M)continue;const _=1250-(75*w+50+25);yield s.drawPet(p,M,_,y,!1,50,v)}m.opponentToy&&(yield s.drawToy(p,m.opponentToy,800,y,50,v));const N=1260,g=f.delta;s.hasVisibleOddsChange(g)&&(p.textAlign="left",p.fillStyle="#137333",p.font="bold 15px Arial",p.fillText(`Win ${g.baseline.win.toFixed(1)}% -> ${g.optimized.win.toFixed(1)}% (${s.formatDelta(g.deltaWin)}%)`,N,y+8),p.fillStyle="#000000",p.font="15px Arial",p.fillText(`Draw ${g.baseline.draw.toFixed(1)}% -> ${g.optimized.draw.toFixed(1)}% (${s.formatDelta(g.deltaDraw)}%)`,N,y+28),p.fillStyle="#B00020",p.font="15px Arial",p.fillText(`Loss ${g.baseline.loss.toFixed(1)}% -> ${g.optimized.loss.toFixed(1)}% (${s.formatDelta(g.deltaLoss)}%)`,N,y+48)),p.textAlign="center"}const V=P+125*e.length,D=e.reduce((E,m)=>E+m.delta.deltaWin,0),F=e.reduce((E,m)=>E+m.delta.deltaLoss,0),H=e.reduce((E,m)=>E+m.delta.deltaDraw,0);return p.fillStyle="#FFFFFF",p.fillRect(0,V,1610,60),p.fillStyle="#111111",p.font="14px Arial",p.textAlign="left",p.fillText(`Simulations per turn: ${n} | Optimization side: ${i}`,25,V+24),p.fillText(`Total optimize delta across turns: Win ${s.formatDelta(D)}% | Loss ${s.formatDelta(F)}% | Draw ${s.formatDelta(H)}%`,25,V+44),new Promise((E,m)=>{T.toBlob(f=>{f?E(f):m(new Error("Failed to create PNG image."))},"image/png")})})()}formatDelta(e){const t=e.toFixed(1);return e>0?`+${t}`:t}hasVisibleOddsChange(e){const t=n=>Math.round(10*n)/10;return t(e.baseline.win)!==t(e.optimized.win)||t(e.baseline.draw)!==t(e.optimized.draw)||t(e.baseline.loss)!==t(e.optimized.loss)}drawPet(e,t,n,i,s,a,l){return(0,K.A)(function*(){const c=yield l(t.imagePath);c&&(s?(e.save(),e.scale(-1,1),e.drawImage(c,-(n+a),i,a,a),e.restore()):e.drawImage(c,n,i,a,a));const d=yield l(t.perkImagePath);d&&e.drawImage(d,n+30,i-10,30,30),e.font="18px Arial",e.fillStyle="green",e.textAlign="center",e.fillText(String(t.attack),n+a/4,i+a+20),e.fillStyle="red",e.fillText(String(t.health),n+3*a/4,i+a+20),e.font="12px Arial",e.fillStyle="grey",e.fillText("Lvl",n,i-6),e.font="18px Arial",e.fillStyle="orange",e.fillText(String(t.level),n+18,i-7.5),e.textAlign="left"})()}drawToy(e,t,n,i,s,a){return(0,K.A)(function*(){const l=yield a(t.imagePath);l&&e.drawImage(l,n,i,s,s),e.fillStyle="#111111",e.font="12px Arial",e.textAlign="center",e.fillText(`Lv${t.level}`,n+s/2,i+3*s/2),e.textAlign="left"})()}runLocalSimulation(e){const t=this.gameService.gameApi?{...this.gameService.gameApi}:null,n=this.logService.isEnabled(),i=this.logService.isDeferDecorations(),s=this.logService.isShowTriggerNamesInLogs(),a=new mt.O(this.logService,this.gameService,this.abilityService,this.petService,this.equipmentService,this.toyService);try{return a.run(e)}finally{t&&(this.gameService.gameApi=t),this.logService.setEnabled(n),this.logService.setDeferDecorations(i),this.logService.setShowTriggerNamesInLogs(s)}}createSimulationConfigFromCalculatorState(e,t){return{playerPack:e.playerPack,opponentPack:e.opponentPack,playerToy:e.playerToy,playerToyLevel:this.toNumberOrFallback(e.playerToyLevel,1),playerHardToy:e.playerHardToy,playerHardToyLevel:e.playerHardToyLevel,opponentToy:e.opponentToy,opponentToyLevel:this.toNumberOrFallback(e.opponentToyLevel,1),opponentHardToy:e.opponentHardToy,opponentHardToyLevel:e.opponentHardToyLevel,turn:e.turn,playerGoldSpent:e.playerGoldSpent,opponentGoldSpent:e.opponentGoldSpent,playerRollAmount:e.playerRollAmount,opponentRollAmount:e.opponentRollAmount,playerSummonedAmount:e.playerSummonedAmount,opponentSummonedAmount:e.opponentSummonedAmount,playerLevel3Sold:e.playerLevel3Sold,opponentLevel3Sold:e.opponentLevel3Sold,playerTransformationAmount:e.playerTransformationAmount,opponentTransformationAmount:e.opponentTransformationAmount,playerPets:e.playerPets,opponentPets:e.opponentPets,customPacks:e.customPacks,allPets:e.allPets,oldStork:e.oldStork,tokenPets:e.tokenPets,komodoShuffle:e.komodoShuffle,mana:e.mana,seed:e.seed,simulationCount:t,logsEnabled:!1,maxLoggedBattles:0}}resolveReplayActionsContainer(e){const t=this.getRecord(e,"raw_json");if(t&&Array.isArray(t.Actions))return t;const n=this.getRecord(e,"replay"),i=n?this.getRecord(n,"raw_json"):null;return i&&Array.isArray(i.Actions)?i:e}extractBattleRows(e){const t=this.getReplayActions(e);if(!t||0===t.length)return[];let n=1;return t.map(i=>{const s=this.toNumberOrFallback(i?.Type,0);if(0!==s&&1!==s||"string"!=typeof i.Battle)return null;const a=this.safeParseBattleJson(i.Battle);if(!a)return null;const c={turn:this.toPositiveInt(i.Turn)??n,battle:a};return n+=1,c}).filter(i=>null!==i)}toRenderBattleInfo(e){const t=this.getBoard(e,"UserBoard"),n=this.getBoard(e,"OpponentBoard");return{outcome:this.getBattleOutcome(e),playerName:this.getDisplayName(e,"User"),opponentName:this.getDisplayName(e,"Opponent"),playerLives:this.getBoardLives(t),opponentLives:this.getBoardLives(n),playerPets:this.getBoardPets(t),opponentPets:this.getBoardPets(n),playerToy:this.getBoardToy(t),opponentToy:this.getBoardToy(n)}}getReplayActions(e){const t=e.Actions;return Array.isArray(t)?t:null}getReplayBuildModel(e){const t=e.GenesisBuildModel;return this.isObject(t)?t:null}getReplayAbilityPetMap(e){const t=e.abilityPetMap??e.AbilityPetMap;if(!this.isObject(t))return null;const n={};return Object.entries(t).forEach(([i,s])=>{("string"==typeof s||"number"==typeof s)&&(n[i]=s)}),Object.keys(n).length>0?n:null}safeParseBattleJson(e){try{const t=JSON.parse(e);return this.isObject(t)?t:null}catch{return null}}getBoard(e,t){const i=e[t];return this.isObject(i)?i:null}getBoardPets(e){if(!e)return[];const n=this.getRecord(e,"Mins")?.Items;if(!Array.isArray(n))return[];const i=[];return n.forEach(s=>{if(!this.isObject(s))return;const a=this.toReplayId(s.Enu);if(!a)return;const l=this.toReplayId(s.Perk),c=this.getRecord(s,"At"),d=this.getRecord(s,"Hp"),h=this.toNumberOrFallback(c?.Perm,0),S=this.toNumberOrFallback(d?.Perm,0),T=xn.get(a)??null,P=l?Hn.get(l)??null:null;i.push({imagePath:T?`/assets/art/Public/Public/Pets/${T}.png`:null,perkImagePath:P?`/assets/art/Public/Public/Food/${P}.png`:null,attack:h,health:S,level:this.toNumberOrFallback(s.Lvl,1),xp:this.toNumberOrFallback(s.Exp,0)})}),i}getBoardToy(e){if(!e)return null;const n=(this.getRecord(e,"Rel")??this.getRecord(e,"Relics"))?.Items??(Array.isArray(e.Relics)?e.Relics:void 0);if(!Array.isArray(n))return null;const i=n.find(l=>this.isObject(l)&&null!==this.toReplayId(l.Enu));if(!i)return null;const s=this.toReplayId(i.Enu);if(!s)return null;const a=Dn.get(s)??null;return{imagePath:a?`/assets/art/Public/Public/Toys/${a}.png`:null,level:this.toNumberOrFallback(i.Lvl,1)}}getBoardLives(e){return e?this.toPositiveInt(e.Lives??e.lives??e.Back??e.health??e.Health):null}getBattleOutcome(e){return this.toNumberOrFallback(e.Outcome,3)}getDisplayName(e,t){if(!e)return null;const i=e[t];if(!this.isObject(i))return null;const s=i.DisplayName;return"string"==typeof s&&s.length>0?s:null}getRecord(e,t){const n=e[t];return this.isObject(n)?n:null}isObject(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}toPositiveInt(e){const t="number"==typeof e?e:Number(e);if(!Number.isFinite(t))return null;const n=Math.trunc(t);return n>0?n:null}toReplayId(e){return"number"==typeof e&&Number.isFinite(e)?String(e):"string"==typeof e&&e.length>0?e:null}toNumberOrFallback(e,t){const n="number"==typeof e?e:Number(e);return Number.isFinite(n)?n:t}throwIfAborted(e){if(e?.aborted)throw new Error("Positioning image build cancelled.")}emitProgress(e,t,n,i,s,a){e.onProgress?.({percent:Math.max(0,Math.min(100,t)),message:n,phase:i,currentTurn:s,totalTurns:a})}computeOverallProgress(e,t,n){if(t<=0)return 0;const i=95/t,s=e*i,a=Math.max(0,Math.min(100,n))/100*i;return 3+Math.min(95,s+a)}static \u0275fac=function(t){return new(t||r)(B.KVO(_e),B.KVO(ft.K),B.KVO(ht.w),B.KVO(yt.K),B.KVO(gt.T),B.KVO(Pt.m),B.KVO(bt.w))};static \u0275prov=B.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();const jn=(r,o,e)=>({"text-success":r,"text-danger":o,"text-warning":e});function $n(r,o){if(1&r){const e=u.RV6();u.j41(0,"div",20)(1,"div",21)(2,"div",22),u.EFF(3),u.k0s(),u.j41(4,"button",23),u.bIt("click",function(){B.eBV(e);const n=u.XpG();return B.Njj(n.cancelPositioningBuild())}),u.EFF(5," Cancel "),u.k0s()(),u.j41(6,"div",24)(7,"div",25),u.EFF(8),u.k0s()()()}if(2&r){const e=u.XpG();u.R7$(3),u.SpI(" ",e.positioningProgressMessage||"Building positioning image..."," "),u.R7$(4),u.xc7("width",e.positioningProgressPercent,"%"),u.BMQ("aria-valuenow",e.positioningProgressPercent),u.R7$(),u.SpI(" ",e.positioningProgressPercent,"% ")}}function Un(r,o){if(1&r&&(u.j41(0,"div",26),u.EFF(1),u.k0s()),2&r){const e=u.XpG();u.Y8G("ngClass",u.sMw(2,jn,"success"===e.statusTone,"error"===e.statusTone,"warning"===e.statusTone)),u.R7$(),u.SpI(" ",e.statusMessage," ")}}function Gn(r,o){if(1&r){const e=u.RV6();u.j41(0,"div",27)(1,"div",28)(2,"strong"),u.EFF(3,"Odds Image Preview"),u.k0s(),u.j41(4,"span",29),u.EFF(5),u.k0s()(),u.nrm(6,"img",30),u.j41(7,"div",31)(8,"button",32),u.bIt("click",function(){B.eBV(e);const n=u.XpG();return B.Njj(n.downloadOddsImage())}),u.EFF(9," Download PNG "),u.k0s(),u.j41(10,"button",33),u.bIt("click",function(){B.eBV(e);const n=u.XpG();return B.Njj(n.clearOddsPreview())}),u.EFF(11," Clear Preview "),u.k0s()()()}if(2&r){const e=u.XpG();u.R7$(5),u.JRh(e.oddsImageFileName),u.R7$(),u.Y8G("src",e.oddsImagePreviewUrl,u.B4B)}}function Wn(r,o){if(1&r){const e=u.RV6();u.j41(0,"div",27)(1,"div",28)(2,"strong"),u.EFF(3,"Positioning Image Preview"),u.k0s(),u.j41(4,"span",29),u.EFF(5),u.k0s()(),u.nrm(6,"img",34),u.j41(7,"div",31)(8,"button",35),u.bIt("click",function(){B.eBV(e);const n=u.XpG();return B.Njj(n.downloadPositioningImage())}),u.EFF(9," Download PNG "),u.k0s(),u.j41(10,"button",33),u.bIt("click",function(){B.eBV(e);const n=u.XpG();return B.Njj(n.clearPositioningPreview())}),u.EFF(11," Clear Preview "),u.k0s()()()}if(2&r){const e=u.XpG();u.R7$(5),u.JRh(e.positioningImageFileName),u.R7$(),u.Y8G("src",e.positioningImagePreviewUrl,u.B4B)}}function Vn(r,o){if(1&r&&(u.j41(0,"div",36),u.EFF(1),u.k0s()),2&r){const e=u.XpG();u.R7$(),u.JRh(e.errorMessage)}}let zn=(()=>{class r{replayCalcService;replayOddsImageService;replayPositioningImageService;cdr;importFunc;pidExample='{"Pid":"ce7b41c5-d69d-4152-8c5d-0d5fee869f9f","T":6}';formGroup=new j.gE({calcCode:new j.MJ(null,j.k0.required),turn:new j.MJ(1,j.k0.min(1)),oddsSimulations:new j.MJ(100,j.k0.min(1)),positioningSide:new j.MJ("player")});errorMessage="";statusMessage="";statusTone="success";loading=!1;oddsImageLoading=!1;positioningImageLoading=!1;oddsImageBlob=null;oddsImagePreviewUrl=null;oddsImageFileName="";positioningImageBlob=null;positioningImagePreviewUrl=null;positioningImageFileName="";positioningProgressPercent=0;positioningProgressMessage="";positioningBuildAbortController=null;destroyed=!1;replayTimeoutMs=1e4;replayHealthTimeoutMs=2500;maxPositioningSimulations=50;statusTimer=null;constructor(e,t,n,i){this.replayCalcService=e,this.replayOddsImageService=t,this.replayPositioningImageService=n,this.cdr=i}ngOnInit(){this.destroyed=!1}ngOnDestroy(){this.destroyed=!0,this.cancelPositioningBuild(),this.clearOddsPreview(),this.clearPositioningPreview()}isReplayTurnsPayload(e){return Array.isArray(e.turns)}submit(){this.errorMessage="",this.clearStatus();const t=this.formGroup.get("calcCode")?.value?.trim();if(!t)return void(this.errorMessage="Paste calculator JSON or replay JSON.");const n=xe(t);if(n?.battle)return void this.importReplayBattle(n.battle,n.genesisBuildModel,void 0,{abilityPetMap:n.abilityPetMap??null});let i;try{i=JSON.parse(t)}catch{if(this.importFunc(t))return void this.setStatus("Import successful.","success");if(this.tryReplayPid(t))return;return void(this.errorMessage="Invalid JSON. Please paste a valid calculator or replay JSON.")}if((i?.Pid||i?.pid)&&!i?.Actions){const s=i?.Pid??i?.pid,a=Number(i?.T??i?.t??this.formGroup.get("turn").value);return!Number.isFinite(a)||a<=0?void(this.errorMessage="Enter a valid turn number."):(this.setLoading(!0),void this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(l=>{if(!l.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();l.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:s,T:a,onReplayIndexUploadStatus:c=>this.handleReplayIndexUploadStatus(c)},this.replayTimeoutMs).pipe((0,Ge.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:c=>{const d=c?.battle;d?this.importReplayBattle(d,c?.genesisBuildModel,void 0,{abilityPetMap:c?.abilityPetMap??null},{resetBattle:!0,suppressSuccessStatus:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:c=>{if("TimeoutError"===c?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=c?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}))}if(i?.UserBoard&&i?.OpponentBoard)this.importReplayBattle(i,i?.GenesisBuildModel,{userBoard:i?.UserBoard,opponentBoard:i?.OpponentBoard},{abilityPetMap:i?.AbilityPetMap??null});else{if(i?.Actions){const s=Number(this.formGroup.get("turn").value??i?.T);if(!Number.isFinite(s)||s<=0)return void(this.errorMessage="Enter a valid turn number.");let a=0,l=null;for(const d of i.Actions)if(0===d?.Type&&d?.Battle&&(a+=1,a===s)){try{l=JSON.parse(d.Battle)}catch{return void(this.errorMessage=`Failed to parse battle JSON for turn ${s}.`)}break}if(!l)return void(this.errorMessage=`No battle found for turn ${s}.`);const c=i?.AbilityPetMap??se(i.Actions);return void this.importReplayBattle(l,i?.GenesisBuildModel,{userBoard:i?.UserBoard,opponentBoard:i?.OpponentBoard},{abilityPetMap:c})}if(this.isReplayTurnsPayload(i)){const s=Number(this.formGroup.get("turn").value);if(!Number.isFinite(s)||s<=0)return void(this.errorMessage="Enter a valid turn number.");try{const l=this.replayCalcService.buildReplayBattleResponseFromTurns(i,s,i?.replay?.id||"manual-import");if(l?.battle)return void this.importReplayBattle(l.battle,l.genesisBuildModel,void 0,{abilityPetMap:l.abilityPetMap??null},{resetBattle:!0})}catch(a){return void(this.errorMessage="Failed to process turns JSON.")}}this.importFunc(t)?this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}}buildOddsImage(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode")?.value?.trim();if(!e)return void(this.errorMessage="Paste replay JSON or a replay Pid first.");const t=this.getOddsSimulationCount(),n=this.getRequestedTurn(),i=xe(e);if(i?.battle){const l=this.buildSingleBattleReplayPayload(i.battle,i.turn??n,i.genesisBuildModel??null,i.abilityPetMap??null);return void this.requestOddsImageDownload({replay:l,simulationCount:t,abilityPetMap:i.abilityPetMap??null})}let s;try{s=JSON.parse(e)}catch{const l=e.trim();return this.looksLikePid(l)?void this.fetchReplayJsonAndBuildOddsImage(l,n,t):void(this.errorMessage="Invalid JSON. Paste replay JSON or a replay Pid.")}if((s?.Pid||s?.pid)&&!s?.Actions){const l=String(s?.Pid??s?.pid);return void this.fetchReplayJsonAndBuildOddsImage(l,n,t)}const a=this.buildOddsImageSourceFromPayload(s,n,t);a?this.requestOddsImageDownload(a):this.errorMessage="Replay JSON must include Actions, turns, replay.raw_json.Actions, or UserBoard/OpponentBoard."}buildPositioningImage(){this.errorMessage="",this.clearStatus();const e=this.formGroup.get("calcCode")?.value?.trim();if(!e)return void(this.errorMessage="Paste replay JSON or a replay Pid first.");const t=this.getPositioningSimulationCount(),n=this.getRequestedTurn(),i=this.getPositioningSide(),s=xe(e);if(s?.battle){const c=this.buildSingleBattleReplayPayload(s.battle,s.turn??n,s.genesisBuildModel??null,s.abilityPetMap??null);return void this.requestPositioningImageDownload({replay:c,simulationCount:t,optimizationSide:i,abilityPetMap:s.abilityPetMap??null})}let a;try{a=JSON.parse(e)}catch{const c=e.trim();return this.looksLikePid(c)?void this.fetchReplayJsonAndBuildPositioningImage(c,n,t,i):void(this.errorMessage="Invalid JSON. Paste replay JSON or a replay Pid.")}if((a?.Pid||a?.pid)&&!a?.Actions){const c=String(a?.Pid??a?.pid);return void this.fetchReplayJsonAndBuildPositioningImage(c,n,t,i)}const l=this.buildOddsImageSourceFromPayload(a,n,t);l?this.requestPositioningImageDownload({...l,optimizationSide:i}):this.errorMessage="Replay JSON must include Actions, turns, replay.raw_json.Actions, or UserBoard/OpponentBoard."}importReplayBattle(e,t,n,i,s){const a=this.replayCalcService.parseReplayForCalculator(e,t,n,i);this.importFunc(JSON.stringify(a),{resetBattle:s?.resetBattle})?s?.suppressSuccessStatus||this.setStatus("Import successful.","success"):this.errorMessage="Import failed."}tryReplayPid(e){const t=e?.trim();if(!t||!/^[a-f0-9-]{16,}$/i.test(t)&&!/^\d+$/.test(t))return!1;const i=Number(this.formGroup.get("turn").value);return!Number.isFinite(i)||i<=0?(this.errorMessage="Enter a valid turn number.",!0):(this.setLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(s=>{if(!s.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay server is running.",this.setLoading(!1),void this.cdr.markForCheck();s.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),console.info("[replay] health check reachable, requesting battle"),this.replayCalcService.fetchReplayBattle({Pid:t,T:i,onReplayIndexUploadStatus:a=>this.handleReplayIndexUploadStatus(a)},this.replayTimeoutMs).pipe((0,Ge.j)(()=>{this.setLoading(!1),console.info("[replay] replay-battle request finalized")})).subscribe({next:a=>{const l=a?.battle;l?this.importReplayBattle(l,a?.genesisBuildModel,void 0,{abilityPetMap:a?.abilityPetMap??null},{resetBattle:!0,suppressSuccessStatus:!0}):this.errorMessage="Replay lookup failed to return a battle."},error:a=>{if("TimeoutError"===a?.name)return this.errorMessage="Replay lookup timed out. Ensure the replay server is running.",void this.cdr.markForCheck();this.errorMessage=a?.error?.error||"Failed to fetch replay data.",this.cdr.markForCheck()}})}).catch(()=>{this.setLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()}),!0)}handleReplayIndexUploadStatus(e){if("success"===e.outcome)return this.setStatus(e.message,"success"),void this.cdr.markForCheck();this.setStatus(e.message,"warning"),this.cdr.markForCheck()}fetchReplayJsonAndBuildOddsImage(e,t,n){this.setOddsImageLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(i=>{if(!i.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay backend is available.",this.setOddsImageLoading(!1),void this.cdr.markForCheck();i.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),this.replayCalcService.fetchReplayTurns({Pid:e,T:t,onReplayIndexUploadStatus:s=>this.handleReplayIndexUploadStatus(s)},this.replayTimeoutMs).subscribe({next:s=>{this.destroyed?this.setPositioningImageLoading(!1):this.resolveOddsReplayPayloadFromTurns(s,e).then(a=>{this.requestOddsImageDownload({replay:a,simulationCount:n,abilityPetMap:s?.abilityPetMap??null},e)}).catch(a=>{this.handleOddsImageError(a),this.setOddsImageLoading(!1)})},error:s=>{this.errorMessage=s?.error?.error||"Failed to fetch replay JSON from replay API.",this.setOddsImageLoading(!1),this.cdr.markForCheck()}})}).catch(()=>{this.setOddsImageLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()})}fetchReplayJsonAndBuildPositioningImage(e,t,n,i){this.setPositioningImageLoading(!0),this.replayCalcService.checkReplayApiHealth(this.replayHealthTimeoutMs).then(s=>{if(!s.reachable)return this.errorMessage="Replay API is not reachable. Ensure the replay backend is available.",this.setPositioningImageLoading(!1),void this.cdr.markForCheck();s.isReplayHealthContract||this.setStatus("Replay API is reachable, but /api/health is not the replay backend format. Continuing lookup.","warning"),this.replayCalcService.fetchReplayTurns({Pid:e,T:t,onReplayIndexUploadStatus:a=>this.handleReplayIndexUploadStatus(a)},this.replayTimeoutMs).subscribe({next:a=>{this.resolveOddsReplayPayloadFromTurns(a,e).then(l=>{this.destroyed?this.setPositioningImageLoading(!1):this.requestPositioningImageDownload({replay:l,simulationCount:n,optimizationSide:i,abilityPetMap:a?.abilityPetMap??null},e)}).catch(l=>{this.handleOddsImageError(l),this.setPositioningImageLoading(!1)})},error:a=>{this.errorMessage=a?.error?.error||"Failed to fetch replay JSON from replay API.",this.setPositioningImageLoading(!1),this.cdr.markForCheck()}})}).catch(()=>{this.setPositioningImageLoading(!1),this.errorMessage="Failed to reach the replay API.",this.cdr.markForCheck()})}resolveOddsReplayPayloadFromTurns(e,t){var n=this;return(0,K.A)(function*(){if(n.hasRawReplayActions(e))return e;const i=n.buildActionsFromTurnsPayload(e?.turns??null);if(i.length>0)return n.buildReplayPayloadFromHydratedActions(e,i);const s=n.buildActionsFromTurnsSummary(e,t);if(s.length>0)return n.buildReplayPayloadFromHydratedActions(e,s);const a=n.getReplayTurnCount(e);if(a<=0)return e;const l=[];for(let c=1;c<=a;c+=1)try{const d=yield n.replayCalcService.fetchReplayBattleDirect({Pid:t,T:c},n.replayTimeoutMs).toPromise();d?.battle&&l.push({Type:0,Turn:c,Battle:JSON.stringify(d.battle)})}catch{}if(0===l.length)throw new Error("Replay lookup did not include usable battle payloads in turns JSON.");return l.length<a&&n.setStatus(`Loaded ${l.length}/${a} turns. Some turns may be missing from the preview.`,"warning"),n.buildReplayPayloadFromHydratedActions(e,l)})()}hasRawReplayActions(e){return!!Array.isArray(e?.replay?.raw_json?.Actions)}getReplayTurnCount(e){const t=e?.turns;if(Array.isArray(t)&&t.length>0)return t.length;const n=e?.replay?.raw_json?.Actions;if(Array.isArray(n)&&n.length>0){const i=n.filter(s=>0===s?.Type);return i.length>0?i.length:n.length}return 0}buildActionsFromTurnsPayload(e){if(!Array.isArray(e)||0===e.length)return[];const t=[];let n=1;return e.forEach(i=>{if(!i||"object"!=typeof i)return;const s=i,a=s.Battle;if("string"!=typeof a||0===a.trim().length)return;const l=Number(s.Type);if(Number.isFinite(l)&&0!==l)return;let c=Number(s.Turn??s.turn??s.turnNumber);(!Number.isFinite(c)||c<=0)&&(c=n),t.push({Type:0,Turn:Math.trunc(c),Battle:a}),n+=1}),t}buildActionsFromTurnsSummary(e,t){const n=this.getReplayTurnCount(e);if(n<=0)return[];const i=this.replayCalcService,s=[];for(let a=1;a<=n;a+=1)try{const l=i.buildReplayBattleResponseFromTurns(e,a,t);l?.battle&&s.push({Type:0,Turn:a,Battle:JSON.stringify(l.battle)})}catch{}return s}buildReplayPayloadFromHydratedActions(e,t){return{Actions:t,GenesisBuildModel:e?.genesisBuildModel??e?.replay?.raw_json?.GenesisBuildModel??e?.replay?.GenesisBuildModel??null,AbilityPetMap:e?.abilityPetMap??null}}buildOddsImageSourceFromPayload(e,t,n){return e?.Actions?{replay:e,simulationCount:n,abilityPetMap:e.AbilityPetMap??se(e.Actions)}:e?.UserBoard&&e?.OpponentBoard?{replay:this.buildSingleBattleReplayPayload(e,t,e.GenesisBuildModel??null,e.AbilityPetMap??null),simulationCount:n,abilityPetMap:e.AbilityPetMap??null}:e?.raw_json?.Actions?{replay:e.raw_json,simulationCount:n,abilityPetMap:e.AbilityPetMap??null}:e?.replay?.raw_json?.Actions?{replay:e.replay.raw_json,simulationCount:n,abilityPetMap:e.AbilityPetMap??null}:this.isReplayTurnsPayload(e)?{replay:e,simulationCount:n,abilityPetMap:e.AbilityPetMap??null}:null}buildSingleBattleReplayPayload(e,t,n,i){return{Actions:[{Type:0,Turn:t,Battle:JSON.stringify(e)}],GenesisBuildModel:n??null,AbilityPetMap:i??null}}requestOddsImageDownload(e,t){this.setOddsImageLoading(!0),this.replayOddsImageService.buildOddsImageBlob({replayPayload:e.replay,simulationCount:e.simulationCount,abilityPetMap:e.abilityPetMap??null}).then(n=>{this.setOddsPreview(n,t),this.setStatus("Replay odds image ready. Preview and download below.","success")}).catch(n=>{this.handleOddsImageError(n)}).finally(()=>{this.setOddsImageLoading(!1)})}requestPositioningImageDownload(e,t){this.cancelPositioningBuild();const n=new AbortController;this.positioningBuildAbortController=n,this.setPositioningImageLoading(!0),this.replayPositioningImageService.buildPositioningImageBlob({replayPayload:e.replay,simulationCount:e.simulationCount,optimizationSide:e.optimizationSide??"player",abilityPetMap:e.abilityPetMap??null,abortSignal:n.signal,onProgress:i=>{this.positioningProgressPercent=Math.round(i.percent),this.positioningProgressMessage=i.message,this.cdr.markForCheck()}}).then(i=>{n.signal.aborted||(this.setPositioningPreview(i,t),this.setStatus("Positioning image ready. Preview and download below.","success"))}).catch(i=>{const s=i instanceof Error?i.message:"";n.signal.aborted||"Positioning image build cancelled."===s?this.setStatus("Positioning image build cancelled.","warning"):this.handleOddsImageError(i)}).finally(()=>{this.positioningBuildAbortController===n&&(this.positioningBuildAbortController=null,this.setPositioningImageLoading(!1),this.clearPositioningProgress())})}downloadOddsImage(){if(!this.oddsImageBlob)return;const e=window.URL.createObjectURL(this.oddsImageBlob),t=document.createElement("a");t.href=e,t.download=this.oddsImageFileName||`replay-odds-${(new Date).toISOString().slice(0,10)}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(e)}clearOddsPreview(){this.oddsImagePreviewUrl&&window.URL.revokeObjectURL(this.oddsImagePreviewUrl),this.oddsImagePreviewUrl=null,this.oddsImageBlob=null,this.oddsImageFileName=""}downloadPositioningImage(){if(!this.positioningImageBlob)return;const e=window.URL.createObjectURL(this.positioningImageBlob),t=document.createElement("a");t.href=e,t.download=this.positioningImageFileName||`replay-positioning-${(new Date).toISOString().slice(0,10)}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(e)}clearPositioningPreview(){this.positioningImagePreviewUrl&&window.URL.revokeObjectURL(this.positioningImagePreviewUrl),this.positioningImagePreviewUrl=null,this.positioningImageBlob=null,this.positioningImageFileName=""}setOddsPreview(e,t){this.clearOddsPreview(),this.oddsImageBlob=e,this.oddsImagePreviewUrl=window.URL.createObjectURL(e);const n="string"==typeof t?t.replace(/[^a-zA-Z0-9_-]/g,""):"";this.oddsImageFileName=n?`replay-odds-${n}.png`:`replay-odds-${(new Date).toISOString().slice(0,10)}.png`,this.cdr.markForCheck()}setPositioningPreview(e,t){this.clearPositioningPreview(),this.positioningImageBlob=e,this.positioningImagePreviewUrl=window.URL.createObjectURL(e);const n="string"==typeof t?t.replace(/[^a-zA-Z0-9_-]/g,""):"";this.positioningImageFileName=n?`replay-positioning-${n}.png`:`replay-positioning-${(new Date).toISOString().slice(0,10)}.png`,this.cdr.markForCheck()}handleOddsImageError(e){let t="Failed to build replay odds image.";e instanceof Error&&e.message?t=e.message:"string"==typeof e&&e.trim().length>0&&(t=e),this.errorMessage=t,this.cdr.markForCheck()}looksLikePid(e){return/^[a-f0-9-]{16,}$/i.test(e)||/^\d+$/.test(e)}getRequestedTurn(){const e=Number(this.formGroup.get("turn")?.value??1);return Number.isFinite(e)&&e>0?Math.trunc(e):1}getOddsSimulationCount(){const e=Number(this.formGroup.get("oddsSimulations")?.value??100);return Number.isFinite(e)&&e>0?Math.trunc(e):100}getPositioningSimulationCount(){const e=this.getOddsSimulationCount();return e>this.maxPositioningSimulations?(this.setStatus(`Positioning image simulations capped at ${this.maxPositioningSimulations}.`,"warning"),this.maxPositioningSimulations):e}getPositioningSide(){return"opponent"===this.formGroup.get("positioningSide")?.value?"opponent":"player"}setLoading(e){this.loading=e,this.cdr.markForCheck()}setOddsImageLoading(e){this.oddsImageLoading=e,this.cdr.markForCheck()}setPositioningImageLoading(e){this.positioningImageLoading=e,e&&(this.positioningProgressPercent=Math.max(this.positioningProgressPercent,1),this.positioningProgressMessage||(this.positioningProgressMessage="Starting positioning build...")),this.cdr.markForCheck()}cancelPositioningBuild(){this.positioningBuildAbortController&&(this.positioningBuildAbortController.abort(),this.positioningBuildAbortController=null,this.setPositioningImageLoading(!1),this.clearPositioningProgress())}clearPositioningProgress(){this.positioningProgressPercent=0,this.positioningProgressMessage=""}clearStatus(){this.statusTimer&&(clearTimeout(this.statusTimer),this.statusTimer=null),this.statusMessage=""}setStatus(e,t){this.statusMessage=e,this.statusTone=t,this.statusTimer&&clearTimeout(this.statusTimer),this.statusTimer=setTimeout(()=>{this.statusMessage="",this.statusTimer=null},3e3)}static \u0275fac=function(t){return new(t||r)(u.rXU(_e),u.rXU(On),u.rXU(_n),u.rXU(qt.gRc))};static \u0275cmp=u.VBU({type:r,selectors:[["app-import-calculator"]],inputs:{importFunc:"importFunc"},decls:38,vars:13,consts:[[1,"form-group",3,"formGroup"],[1,"text-muted","mb-2"],["id","calcCode","rows","8","formControlName","calcCode",1,"form-control","mb-2","calc-textarea"],[1,"d-flex","align-items-end","gap-3","flex-wrap","mb-2"],["for","turnNumber",1,"form-label"],["id","turnNumber","type","number","min","1","formControlName","turn",1,"form-control"],["for","oddsSimulations",1,"form-label"],["id","oddsSimulations","type","number","min","1","formControlName","oddsSimulations",1,"form-control"],["for","positioningSide",1,"form-label"],["id","positioningSide","formControlName","positioningSide",1,"form-select"],["value","player"],["value","opponent"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-outline-primary",3,"click","disabled"],[1,"btn","btn-outline-success",3,"click","disabled"],["class","mb-2",4,"ngIf"],[1,"warning","mb-2"],["class","mb-2",3,"ngClass",4,"ngIf"],["class","odds-preview mb-3",4,"ngIf"],["class","text-danger mb-2",4,"ngIf"],[1,"mb-2"],[1,"d-flex","align-items-center","justify-content-between","mb-1"],[1,"small","text-muted"],["type","button",1,"btn","btn-sm","btn-outline-danger",3,"click"],[1,"progress"],["role","progressbar","aria-valuemin","0","aria-valuemax","100",1,"progress-bar","progress-bar-striped","progress-bar-animated"],[1,"mb-2",3,"ngClass"],[1,"odds-preview","mb-3"],[1,"odds-preview-header"],[1,"text-muted","small"],["alt","Replay odds preview",1,"odds-preview-image",3,"src"],[1,"odds-preview-actions","mt-2"],[1,"btn","btn-primary","me-2",3,"click"],[1,"btn","btn-outline-secondary",3,"click"],["alt","Replay positioning preview",1,"odds-preview-image",3,"src"],[1,"btn","btn-success","me-2",3,"click"],[1,"text-danger","mb-2"]],template:function(t,n){1&t&&(u.j41(0,"div",0)(1,"div",1),u.EFF(2," Paste calculator export code (compressed), replay export code, calculator JSON, or replay JSON. Replay inputs can include Actions, a single battle JSON, or a Pid lookup. "),u.k0s(),u.j41(3,"div",1),u.EFF(4," Example Pid: "),u.j41(5,"code"),u.EFF(6),u.k0s()(),u.nrm(7,"textarea",2),u.j41(8,"div",3)(9,"div")(10,"label",4),u.EFF(11,"Turn (1-based)"),u.k0s(),u.nrm(12,"input",5),u.k0s(),u.j41(13,"div")(14,"label",6),u.EFF(15,"Odds Simulations"),u.k0s(),u.nrm(16,"input",7),u.k0s(),u.j41(17,"div")(18,"label",8),u.EFF(19,"Positioning Side"),u.k0s(),u.j41(20,"select",9)(21,"option",10),u.EFF(22,"Player"),u.k0s(),u.j41(23,"option",11),u.EFF(24,"Opponent"),u.k0s()()(),u.j41(25,"button",12),u.bIt("click",function(){return n.submit()}),u.EFF(26),u.k0s(),u.j41(27,"button",13),u.bIt("click",function(){return n.buildOddsImage()}),u.EFF(28),u.k0s(),u.j41(29,"button",14),u.bIt("click",function(){return n.buildPositioningImage()}),u.EFF(30),u.k0s()(),u.DNE(31,$n,9,5,"div",15),u.j41(32,"div",16),u.EFF(33," Warning: This will overwrite any existing custom packs. Any custom packs in the import will be added. "),u.k0s(),u.DNE(34,Un,2,6,"div",17)(35,Gn,12,2,"div",18)(36,Wn,12,2,"div",18)(37,Vn,2,1,"div",19),u.k0s()),2&t&&(u.Y8G("formGroup",n.formGroup),u.R7$(6),u.JRh(n.pidExample),u.R7$(19),u.Y8G("disabled",n.loading),u.R7$(),u.SpI(" ",n.loading?"Fetching...":"Import"," "),u.R7$(),u.Y8G("disabled",n.oddsImageLoading),u.R7$(),u.SpI(" ",n.oddsImageLoading?"Building Preview...":"Build !odds Preview"," "),u.R7$(),u.Y8G("disabled",n.positioningImageLoading),u.R7$(),u.SpI(" ",n.positioningImageLoading?"Building Positioning...":"Build Positioning Image"," "),u.R7$(),u.Y8G("ngIf",n.positioningImageLoading),u.R7$(3),u.Y8G("ngIf",n.statusMessage),u.R7$(),u.Y8G("ngIf",n.oddsImagePreviewUrl),u.R7$(),u.Y8G("ngIf",n.positioningImagePreviewUrl),u.R7$(),u.Y8G("ngIf",n.errorMessage))},dependencies:[Ne.MD,Ne.YU,Ne.bT,j.X1,j.xH,j.y7,j.me,j.Q0,j.wz,j.BC,j.cb,j.VZ,j.j4,j.JD],styles:[".calc-textarea[_ngcontent-%COMP%]{min-height:180px;font-family:Courier New,Courier,monospace;white-space:pre;overflow-wrap:normal;overflow:auto;resize:vertical}.odds-preview[_ngcontent-%COMP%]{border:1px solid #d9d9d9;border-radius:8px;padding:10px;background:#fafafa}.odds-preview-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}.odds-preview-image[_ngcontent-%COMP%]{width:100%;max-height:520px;object-fit:contain;background:#fff;border:1px solid #ececec;border-radius:6px}"]})}return r})()}}]);